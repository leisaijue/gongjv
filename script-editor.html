<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>话术编辑器 - 工具中心</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // 身份验证检查
    const SESSION_KEY = 'toolcenter_auth';
    const REMEMBER_KEY = 'toolcenter_remember';
    
    function checkAuth() {
      const sessionAuth = sessionStorage.getItem(SESSION_KEY);
      const rememberAuth = localStorage.getItem(REMEMBER_KEY);
      
      if (sessionAuth === 'authenticated') return true;
      
      if (rememberAuth) {
        try {
          const authData = JSON.parse(rememberAuth);
          const expiryTime = new Date(authData.expiry);
          if (new Date() < expiryTime) {
            sessionStorage.setItem(SESSION_KEY, 'authenticated');
            return true;
          } else {
            localStorage.removeItem(REMEMBER_KEY);
          }
        } catch (e) {
          localStorage.removeItem(REMEMBER_KEY);
        }
      }
      return false;
    }
    
    if (!checkAuth()) {
      window.location.href = './login.html';
    }
  </script>
  <link rel="stylesheet" href="./css/script-editor.css">
</head>
<body>
  <nav class="navbar">
    <div class="wrap">
      <div class="brand">🛠️ 工具中心</div>
      <a class="navlink" href="./index.html">首页</a>
      <a class="navlink" href="./image-gallery.html">批量图片展示器</a>
      <a class="navlink" href="./customer-search.html">客户信息搜索</a>
      <a class="navlink" href="./customer-card.html">客户信息卡生成器</a>
      <a class="navlink active" href="./script-editor.html" aria-current="page">话术编辑器</a>
      <div class="spacer"></div>

    </div>
  </nav>

  <div class="main-container">
    <!-- 左侧数据面板 -->
    <div class="data-panel panel">
      <div class="panel-header">
        <h3>📊 数据源</h3>
        <div class="data-overview">
          <div class="stat"><span>文件:</span><span id="fileName">未上传</span></div>
          <div class="stat"><span>记录数:</span><span id="recordCount">0</span></div>
          <div class="stat"><span>字段数:</span><span id="fieldCount">0</span></div>
        </div>
        
        <!-- 字段搜索框 -->
        <div class="field-search-container" id="fieldSearchContainer" style="display: none; margin-top: 12px;">
          <input 
            type="text" 
            class="field-search-input" 
            id="fieldSearchInput" 
            placeholder="搜索字段..."
            style="width: 100%; padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: white;"
          >
        </div>
      </div>
      <div class="fields-list" id="fieldsList">
        <div class="file-drop-zone" id="fileDropZone">
          <div style="font-size: 24px; margin-bottom: 8px;">📁</div>
          <div style="font-weight: 500; margin-bottom: 4px;">拖拽文件到此处</div>
          <div style="font-size: 12px;">支持 CSV, TSV, XLSX 格式</div>
        </div>
      </div>
    </div>

    <!-- 中间编辑器面板 -->
    <div class="editor-panel panel">
      <div class="editor-toolbar">
        <input type="file" id="fileInput" accept=".csv,.tsv,.xlsx" style="display: none;">
        <button class="btn primary" id="uploadBtn">📁 上传数据</button>
        <button class="btn" id="loadSampleBtn">🎆 加载示例</button>
        <button class="btn" id="historyBtn">📋 历史话术记录</button>
        <button class="btn" id="addCalcFieldBtn">🧮 添加计算字段</button>
        <button class="btn danger" id="clearDataBtn" disabled>🗑️ 清空数据</button>
        <div style="flex: 1;"></div>
        <span class="status info" id="templateStatus">
          <span id="statusText">等待上传数据</span>
        </span>
      </div>
      <div class="editor-content">
        <div class="template-editor-container">
          <!-- 普通文本编辑器内容区域 -->
          <div class="simple-editor-content">
            <textarea 
              class="template-editor" 
              id="templateEditor" 
              placeholder="请输入话术模板...

点击左侧字段名称来插入字段变量。

字段变量格式：[[字段名称]]

示例：
尊敬的[[客户名称]]，您好！
您的GMV数据为：[[GMV]]
感谢您的支持！"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧预览面板 -->
    <div class="preview-panel panel">
      <div class="panel-header">
        <h3>👁️ 预览与生成</h3>
        
        <!-- 客户名称列选择器 -->
        <div class="name-column-selector" id="nameColumnSelector" style="display: none;">
          <label>客户名称列:</label>
          <select id="nameColumnSelect">
            <option value="">请选择客户名称列...</option>
          </select>
          <div style="font-size: 11px; color: var(--muted); margin-top: 2px;">指定用于客户搜索和显示的字段</div>
        </div>
        
        <div class="customer-search-dropdown">
          <input 
            type="text" 
            class="customer-search-input" 
            id="customerSearchInput" 
            placeholder="搜索并选择客户..."
            disabled
            autocomplete="off"
          >
          <span class="search-dropdown-icon">▼</span>
          <div class="customer-options" id="customerOptions">
            <div class="no-results">请先上传数据</div>
          </div>
        </div>
      </div>
      <div class="preview-content">
        <div class="preview-result" id="previewResult">
          <div class="preview-empty">请上传数据并编辑模板后查看预览</div>
        </div>
      </div>
      <div class="preview-actions">
        <button class="btn success" id="copyCurrentBtn" disabled>📋 复制当前话术</button>
        <button class="btn primary" id="batchExportBtn" disabled>📈 批量导出表格</button>
      </div>
    </div>
  </div>

  <!-- 历史话术记录模态框 -->
  <div class="modal" id="historyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">📋 历史话术记录</h3>
        <button class="modal-close" onclick="closeHistoryModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <label class="form-label">使用记录 (按时间排序)</label>
            <input type="text" id="historySearchInput" placeholder="搜索客户或话术内容..." 
                   style="width: 200px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px;">
          </div>
          <div id="historyList" style="max-height: 400px; overflow-y: auto;">
            <div style="text-align: center; color: var(--muted); padding: 20px;">暂无使用记录</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeHistoryModal()">关闭</button>
        <button class="btn danger" id="clearHistoryBtn">清空所有记录</button>
      </div>
    </div>
  </div>
  
  <!-- 字段计算器模态框 -->
  <div class="modal" id="calcFieldModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">🧮 添加计算字段</h3>
        <button class="modal-close" onclick="closeCalcFieldModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">字段名称</label>
          <input type="text" class="form-input" id="calcFieldNameInput" placeholder="例如：总金额">
        </div>
        
        <div class="form-group">
          <label class="form-label">计算公式</label>
          <div class="formula-editor-container">
            <textarea class="calc-textarea enhanced" id="calcFormulaInput" placeholder="请输入计算公式，支持以下功能：

📊 基础运算： +、-、*、/、()
🤔 条件判断：条件 ? 值1 : 值2
🔗 字符拼接： + 连接字符串
📊 数学函数：Math.round()、Math.max()等

示例公式：
1. 简单算术：[[GMV]] * 1.1
2. 条件计算：[[GMV]] > 1000 ? '高价值客户' : '普通客户'
3. 字符串拼接：[[客户名称]] + '-' + [[国际站ID]]
4. 数学函数：Math.round([[GMV]] / 100) * 100
5. 复杂逻辑：[[评定星等级]] >= 4 ? '⭐⭐⭐⭐ 优质' : [[评定星等级]] >= 2 ? '⭐⭐ 良好' : '⭐ 待提升'

注意：使用 [[字段名]] 引用字段，点击下方按钮可快速插入"></textarea>
          </div>
          
          <div class="field-selector-container">
            <label class="form-label">快速插入字段：</label>
            <div class="field-selector" id="calcFieldSelector">
              <div style="text-align: center; color: var(--muted); font-size: 11px; grid-column: 1 / -1;">请先上传数据文件</div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">预览结果</label>
          <div class="preview-box" id="calcPreview">
            <span style="color: var(--muted);">请输入公式查看预览...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeCalcFieldModal()">取消</button>
        <button class="btn primary" id="addCalcFieldConfirmBtn" disabled>添加字段</button>
      </div>
    </div>
  </div>
  
  <!-- 表格插入模态框 -->
  <div class="modal table-insert-modal" id="tableModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">📊 插入表格</h3>
        <button class="modal-close" onclick="closeTableModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">选择表格大小</label>
          <div class="table-size-selector" id="tableSizeSelector">
            <!-- 动态生成8x6的网格 -->
          </div>
          <div class="table-size-info" id="tableSizeInfo">
            点击选择表格大小：1 × 1
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">表格选项</label>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
              <input type="checkbox" id="tableHeaderCheck" checked>
              包含表头
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
              <input type="checkbox" id="tableBorderCheck" checked>
              显示边框
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeTableModal()">取消</button>
        <button class="btn primary" id="insertTableBtn">插入表格</button>
      </div>
    </div>
  </div>
  
  <!-- 图片插入模态框 -->
  <div class="modal" id="imageModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">🖼️ 插入图片</h3>
        <button class="modal-close" onclick="closeImageModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">选择插入方式</label>
          <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <label style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
              <input type="radio" name="imageMethod" value="upload" checked>
              上传图片文件
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
              <input type="radio" name="imageMethod" value="url">
              图片链接地址
            </label>
          </div>
        </div>
        
        <!-- 文件上传区域 -->
        <div class="form-group" id="imageUploadGroup">
          <label class="form-label">上传图片</label>
          <div class="image-upload-zone" id="imageUploadZone">
            <div style="font-size: 32px; margin-bottom: 8px;">📸</div>
            <div style="font-weight: 500; margin-bottom: 4px;">点击上传或拖拽图片文件</div>
            <div style="font-size: 12px;">支持 JPG、PNG、GIF、WebP 格式，最大 5MB</div>
          </div>
          <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
          <div id="imagePreviewContainer" style="display: none;">
            <img id="imagePreview" class="image-preview" alt="图片预览">
            <button class="btn" onclick="clearImagePreview()" style="margin-top: 8px;">重新选择</button>
          </div>
        </div>
        
        <!-- URL输入区域 -->
        <div class="form-group" id="imageUrlGroup" style="display: none;">
          <label class="form-label">图片链接地址</label>
          <input type="url" class="form-input" id="imageUrlInput" placeholder="https://example.com/image.jpg">
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
            请输入有效的图片链接地址
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">图片设置</label>
          <div style="display: flex; gap: 12px; align-items: center;">
            <label style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
              宽度: <input type="number" id="imageWidthInput" class="toolbar-input" style="width: 60px;" placeholder="auto" min="50" max="800">px
            </label>
            <label style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
              <input type="checkbox" id="imageAutoSizeCheck" checked>
              自动适应
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeImageModal()">取消</button>
        <button class="btn primary" id="insertImageBtn" disabled>插入图片</button>
      </div>
    </div>
  </div>
  
  <!-- 字段选择模态框 -->
  <div class="modal" id="fieldModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">📝 插入字段变量</h3>
        <button class="modal-close" onclick="closeFieldModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">可用字段</label>
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 12px;">
            点击字段名称插入到编辑器中，字段将显示为蓝色标签
          </div>
          <div id="fieldModalList" style="max-height: 300px; overflow-y: auto;">
            <div style="text-align: center; color: var(--muted); padding: 20px;">
              请先上传数据文件
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeFieldModal()">关闭</button>
      </div>
    </div>
  </div>
  
  <!-- 数据导入配置模态框 -->
  <div class="modal" id="importConfigModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">📁 数据导入配置</h3>
        <button class="modal-close" onclick="closeImportConfigModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">文件信息</label>
          <div class="file-info-display" id="fileInfoDisplay">
            <div id="importFileName" style="font-weight: 500;">-</div>
            <div id="importFileSize" style="font-size: 12px; color: var(--muted);">-</div>
            <div id="importFileType" style="font-size: 12px; color: var(--muted);">-</div>
          </div>
        </div>
        
        <div class="form-group" id="worksheetGroup" style="display: none;">
          <label class="form-label">工作表选择 (Excel文件)</label>
          <select class="form-select" id="worksheetSelect">
            <option value="0">第1个工作表</option>
          </select>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">选择要导入的工作表</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">字段行 (表头行)</label>
          <select class="form-select" id="headerRowSelect">
            <option value="1">第1行</option>
            <option value="2">第2行</option>
            <option value="3">第3行</option>
            <option value="4">第4行</option>
            <option value="5">第5行</option>
          </select>
          <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">选择哪一行作为字段名称</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">数据预览 (前8行)</label>
          <div class="data-preview" id="dataPreview">
            <div style="color: var(--muted); font-style: italic;">请选择文件...</div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">导入状态</label>
          <div class="import-status" id="importStatusContainer">
            <span class="status info" id="importStatusBadge">🔄 等待导入</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeImportConfigModal()">取消</button>
        <button class="btn primary" id="confirmImportBtn" disabled>确认导入</button>
      </div>
    </div>
  </div>
  

  
  <!-- 文件输入功能已移除 -->
  
  <!-- XLSX库 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <!-- 模块化JavaScript -->
  <script src="./js/rich-text-editor.js"></script>
  <script src="./js/data-import.js"></script>
  <script src="./js/template-render.js"></script>
  <script src="./js/script-editor-main.js"></script>
</body>
</html>
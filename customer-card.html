<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>客户信息卡生成器 - 工具中心</title>
  <script>
    // 身份验证检查
    const SESSION_KEY = 'toolcenter_auth';
    const REMEMBER_KEY = 'toolcenter_remember';
    
    function checkAuth() {
      const sessionAuth = sessionStorage.getItem(SESSION_KEY);
      const rememberAuth = localStorage.getItem(REMEMBER_KEY);
      
      if (sessionAuth === 'authenticated') {
        return true;
      }
      
      if (rememberAuth) {
        try {
          const authData = JSON.parse(rememberAuth);
          const expiryTime = new Date(authData.expiry);
          const now = new Date();
          
          if (now < expiryTime) {
            sessionStorage.setItem(SESSION_KEY, 'authenticated');
            return true;
          } else {
            localStorage.removeItem(REMEMBER_KEY);
          }
        } catch (e) {
          localStorage.removeItem(REMEMBER_KEY);
        }
      }
      
      return false;
    }
    
    // 页面加载时检查身份验证
    if (!checkAuth()) {
      window.location.href = './login.html';
    }
  </script>
  <style>
    :root {
      --panel: #ffffff; --border: #e5e7eb; --text: #111827; --muted: #6b7280; 
      --accent: #1b65ff; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      --star-gold: #fbbf24;
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font: 14px/1.45 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, 'PingFang SC','Hiragino Sans GB','Microsoft YaHei', sans-serif;
      color: var(--text);
      background: #f9fafb;
    }
    
    /* 导航栏 */
    .navbar {
      position: sticky; top: 0; z-index: 9999; background: var(--panel);
      border-bottom: 1px solid var(--border); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    .navbar .wrap { display: flex; align-items: center; gap: 10px; padding: 10px 16px; }
    .navbar .brand { font-weight: 700; color: var(--text); margin-right: 6px; }
    .navbar a, .navbar .navlink {
      display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px;
      border: 1px solid var(--border); border-radius: 10px; color: #374151;
      text-decoration: none; font-size: 14px; transition: all 0.2s ease;
    }
    .navbar a:hover, .navbar .navlink:hover { background: #f3f4f6; border-color: #d1d5db; transform: translateY(-1px); }
    .navbar a.active, .navbar .navlink.active { background: var(--accent); border-color: var(--accent); color: #ffffff; }
    
    /* 主容器 */
    .container { display: grid; grid-template-columns: 1fr 400px; height: calc(100vh - 60px); gap: 0; }
    .main-panel { display: flex; flex-direction: column; background: var(--panel); border-right: 1px solid var(--border); }
    
    /* 工具栏 */
    .toolbar {
      padding: 16px; background: var(--panel); border-bottom: 1px solid var(--border);
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
    }
    .btn {
      appearance: none; border: 1px solid var(--border); background: var(--panel);
      color: var(--text); padding: 8px 16px; border-radius: 8px; cursor: pointer;
      transition: all 0.2s; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:hover { background: #f3f4f6; border-color: #d1d5db; }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
    .btn.success { background: var(--success); border-color: var(--success); color: white; }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: white; }
    
    /* 搜索和过滤 */
    .filters {
      padding: 12px 16px; background: #f8fafc; border-bottom: 1px solid var(--border);
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
    }
    .search-input, .filter-select {
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
      outline: none; font-size: 14px;
    }
    .search-input { min-width: 200px; flex: 1; max-width: 300px; }
    
    /* 数据表格 */
    .table-container { flex: 1; overflow: auto; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th {
      position: sticky; top: 0; background: #f8fafc; border-bottom: 1px solid var(--border);
      padding: 12px 8px; text-align: left; font-weight: 600; font-size: 12px;
      color: var(--muted); cursor: pointer;
    }
    .data-table th:hover { background: #f1f5f9; }
    .data-table td { border-bottom: 1px solid #f1f5f9; padding: 12px 8px; }
    .data-table tr { cursor: pointer; transition: background-color 0.15s; }
    .data-table tr:hover { background: #f8fafc; }
    .data-table tr.selected { background: #dbeafe; }
    
    /* 星级显示优化 */
    .star-rating { display: inline-flex; align-items: center; gap: 2px; }
    .star { color: #d1d5db; font-size: 16px; transition: all 0.2s; }
    .star.filled { color: var(--star-gold); text-shadow: 0 0 3px rgba(251, 191, 36, 0.3); }
    .star.predicted { color: var(--star-gold); opacity: 0.6; animation: pulse 2s infinite; }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    
    /* 升降指示优化 */
    .trend { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 500; padding: 2px 6px; border-radius: 12px; }
    .trend.up { color: var(--success); background: rgba(16, 185, 129, 0.1); }
    .trend.down { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
    .trend.same { color: var(--muted); background: rgba(107, 114, 128, 0.1); }
    
    /* GMV显示优化 */
    .gmv-display {
      font-size: 16px;
      font-weight: 700;
      background: linear-gradient(135deg, #10b981, #059669);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .gmv-display.large {
      font-size: 22px;
    }
    
    /* 动态信息卡样式增强 */
    .customer-stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    
    .field-count, .resource-count {
      background: #f3f4f6;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    /* 字段值类型样式 */
    .currency-value {
      font-weight: 700;
      color: var(--success);
    }
    
    .rating-value {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    
    .percentage-value {
      color: var(--accent);
      font-weight: 600;
    }
    
    .number-value {
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }
    
    .boolean-value {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .boolean-value:contains('是') {
      background: #dcfce7;
      color: #166534;
    }
    
    .boolean-value:contains('否') {
      background: #fef2f2;
      color: #991b1b;
    }
    
    .metric-row.highlight {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 4px 0;
    }
    
    /* 分类区块样式 */
    .basic-section {
      border-left: 4px solid #3b82f6;
    }
    
    .financial-section {
      border-left: 4px solid #10b981;
    }
    
    .rating-section {
      border-left: 4px solid #f59e0b;
    }
    
    .target-section {
      border-left: 4px solid #ef4444;
    }
    
    .team-section {
      border-left: 4px solid #8b5cf6;
    }
    
    .industry-section {
      border-left: 4px solid #06b6d4;
    }
    
    .time-section {
      border-left: 4px solid #84cc16;
    }
    
    .general-section {
      border-left: 4px solid #6b7280;
    }
    
    /* 资源标签美化 */
    .resource-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 1px solid #f59e0b;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      color: #92400e;
      margin: 2px;
      transition: all 0.2s;
    }
    
    .resource-tag:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }
    
    .resource-tag .icon {
      font-size: 10px;
    }
    
    /* 不同类型资源的颜色主题 */
    .resource-tag.promotion {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      border-color: #3b82f6;
      color: #1e40af;
    }
    
    .resource-tag.content {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border-color: #10b981;
      color: #059669;
    }
    
    .resource-tag.support {
      background: linear-gradient(135deg, #fce7f3, #fbcfe8);
      border-color: #ec4899;
      color: #be185d;
    }
    
    /* 表格样式增强 */
    .customer-name-cell {
      min-width: 200px;
    }
    
    .customer-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .customer-preview {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.3;
    }
    
    .id-cell {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--accent);
    }
    
    .count-cell {
      text-align: center;
    }
    
    .field-badge, .resource-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .field-badge {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .resource-badge {
      background: #fef3c7;
      color: #92400e;
    }
    
    .action-cell {
      text-align: center;
    }
    
    .btn-view {
      padding: 4px 8px;
      font-size: 11px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-view:hover {
      background: #1854d1;
      transform: translateY(-1px);
    }
    
    /* 工具提示 */
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    
    .tooltip:hover::after {
      opacity: 1;
    }
    
    /* 右侧信息卡 */
    .info-card {
      background: var(--panel); display: flex; flex-direction: column;
      height: 100%; overflow: hidden;
    }
    .card-header {
      padding: 20px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .card-title { font-size: 18px; font-weight: 600; color: var(--text); margin: 0; }
    .card-subtitle { font-size: 14px; color: var(--muted); margin: 4px 0 0 0; }
    .card-content { padding: 20px; flex: 1; overflow-y: auto; }
    .info-section { margin-bottom: 24px; }
    .info-section h4 { margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--text); }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .info-item {
      background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center;
    }
    .info-item .label { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .info-item .value { font-size: 18px; font-weight: 600; color: var(--text); }
    .resources-list { list-style: none; margin: 0; padding: 0; }
    .resources-list li {
      padding: 8px 12px; background: #f8fafc; border-radius: 6px;
      margin-bottom: 6px; font-size: 13px; color: var(--text);
      position: relative; transition: all 0.2s;
    }
    
    .resources-list li:hover {
      background: #f1f5f9;
      transform: translateX(4px);
    }
    
    .resources-list li::before {
      content: '🎁';
      margin-right: 8px;
      font-size: 12px;
    }
    
    .resources-list li.empty {
      color: var(--muted);
      font-style: italic;
    }
    
    .resources-list li.empty::before {
      content: '💭';
    }
    .card-actions {
      padding: 20px; border-top: 1px solid var(--border);
      display: flex; gap: 12px;
    }
    
    /* 空状态 */
    .empty-state {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 100%; text-align: center; color: var(--muted);
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    
    /* 隐藏的文件输入 */
    .file-input { position: absolute; opacity: 0; pointer-events: none; }
    
    /* 状态指示 */
    .status { font-size: 12px; padding: 2px 8px; border-radius: 12px; font-weight: 500; }
    .status.success { background: #dcfce7; color: #166534; }
    .status.warning { background: #fef3c7; color: #92400e; }
    .status.error { background: #fee2e2; color: #dc2626; }
    
    /* 响应式设计 */
    @media (max-width: 1024px) {
      .container { grid-template-columns: 1fr; }
      .info-card {
        position: fixed; top: 60px; right: 0; width: 400px; height: calc(100vh - 60px);
        transform: translateX(100%); transition: transform 0.3s ease; z-index: 1000;
        box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
      }
      .info-card.open { transform: translateX(0); }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="wrap">
      <div class="brand">🛠️ 工具中心</div>
      <a class="navlink" href="./index.html">首页</a>
      <a class="navlink" href="./image-gallery.html">批量图片展示器</a>
      <a class="navlink" href="./customer-search.html">客户信息搜索</a>
      <a class="navlink active" href="./customer-card.html" aria-current="page">客户信息卡生成器</a>
      <a class="navlink" href="./script-editor.html">话术编辑器</a>
      <div style="flex: 1;"></div>
    </div>
  </nav>

  <div class="container">
    <!-- 左侧主区域 -->
    <div class="main-panel">
      <!-- 工具栏 -->
      <div class="toolbar">
        <button class="btn primary" id="importBtn">📁 导入文件 (XLSX/CSV/TSV)</button>
        <button class="btn" id="downloadTemplateBtn">📋 下载模板</button>
        <button class="btn danger" id="clearBtn" style="display: none;">🗑️ 清空数据</button>
        
        <div style="flex: 1;"></div>
        
        <div class="currency-display" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: #f8fafc; font-size: 12px; color: var(--muted);">
          💰 货币单位：美元 (USD)
        </div>
        
        <span class="status" id="dataStatus">
          <span id="statusText">未导入数据</span>
        </span>
      </div>
      
      <!-- 搜索和过滤 -->
      <div class="filters">
        <input type="text" class="search-input" id="searchInput" placeholder="搜索客户名称或店铺ID...">
        
        <select class="filter-select" id="starFilter">
          <option value="">所有星级</option>
          <option value="0">0星</option><option value="1">1星</option><option value="2">2星</option>
          <option value="3">3星</option><option value="4">4星</option><option value="5">5星</option>
        </select>
        
        <select class="filter-select" id="trendFilter">
          <option value="">升降趋势</option>
          <option value="up">预测上升</option><option value="down">预测下降</option><option value="same">保持不变</option>
        </select>
        
        <span style="color: var(--muted); font-size: 12px;">
          已筛选：<b id="filteredCount">0</b> / 总数：<b id="totalCount">0</b>
        </span>
      </div>
      
      <!-- 数据表格 -->
      <div class="table-container">
        <div class="empty-state" id="emptyState">
          <div class="icon">📊</div>
          <h3>暂无客户数据</h3>
          <p>请导入 XLSX、CSV 或 TSV 文件开始使用</p>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn primary" onclick="document.getElementById('importBtn').click()">
              📁 立即导入
            </button>
            <button class="btn" id="loadSampleBtn">
              🎆 加载演示数据
            </button>
          </div>
        </div>
        
        <table class="data-table" id="dataTable" style="display: none;">
          <thead>
            <tr>
              <th data-sort="customer_name">客户名称</th>
              <th data-sort="shop_id">国际站ID</th>
              <th data-sort="star_current">评定星等级</th>
              <th data-sort="star_predicted">预测星等级</th>
              <th data-sort="gmv_month">本月实收GMV</th>
              <th>升降趋势</th>
              <th class="resource-col">权益资源</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- 右侧信息卡 -->
    <div class="info-card" id="infoCard">
      <div class="empty-state">
        <div class="icon">👤</div>
        <h3>选择客户查看详情</h3>
        <p>点击表格中的任意客户行查看详细信息卡</p>
      </div>
      
      <!-- 客户详情内容 -->
      <div id="cardContent" style="display: none;">
        <div class="card-header">
          <div>
            <h2 class="card-title" id="cardCustomerName">客户名称</h2>
            <p class="card-subtitle" id="cardShopId">国际站ID: -</p>
          </div>
          <button class="btn" onclick="closeInfoCard()">✕</button>
        </div>
        
        <div class="card-content">
          <div class="info-section">
            <h4>星级评估</h4>
            <div class="info-grid">
              <div class="info-item">
                <div class="label">评定星等级</div>
                <div class="value" id="cardCurrentStar">-</div>
              </div>
              <div class="info-item">
                <div class="label">预测星等级</div>
                <div class="value" id="cardPredictedStar">-</div>
              </div>
            </div>
            <div style="margin-top: 12px; text-align: center;">
              <span id="cardTrend" class="trend">→ 无变化</span>
            </div>
          </div>
          
          <div class="info-section">
            <h4>业务数据</h4>
            <div class="info-item highlight">
              <div class="label">本月实收GMV</div>
              <div class="value gmv-display large" id="cardGmv">-</div>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: var(--muted); text-align: center;">
              <span id="gmvTrend">较上月趋势待分析</span>
            </div>
          </div>
          
          <div class="info-section">
            <h4>权益资源 <span style="font-size: 12px; color: var(--muted); font-weight: normal;" id="resourceCount">(0项)</span></h4>
            <ul class="resources-list" id="cardResources">
              <li class="empty">暂无权益资源信息</li>
            </ul>
          </div>
        </div>
        
        <div class="card-actions">
          <button class="btn primary" id="copyImageBtn">📷 复制为图片</button>
          <button class="btn" id="copyTextBtn">📝 复制为文本</button>
          <button class="btn" id="downloadPngBtn">💾 下载PNG</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 隐藏的文件输入已删除 -->
  
  <!-- 依赖脚本 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <!-- 主功能脚本 -->
  <script>
    // 应用状态
    const appState = {
      customers: [],
      filteredCustomers: [],
      selectedCustomer: null,
      currency: 'USD', // 默认使用美元
      sortBy: 'gmv_month',
      sortOrder: 'desc'
    };
    
    // DOM 元素快速访问
    const $ = id => document.getElementById(id);
    
    // 初始化应用
    function initApp() {
      console.log('开始初始化应用...');
      
      // 检查关键 DOM 元素
      const importBtn = $('importBtn');
      const downloadTemplateBtn = $('downloadTemplateBtn');
      // const fileInput = $('fileInput'); // 文件输入已删除
      
      console.log('DOM 元素检查:');
      console.log('- importBtn:', importBtn);
      console.log('- downloadTemplateBtn:', downloadTemplateBtn);
      // console.log('- fileInput:', fileInput); // 文件输入已删除
      
      if (!importBtn || !downloadTemplateBtn) {
        console.error('关键 DOM 元素缺失！');
        return;
      }
      
      bindEvents();
      updateUI();
      
      console.log('应用初始化完成');
    }
    
    // 绑定事件
    function bindEvents() {
      // 检查元素是否存在，如果不存在则输出警告
      const importBtn = $('importBtn');
      // const fileInput = $('fileInput'); // 文件输入已删除
      const downloadTemplateBtn = $('downloadTemplateBtn');
      const clearBtn = $('clearBtn');
      const searchInput = $('searchInput');
      const starFilter = $('starFilter');
      const trendFilter = $('trendFilter');
      const copyImageBtn = $('copyImageBtn');
      const copyTextBtn = $('copyTextBtn');
      const downloadPngBtn = $('downloadPngBtn');
      
      if (!importBtn) {
        console.error('importBtn element not found');
        return;
      }
      // fileInput 检查已删除，因为元素已被移除
      if (!downloadTemplateBtn) {
        console.error('downloadTemplateBtn element not found');
        return;
      }
      
      // 绑定导入相关事件 - fileInput相关功能已删除
      // importBtn.addEventListener('click', function(e) {
      //   e.preventDefault();
      //   console.log('Import button clicked');
      //   fileInput.click();
      // });
      // 
      // fileInput.addEventListener('change', handleFileImport);
      
      // 绑定下载模板事件
      downloadTemplateBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Download template button clicked');
        downloadTemplate();
      });
      
      // 其他事件绑定
      if (clearBtn) clearBtn.addEventListener('click', clearData);
      if (searchInput) searchInput.addEventListener('input', handleFilter);
      if (starFilter) starFilter.addEventListener('change', handleFilter);
      if (trendFilter) trendFilter.addEventListener('change', handleFilter);
      if (copyImageBtn) copyImageBtn.addEventListener('click', copyAsImage);
      if (copyTextBtn) copyTextBtn.addEventListener('click', copyAsText);
      if (downloadPngBtn) downloadPngBtn.addEventListener('click', downloadPNG);
      
      // 加载演示数据按钮
      const loadSampleBtn = $('loadSampleBtn');
      if (loadSampleBtn) {
        loadSampleBtn.addEventListener('click', loadSampleData);
      }
      
      // 表格排序事件
      document.querySelectorAll('[data-sort]').forEach(th => {
        th.addEventListener('click', () => handleSort(th.dataset.sort));
      });
      
      console.log('All events bound successfully');
    }
    
    // 文件导入处理
    async function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      try {
        updateStatus('正在导入...', 'warning');
        
        const data = await parseFile(file);
        const processed = processCustomerData(data);
        
        appState.customers = processed.valid;
        appState.filteredCustomers = [...appState.customers];
        
        updateStatus(`成功导入 ${processed.valid.length} 条客户数据`, 'success');
        if (processed.errors.length > 0) {
          console.warn('导入警告:', processed.errors);
        }
        
        updateUI();
        
      } catch (error) {
        updateStatus('导入失败: ' + error.message, 'error');
        console.error('Import error:', error);
      }
      
      // 清空文件输入
      event.target.value = '';
    }
    
    // 解析文件
    async function parseFile(file) {
      const fileName = file.name.toLowerCase();
      
      if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        return parseExcelFile(file);
      } else if (fileName.endsWith('.csv') || fileName.endsWith('.tsv') || fileName.endsWith('.txt')) {
        return parseTextFile(file);
      } else {
        throw new Error('不支持的文件格式，请使用 XLSX、CSV 或 TSV 文件');
      }
    }
    
    // 解析 Excel 文件
    async function parseExcelFile(file) {
      if (typeof XLSX === 'undefined') {
        throw new Error('XLSX 库未加载，请刷新页面重试');
      }
      
      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      
      return XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    }
    
    // 解析文本文件
    async function parseTextFile(file) {
      const text = await file.text();
      const lines = text.replace(/^\uFEFF/, '').trim().split(/\r?\n/);
      
      // 检测分隔符
      const firstLine = lines[0] || '';
      const delimiter = firstLine.includes('\t') ? '\t' : ',';
      
      return lines.map(line => {
        // 简单的 CSV 解析（处理引号）
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === delimiter && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      });
    }
    
    // 处理客户数据
    function processCustomerData(rawData) {
      if (!rawData || rawData.length < 2) {
        throw new Error('文件内容为空或格式不正确');
      }
      
      const headers = rawData[0].map(h => String(h).trim().toLowerCase());
      const rows = rawData.slice(1).filter(row => row.some(cell => String(cell).trim()));
      
      console.log('检测到的字段名称:', rawData[0]);
      console.log('处理后的字段名称:', headers);
      
      // 字段映射
      const fieldMap = mapFields(headers);
      console.log('字段映射结果:', fieldMap);
      
      // 存储字段映射信息到全局状态
      if (!window.appState) window.appState = {};
      window.appState.fieldMap = fieldMap;
      window.appState.headers = rawData[0];
      
      const valid = [];
      const errors = [];
      
      rows.forEach((row, index) => {
        try {
          const customer = processCustomerRow(row, fieldMap, index + 2);
          if (customer) {
            valid.push(customer);
          }
        } catch (error) {
          errors.push({
            row: index + 2,
            error: error.message,
            data: row
          });
        }
      });
      
      // 显示字段映射信息
      const mappedFields = Object.keys(fieldMap).filter(key => key !== 'resources').map(key => {
        return `${key}: ${rawData[0][fieldMap[key]] || '未找到'}`;
      }).join(', ');
      
      const resourceFields = fieldMap.resources.map(index => rawData[0][index]).join(', ');
      
      console.log(`映射的字段: ${mappedFields}`);
      if (resourceFields) {
        console.log(`资源字段: ${resourceFields}`);
      }
      
      return { valid, errors, total: rows.length, fieldMapping: { mapped: mappedFields, resources: resourceFields } };
    }
    
    // 动态字段映射 - 自动识别所有字段，不限制特定字段
    function mapFields(headers) {
      console.log('开始动态字段映射，表头:', headers);
      
      const map = {
        allFields: [],  // 存储所有字段信息
        keyFields: {},  // 存储关键字段的索引
        resources: []   // 存储资源相关字段
      };
      
      // 定义关键字段的识别模式（用于特殊处理）
      const keyPatterns = {
        customer_name: ['客户名称', 'customer_name', '客户', '名称', 'name', '公司名称', '商户名称', 'company'],
        shop_id: ['国际站id', '国际站ID', 'shop_id', 'shopid', '店铺id', '店铺ID', 'id', 'merchant_id', '编号'],
        star_current: ['评定星等级', '目前星等级', 'star_current', '当前星级', '星级', '等级'],
        star_predicted: ['预测星等级', 'star_predicted', '预测星级', '预测'],
        gmv_month: ['本月实收gmv', '本月实收GMV', 'gmv_month', 'gmv', '交易额', '销售额', '营业额']
      };
      
      // 遍历所有表头，创建字段映射
      headers.forEach((header, index) => {
        const fieldInfo = {
          index: index,
          name: header,
          displayName: header,
          type: 'text',  // 默认类型
          isKey: false,
          category: 'general'
        };
        
        const headerLower = header.toLowerCase();
        
        // 检查是否为关键字段
        for (const [keyField, patterns] of Object.entries(keyPatterns)) {
          if (patterns.some(pattern => 
            headerLower.includes(pattern.toLowerCase()) || 
            pattern.toLowerCase().includes(headerLower)
          )) {
            map.keyFields[keyField] = index;
            fieldInfo.isKey = true;
            fieldInfo.keyType = keyField;
            console.log(`识别关键字段: ${keyField} -> ${header} (索引: ${index})`);
            break;
          }
        }
        
        // 智能分类字段
        fieldInfo.category = categorizeField(header);
        fieldInfo.type = detectFieldType(header);
        
        // 检查是否为资源字段
        if (isResourceField(header)) {
          map.resources.push(index);
          fieldInfo.category = 'resource';
        }
        
        map.allFields.push(fieldInfo);
      });
      
      // 智能回退：如果没有找到关键字段，使用最佳猜测
      if (!map.keyFields.customer_name) {
        const nameField = findBestMatch(headers, ['名称', '客户', '公司', 'name', 'company']);
        if (nameField !== -1) {
          map.keyFields.customer_name = nameField;
          map.allFields[nameField].isKey = true;
          map.allFields[nameField].keyType = 'customer_name';
          console.log(`智能匹配客户名称字段: ${headers[nameField]}`);
        }
      }
      
      if (!map.keyFields.shop_id) {
        const idField = findBestMatch(headers, ['id', 'ID', '编号', 'code']);
        if (idField !== -1) {
          map.keyFields.shop_id = idField;
          map.allFields[idField].isKey = true;
          map.allFields[idField].keyType = 'shop_id';
          console.log(`智能匹配ID字段: ${headers[idField]}`);
        } else {
          // 使用第一列作为ID
          map.keyFields.shop_id = 0;
          map.allFields[0].isKey = true;
          map.allFields[0].keyType = 'shop_id';
          console.log(`使用第一列作为ID: ${headers[0]}`);
        }
      }
      
      console.log('动态字段映射完成:', map);
      console.log(`共识别 ${headers.length} 个字段，其中 ${Object.keys(map.keyFields).length} 个关键字段，${map.resources.length} 个资源字段`);
      
      return map;
    }
    
    // 智能分类字段
    function categorizeField(fieldName) {
      const name = fieldName.toLowerCase();
      
      if (name.includes('gmv') || name.includes('销售') || name.includes('营业') || name.includes('交易') || name.includes('收入')) {
        return 'financial';
      }
      if (name.includes('星') || name.includes('等级') || name.includes('级别') || name.includes('评') || name.includes('level')) {
        return 'rating';
      }
      if (name.includes('目标') || name.includes('完成') || name.includes('进度') || name.includes('对赌') || name.includes('target')) {
        return 'target';
      }
      if (name.includes('客服') || name.includes('销售') || name.includes('经理') || name.includes('拍档') || name.includes('服务')) {
        return 'team';
      }
      if (name.includes('行业') || name.includes('分类') || name.includes('类目') || name.includes('industry')) {
        return 'industry';
      }
      if (name.includes('时间') || name.includes('日期') || name.includes('年') || name.includes('月') || name.includes('date')) {
        return 'time';
      }
      return 'general';
    }
    
    // 检测字段类型
    function detectFieldType(fieldName) {
      const name = fieldName.toLowerCase();
      
      if (name.includes('gmv') || name.includes('金额') || name.includes('价格') || name.includes('费用')) {
        return 'currency';
      }
      if (name.includes('星') || name.includes('等级') || name.includes('分') || name.includes('评分')) {
        return 'rating';
      }
      if (name.includes('率') || name.includes('percent') || name.includes('%')) {
        return 'percentage';
      }
      if (name.includes('数量') || name.includes('个数') || name.includes('count')) {
        return 'number';
      }
      if (name.includes('是否') || name.includes('bool')) {
        return 'boolean';
      }
      return 'text';
    }
    
    // 检查是否为资源字段
    function isResourceField(fieldName) {
      const name = fieldName.toLowerCase();
      const resourceKeywords = [
        '资源', '权益', '计划', '预测', '摘星', '倍增', '俱乐部', '复购',
        '挑战', '对赌', '签约', '钻享', 'tad', '白名单', '积分', 'hotpicks',
        '榜单', '工厂榜', '优品榜', 'acp', '门槛', '排名'
      ];
      
      return resourceKeywords.some(keyword => name.includes(keyword)) ||
             (name.includes('是否') && resourceKeywords.some(keyword => name.includes(keyword)));
    }
    
    // 找到最佳匹配字段
    function findBestMatch(headers, keywords) {
      for (const keyword of keywords) {
        const index = headers.findIndex(h => 
          h.toLowerCase().includes(keyword.toLowerCase())
        );
        if (index !== -1) return index;
      }
      return -1;
    }
    
    // 查找字段索引 - 修复字段识别问题
    function findFieldIndex(headers, aliases) {
      for (const alias of aliases) {
        const index = headers.findIndex(h => {
          const headerLower = h.toLowerCase();
          const aliasLower = alias.toLowerCase();
          return headerLower.includes(aliasLower) || aliasLower.includes(headerLower);
        });
        if (index !== -1) {
          console.log(`找到字段匹配: "${headers[index]}" 匹配到 "${alias}" (索引: ${index})`);
          return index;
        }
      }
      return -1;
    }
    
    // 动态处理客户数据 - 处理所有字段，不限制特定结构
    function processCustomerRow(row, fieldMap, rowNumber) {
      console.log(`处理第 ${rowNumber + 1} 行数据`);
      const customer = {
        allData: {},  // 存储所有原始数据
        displayData: {},  // 存储格式化后的显示数据
        resources: []  // 资源数据
      };
      
      // 处理所有字段数据
      fieldMap.allFields.forEach((fieldInfo, index) => {
        const rawValue = row[fieldInfo.index];
        const fieldName = fieldInfo.name;
        
        // 存储原始数据
        customer.allData[fieldName] = rawValue;
        
        // 根据字段类型格式化数据
        customer.displayData[fieldName] = formatFieldValue(rawValue, fieldInfo.type);
        
        // 处理关键字段
        if (fieldInfo.isKey) {
          customer[fieldInfo.keyType] = String(rawValue || '').trim();
        }
      });
      
      // 处理资源字段
      fieldMap.resources.forEach(resourceIndex => {
        const fieldInfo = fieldMap.allFields.find(f => f.index === resourceIndex);
        const resourceValue = String(row[resourceIndex] || '').trim();
        
        if (resourceValue && resourceValue !== '0' && 
            resourceValue.toLowerCase() !== 'false' && 
            resourceValue !== '-' && resourceValue !== '无') {
          customer.resources.push({
            name: fieldInfo.name,
            value: resourceValue,
            displayValue: formatFieldValue(resourceValue, fieldInfo.type)
          });
        }
      });
      
      // 确保必要的字段
      if (!customer.customer_name) {
        const firstNameField = fieldMap.allFields.find(f => 
          f.name.toLowerCase().includes('名称') || 
          f.name.toLowerCase().includes('name')
        );
        if (firstNameField) {
          customer.customer_name = String(row[firstNameField.index] || `客户${rowNumber + 1}`).trim();
        } else {
          customer.customer_name = `客户${rowNumber + 1}`;
        }
      }
      
      if (!customer.shop_id) {
        customer.shop_id = `customer_${rowNumber + 1}`;
      }
      
      // 生成唯一ID
      customer.id = `${customer.customer_name}_${customer.shop_id}_${Date.now()}_${rowNumber}`;
      
      // 保持向后兼容，设置一些默认值
      customer.star_current = parseStarRating(customer.star_current);
      customer.star_predicted = parseStarRating(customer.star_predicted);
      customer.trend = calculateTrend(customer.star_current, customer.star_predicted);
      
      console.log(`客户 "${customer.customer_name}" 数据处理完成，共 ${Object.keys(customer.allData).length} 个字段，${customer.resources.length} 个资源`);
      
      return customer;
    }
    
    // 格式化字段值
    function formatFieldValue(value, type) {
      if (value === null || value === undefined || value === '') {
        return '';
      }
      
      const strValue = String(value).trim();
      
      switch (type) {
        case 'currency':
          const numValue = parseFloat(strValue.replace(/[^0-9.-]/g, ''));
          return isNaN(numValue) ? strValue : formatCurrency(numValue);
          
        case 'rating':
          const rating = parseInt(strValue);
          return isNaN(rating) ? strValue : `${rating}星`;
          
        case 'percentage':
          if (strValue.includes('%')) return strValue;
          const percent = parseFloat(strValue);
          return isNaN(percent) ? strValue : `${percent}%`;
          
        case 'number':
          const num = parseFloat(strValue);
          return isNaN(num) ? strValue : num.toLocaleString();
          
        case 'boolean':
          if (strValue === '1' || strValue.toLowerCase() === 'true' || strValue === '是') return '是';
          if (strValue === '0' || strValue.toLowerCase() === 'false' || strValue === '否') return '否';
          return strValue;
          
        default:
          return strValue;
      }
    }
    
    // 解析星级
    function parseStarRating(value) {
      if (value === undefined || value === null || value === '') return 0;
      const num = parseInt(value);
      return isNaN(num) ? 0 : Math.max(0, Math.min(5, num));
    }
    
    // 解析 GMV
    function parseGMV(value) {
      if (value === undefined || value === null || value === '') return 0;
      
      const str = String(value).replace(/[¥$,\s]/g, '');
      const num = parseFloat(str);
      return isNaN(num) ? 0 : num;
    }
    
    // 计算趋势
    function calculateTrend(current, predicted) {
      if (predicted > current) return 'up';
      if (predicted < current) return 'down';
      return 'same';
    }
    
    // 更新状态显示
    function updateStatus(text, type = 'success') {
      $('statusText').textContent = text;
      $('dataStatus').className = `status ${type}`;
    }
    
    // 更新 UI
    function updateUI() {
      updateTable();
      updateEmptyState();
      updateClearButton();
      updateCounts();
    }
    
    // 更新表格 - 动态显示所有字段
    function updateTable() {
      if (appState.filteredCustomers.length === 0) {
        $('dataTable').style.display = 'none';
        return;
      }
      
      $('dataTable').style.display = 'table';
      $('emptyState').style.display = 'none';
      
      // 更新表头
      updateTableHeader();
      
      // 更新表体
      const tbody = $('tableBody');
      tbody.innerHTML = '';
      
      appState.filteredCustomers.forEach((customer, index) => {
        const tr = document.createElement('tr');
        tr.addEventListener('click', () => showCustomerCard(customer));
        
        // 基本信息列
        tr.innerHTML = generateTableRowHTML(customer);
        
        tbody.appendChild(tr);
      });
    }
    
    // 更新表头
    function updateTableHeader() {
      const thead = $('tableHead');
      if (!thead) {
        // 如果没有表头元素，创建一个
        const table = $('dataTable');
        const newThead = document.createElement('thead');
        newThead.id = 'tableHead';
        table.insertBefore(newThead, table.firstChild);
      }
      
      const headerRow = document.createElement('tr');
      
      // 基本列
      headerRow.innerHTML = `
        <th>客户名称</th>
        <th>ID</th>
        <th>字段数</th>
        <th>资源数</th>
        <th>操作</th>
      `;
      
      $('tableHead').innerHTML = '';
      $('tableHead').appendChild(headerRow);
    }
    
    // 生成表格行 HTML
    function generateTableRowHTML(customer) {
      const fieldCount = Object.keys(customer.allData || {}).length;
      const resourceCount = (customer.resources || []).length;
      
      return `
        <td class="customer-name-cell">
          <div class="customer-name">${customer.customer_name || '未知客户'}</div>
          <div class="customer-preview">${getCustomerPreview(customer)}</div>
        </td>
        <td class="id-cell">${customer.shop_id || 'N/A'}</td>
        <td class="count-cell">
          <span class="field-badge">${fieldCount} 字段</span>
        </td>
        <td class="count-cell">
          <span class="resource-badge">${resourceCount} 资源</span>
        </td>
        <td class="action-cell">
          <button class="btn-view" onclick="event.stopPropagation(); showCustomerCard(arguments[0])" data-customer='${JSON.stringify(customer).replace(/'/g, "&apos;")}'>查看详情</button>
        </td>
      `;
    }
    
    // 获取客户预览信息
    function getCustomerPreview(customer) {
      const allData = customer.allData || {};
      const previewFields = [];
      
      // 优先显示重要字段
      const importantKeywords = ['gmv', '销售', '营业', '星', '等级', '目标'];
      
      Object.entries(allData).forEach(([key, value]) => {
        if (value && value !== '' && value !== '-' && previewFields.length < 3) {
          const isImportant = importantKeywords.some(keyword => 
            key.toLowerCase().includes(keyword)
          );
          if (isImportant) {
            previewFields.unshift(`${key}: ${value}`);
          } else if (previewFields.length < 2) {
            previewFields.push(`${key}: ${value}`);
          }
        }
      });
      
      return previewFields.slice(0, 2).join(' | ') || '无预览信息';
    }
    
    // 渲染星级
    function renderStars(count, predicted = false) {
      let html = '';
      for (let i = 1; i <= 5; i++) {
        if (i <= count) {
          html += predicted ? 
            '<span class="star predicted">★</span>' : 
            '<span class="star filled">★</span>';
        } else {
          html += '<span class="star">☆</span>';
        }
      }
      return html;
    }
    
    // 渲染资源标签（优化显示）
    function renderResourceTags(resources) {
      if (!resources || resources.length === 0) return '暂无资源';
      
      return resources.slice(0, 2).map(resource => {
        const type = getResourceType(resource);
        return `<span class="resource-tag ${type}">${resource}</span>`;
      }).join(' ') + (resources.length > 2 ? ` +${resources.length - 2}` : '');
    }
    
    // 判断资源类型
    function getResourceType(resource) {
      const str = resource.toLowerCase();
      if (str.includes('推荐') || str.includes('焦点') || str.includes('首页') || str.includes('促销') || str.includes('活动')) {
        return 'promotion';
      } else if (str.includes('直播') || str.includes('内容') || str.includes('发布') || str.includes('种草') || str.includes('营销')) {
        return 'content';
      } else if (str.includes('支持') || str.includes('基础') || str.includes('扶持') || str.includes('体验')) {
        return 'support';
      }
      return '';
    }
    
    // 格式化货币（只支持美元）
    function formatCurrency(amount) {
      return `$${amount.toLocaleString()}`;
    }
    
    // 生成GMV趋势文本
    function generateGMVTrend(currentGMV) {
      // 模拟上月数据（实际使用中可从数据库获取）
      const lastMonthGMV = currentGMV * (0.75 + Math.random() * 0.5); // 随机生成上月数据
      const growth = ((currentGMV - lastMonthGMV) / lastMonthGMV * 100).toFixed(1);
      
      if (growth > 5) {
        return `📈 较上月增长 ${growth}%`;
      } else if (growth < -5) {
        return `📉 较上月下降 ${Math.abs(growth)}%`;
      } else {
        return `📀 较上月基本持平 (${growth > 0 ? '+' : ''}${growth}%)`;
      }
    }
    
    // 显示客户卡片 - 重新设计以支持新字段
    function showCustomerCard(customer) {
      appState.selectedCustomer = customer;
      
      // 移除所有选中状态
      document.querySelectorAll('.data-table tr.selected').forEach(tr => {
        tr.classList.remove('selected');
      });
      
      // 添加选中状态到当前行
      if (event && event.target) {
        event.target.closest('tr').classList.add('selected');
      }
      
      // 生成卡片HTML
      const cardHtml = generateCustomerCardHTML(customer);
      
      // 更新卡片内容
      const cardContainer = $('cardContent');
      cardContainer.innerHTML = cardHtml;
      
      // 显示卡片
      $('infoCard').querySelector('.empty-state').style.display = 'none';
      cardContainer.style.display = 'block';
      
      // 响应式处理
      if (window.innerWidth <= 1024) {
        $('infoCard').classList.add('open');
      }
    }
    
    // 动态生成客户信息卡HTML - 根据实际数据结构生成
    function generateCustomerCardHTML(customer) {
      const resources = customer.resources || [];
      const allData = customer.allData || {};
      const displayData = customer.displayData || {};
      
      // 按类别分组字段
      const fieldsByCategory = groupFieldsByCategory(allData, appState.fieldMap);
      
      return `
        <div class="card-content">
          <div class="card-header">
            <div class="customer-basic">
              <h2 class="customer-name">${customer.customer_name || '未知客户'}</h2>
              <div class="customer-id">${getIdFieldDisplay(customer, allData)}</div>
            </div>
            <div class="customer-stats">
              <div class="field-count">字段数: ${Object.keys(allData).length}</div>
              <div class="resource-count">资源数: ${resources.length}</div>
            </div>
          </div>

          <div class="card-body">
            ${generateFieldSections(fieldsByCategory, displayData)}
            
            ${resources.length > 0 ? `
            <div class="resources-section">
              <h3>🎁 资源信息</h3>
              <div class="resources-grid">
                ${resources.map(resource => `
                  <div class="resource-tag ${getResourceType(resource.name)}">
                    <span class="icon">${getResourceIcon(resource.name)}</span>
                    <div class="resource-content">
                      <div class="resource-name">${resource.name}</div>
                      <div class="resource-value">${resource.displayValue || resource.value}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>` : ''}
          </div>

          <div class="card-footer">
            <div class="generation-time">生成时间: ${new Date().toLocaleString('zh-CN')}</div>
            <div class="data-source">数据来源: 客户信息管理系统</div>
          </div>
        </div>
      `;
    }
    
    // 按类别分组字段
    function groupFieldsByCategory(allData, fieldMap) {
      const categories = {
        basic: { title: '💼 基本信息', fields: [] },
        financial: { title: '💰 财务数据', fields: [] },
        rating: { title: '⭐ 评级信息', fields: [] },
        target: { title: '🎯 目标进度', fields: [] },
        team: { title: '👥 团队信息', fields: [] },
        industry: { title: '🏢 行业信息', fields: [] },
        time: { title: '🕰️ 时间信息', fields: [] },
        general: { title: '📊 其他信息', fields: [] }
      };
      
      Object.keys(allData).forEach(fieldName => {
        const fieldInfo = fieldMap.allFields.find(f => f.name === fieldName);
        const category = fieldInfo ? fieldInfo.category : 'general';
        
        // 跳过空值和关键字段（已在头部显示）
        if (allData[fieldName] && 
            (!fieldInfo || !fieldInfo.isKey) &&
            allData[fieldName] !== '' && 
            allData[fieldName] !== '-' && 
            allData[fieldName] !== '0') {
          categories[category].fields.push({
            name: fieldName,
            value: allData[fieldName],
            type: fieldInfo ? fieldInfo.type : 'text'
          });
        }
      });
      
      // 过滤空类别
      Object.keys(categories).forEach(key => {
        if (categories[key].fields.length === 0) {
          delete categories[key];
        }
      });
      
      return categories;
    }
    
    // 生成字段区块
    function generateFieldSections(fieldsByCategory, displayData) {
      return Object.entries(fieldsByCategory).map(([category, categoryInfo]) => {
        if (categoryInfo.fields.length === 0) return '';
        
        return `
          <div class="metric-section ${category}-section">
            <h3>${categoryInfo.title}</h3>
            ${categoryInfo.fields.map(field => {
              const displayValue = displayData[field.name] || field.value;
              const isHighlight = isHighlightField(field.name, field.value);
              
              return `
                <div class="metric-row ${isHighlight ? 'highlight' : ''}">
                  <span class="label">${field.name}</span>
                  <span class="value ${getValueClass(field.type)}">${displayValue}</span>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }).join('');
    }
    
    // 获取ID字段显示
    function getIdFieldDisplay(customer, allData) {
      if (customer.shop_id && customer.shop_id !== customer.customer_name) {
        return `ID: ${customer.shop_id}`;
      }
      
      // 查找其他可能的ID字段
      const idFields = Object.keys(allData).filter(key => 
        key.toLowerCase().includes('id') || 
        key.toLowerCase().includes('编号')
      );
      
      if (idFields.length > 0) {
        return `${idFields[0]}: ${allData[idFields[0]]}`;
      }
      
      return '系统自动生成ID';
    }
    
    // 判断是否为重点字段
    function isHighlightField(fieldName, value) {
      const name = fieldName.toLowerCase();
      return name.includes('gmv') || 
             name.includes('销售') || 
             name.includes('营业') || 
             name.includes('星') || 
             name.includes('等级') ||
             name.includes('目标') ||
             (name.includes('完成') && String(value).includes('%'));
    }
    
    // 获取值的CSS类名
    function getValueClass(type) {
      switch (type) {
        case 'currency': return 'currency-value';
        case 'rating': return 'rating-value';
        case 'percentage': return 'percentage-value';
        case 'number': return 'number-value';
        case 'boolean': return 'boolean-value';
        default: return 'text-value';
      }
    }
    
    // 关闭信息卡
    function closeInfoCard() {
      $('infoCard').querySelector('.empty-state').style.display = 'flex';
      $('cardContent').style.display = 'none';
      $('infoCard').classList.remove('open');
      
      // 移除选中状态
      document.querySelectorAll('.data-table tr.selected').forEach(tr => {
        tr.classList.remove('selected');
      });
      
      appState.selectedCustomer = null;
    }
    
    // 更新空状态
    function updateEmptyState() {
      if (appState.customers.length === 0) {
        $('emptyState').style.display = 'flex';
        $('dataTable').style.display = 'none';
      }
    }
    
    // 更新清空按钮
    function updateClearButton() {
      $('clearBtn').style.display = appState.customers.length > 0 ? 'block' : 'none';
    }
    
    // 更新计数
    function updateCounts() {
      $('totalCount').textContent = appState.customers.length;
      $('filteredCount').textContent = appState.filteredCustomers.length;
    }
    
    // 过滤处理
    function handleFilter() {
      const search = $('searchInput').value.toLowerCase().trim();
      const starFilter = $('starFilter').value;
      const trendFilter = $('trendFilter').value;
      
      appState.filteredCustomers = appState.customers.filter(customer => {
        // 搜索过滤
        const matchSearch = !search || 
          customer.customer_name.toLowerCase().includes(search) ||
          customer.shop_id.toLowerCase().includes(search);
        
        // 星级过滤
        const matchStar = !starFilter || customer.star_current.toString() === starFilter;
        
        // 趋势过滤
        const matchTrend = !trendFilter || customer.trend === trendFilter;
        
        return matchSearch && matchStar && matchTrend;
      });
      
      updateTable();
      updateCounts();
    }
    
    // 排序处理
    function handleSort(field) {
      if (appState.sortBy === field) {
        appState.sortOrder = appState.sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        appState.sortBy = field;
        appState.sortOrder = 'desc';
      }
      
      appState.filteredCustomers.sort((a, b) => {
        let aVal = a[field];
        let bVal = b[field];
        
        // 数字类型排序
        if (field === 'gmv_month' || field === 'star_current' || field === 'star_predicted') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        } else {
          // 字符串排序
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }
        
        if (aVal < bVal) return appState.sortOrder === 'asc' ? -1 : 1;
        if (aVal > bVal) return appState.sortOrder === 'asc' ? 1 : -1;
        return 0;
      });
      
      updateTable();
    }
    
    // 下载模板（根据实际数据结构调整）
    function downloadTemplate() {
      console.log('开始下载模板...');
      
      try {
        const template = [
          ['国际站ID', '客户名称', '评定星等级', '当前预测星等级', '本月实收GMV', '摘星计划权益预测', '交易倍增俱乐部权益预测', '钻享计划权益预测', '钻享季度资源预估', '钻享月度资源预估'],
          ['customer001', '客户001', '2', '2', '8720', '-', '无资源', '-', '-', '-'],
          ['customer002', '客户002', '4', '4', '0', '大海景+优品', '无资源', '-', '-', '-'],
          ['customer003', '客户003', '1', '1', '141', '-', '无资源', '-', '-', '-'],
          ['customer004', '客户004', '5', '5', '373039', '大海景+优品', '大海景资源和优品', '钻享履约权益', '大促榜单', '钻享履约权益'],
          ['customer005', '客户005', '5', '5', '937158', '大海景+优品', '大海景资源和优品', '钻享履约权益', '大促榜单', '钻享履约权益'],
          ['customer006', '客户006', '4', '4', '67844', '大海景+优品', '小海景资源和优品', '-', '-', '-'],
          ['customer007', '客户007', '3', '3', '11588', '大海景+优品', '无资源', '-', '-', '-'],
          ['customer008', '客户008', '3', '3', '17626', '大海景+优品', '无资源', '-', '-', '-']
        ];
        
        console.log('模板数据准备完成:', template);
        
        const csv = template.map(row => 
          row.map(cell => '"' + String(cell).replace(/"/g, '""') + '"').join(',')
        ).join('\n');
        
        console.log('CSV数据生成完成');
        
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        console.log('Blob URL创建完成:', url);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = '客户信息导入模板.csv';
        a.style.display = 'none';
        document.body.appendChild(a);
        
        console.log('开始下载...');
        a.click();
        
        // 清理
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          console.log('清理完成');
        }, 100);
        
        // 显示成功消息
        setTimeout(() => {
          alert('📋 模板下载成功！\n\n📌 使用说明：\n1. 必填字段：国际站ID、客户名称\n2. 星级范围：0-5（支持预测变化）\n3. GMV输入数字（系统自动使用美元格式）\n4. 权益资源列可留空，系统会自动识别\n5. 模板包含真实客户案例供参考\n\n💡 支持字段：评定星等级、预测星等级、本月实收GMV等');
        }, 200);
        
      } catch (error) {
        console.error('下载模板错误:', error);
        alert('下载模板失败: ' + error.message);
      }
    }
    
    // 清空数据
    function clearData() {
      if (confirm('确定要清空所有数据吗？此操作不可撤销。')) {
        appState.customers = [];
        appState.filteredCustomers = [];
        closeInfoCard();
        updateStatus('已清空数据', 'warning');
        updateUI();
      }
    }
    
    // 复制为图片
    async function copyAsImage() {
      if (!appState.selectedCustomer) {
        alert('请先选择一个客户');
        return;
      }
      
      try {
        const card = $('cardContent');
        if (typeof html2canvas === 'undefined') {
          alert('截图功能未加载，请刷新页面重试');
          return;
        }
        
        updateStatus('正在生成图片...', 'warning');
        
        const canvas = await html2canvas(card, {
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true,
          allowTaint: true,
          foreignObjectRendering: false
        });
        
        canvas.toBlob(async (blob) => {
          try {
            // 尝试写入剪贴板
            if (navigator.clipboard && window.ClipboardItem) {
              await navigator.clipboard.write([
                new ClipboardItem({ 'image/png': blob })
              ]);
              updateStatus('图片已复制到剪贴板', 'success');
              alert('✅ 图片已复制到剪贴板！\n\n可在微信聊天窗口直接 Ctrl+V 粘贴发送');
            } else {
              throw new Error('浏览器不支持剪贴板图片');
            }
          } catch (e) {
            // 降级：自动下载
            downloadBlob(blob, `${appState.selectedCustomer.customer_name}_信息卡.png`);
            updateStatus('已下载图片文件', 'success');
            alert('📥 图片已下载到本地！\n\n请在微信中选择"发送图片"功能上传');
          }
        }, 'image/png');
        
      } catch (error) {
        updateStatus('生成图片失败', 'error');
        console.error('Copy image error:', error);
        alert('生成图片失败: ' + error.message);
      }
    }
    
    // 复制为文本
    function copyAsText() {
      if (!appState.selectedCustomer) {
        alert('请先选择一个客户');
        return;
      }
      
      const c = appState.selectedCustomer;
      const diff = c.star_predicted - c.star_current;
      const trendText = diff > 0 ? `上升${diff}星` : diff < 0 ? `下降${Math.abs(diff)}星` : '保持不变';
      
      const text = `📋 客户信息卡\n━━━━━━━━━━━━━━\n👤 客户名称：${c.customer_name}\n🏪 国际站ID：${c.shop_id}\n⭐ 评定星等级：${c.star_current}星\n🔮 预测星等级：${c.star_predicted}星 (${trendText})\n💰 本月实收GMV：$${c.gmv_month.toLocaleString()}\n📦 权益资源：${c.resources.length > 0 ? c.resources.join('、') : '暂无'}\n━━━━━━━━━━━━━━\n💼 客户信息管理系统`;
      
      navigator.clipboard.writeText(text).then(() => {
        updateStatus('文本已复制到剪贴板', 'success');
        alert('✅ 文本已复制到剪贴板！\n\n可直接粘贴到微信、邮件等应用中');
      }).catch(() => {
        // 降级处理
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        updateStatus('文本已复制', 'success');
        alert('✅ 文本已复制！');
      });
    }
    
    // 下载PNG
    async function downloadPNG() {
      if (!appState.selectedCustomer) {
        alert('请先选择一个客户');
        return;
      }
      
      try {
        const card = $('cardContent');
        if (typeof html2canvas === 'undefined') {
          alert('截图功能未加载，请刷新页面重试');
          return;
        }
        
        updateStatus('正在生成PNG...', 'warning');
        
        const canvas = await html2canvas(card, {
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true
        });
        
        canvas.toBlob((blob) => {
          downloadBlob(blob, `${appState.selectedCustomer.customer_name}_信息卡.png`);
          updateStatus('PNG下载完成', 'success');
        }, 'image/png');
        
      } catch (error) {
        updateStatus('下载失败', 'error');
        console.error('Download PNG error:', error);
        alert('下载失败: ' + error.message);
      }
    }
    
    // 下载Blob文件
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // 加载演示数据（根据实际数据结构调整）
    function loadSampleData() {
      const sampleData = [
        {
          customer_name: '客户001',
          shop_id: 'customer001',
          star_current: 2,
          star_predicted: 2,
          gmv_month: 8720,
          resources: ['无资源'],
          trend: 'same',
          id: 'sample_1'
        },
        {
          customer_name: '客户002',
          shop_id: 'customer002',
          star_current: 4,
          star_predicted: 4,
          gmv_month: 0,
          resources: ['大海景+优品', '无资源'],
          trend: 'same',
          id: 'sample_2'
        },
        {
          customer_name: '客户003',
          shop_id: 'customer003',
          star_current: 1,
          star_predicted: 1,
          gmv_month: 141,
          resources: ['无资源'],
          trend: 'same',
          id: 'sample_3'
        },
        {
          customer_name: '客户004',
          shop_id: 'customer004',
          star_current: 3,
          star_predicted: 3,
          gmv_month: 3170,
          resources: ['大海景+优品', '无资源'],
          trend: 'same',
          id: 'sample_4'
        },
        {
          customer_name: '客户005',
          shop_id: 'customer005',
          star_current: 5,
          star_predicted: 5,
          gmv_month: 373039,
          resources: ['大海景+优品', '大海景资源和优品', '钻享履约权益', '大促榜单'],
          trend: 'same',
          id: 'sample_5'
        },
        {
          customer_name: '客户006',
          shop_id: 'customer006',
          star_current: 5,
          star_predicted: 5,
          gmv_month: 937158,
          resources: ['大海景+优品', '大海景资源和优品', '钻享履约权益', '大促榜单'],
          trend: 'same',
          id: 'sample_6'
        },
        {
          customer_name: '客户007',
          shop_id: 'customer007',
          star_current: 4,
          star_predicted: 4,
          gmv_month: 67844,
          resources: ['大海景+优品', '小海景资源和优品'],
          trend: 'same',
          id: 'sample_7'
        },
        {
          customer_name: '客户008',
          shop_id: 'customer008',
          star_current: 3,
          star_predicted: 3,
          gmv_month: 11588,
          resources: ['大海景+优品', '无资源'],
          trend: 'same',
          id: 'sample_8'
        }
      ];
      
      appState.customers = sampleData;
      appState.filteredCustomers = [...sampleData];
      
      updateStatus('已加载8个客户演示数据', 'success');
      updateUI();
      
      // 自动选中第一个客户作为示例
      setTimeout(() => {
        const firstRow = document.querySelector('.data-table tbody tr');
        if (firstRow) {
          firstRow.click();
        }
      }, 500);
    }
    
    // 启动应用
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å®¢æˆ·ä¿¡æ¯å¡ç”Ÿæˆå™¨ - å·¥å…·ä¸­å¿ƒ</title>
  <script>
    // èº«ä»½éªŒè¯æ£€æŸ¥
    const SESSION_KEY = 'toolcenter_auth';
    const REMEMBER_KEY = 'toolcenter_remember';
    
    function checkAuth() {
      const sessionAuth = sessionStorage.getItem(SESSION_KEY);
      const rememberAuth = localStorage.getItem(REMEMBER_KEY);
      
      if (sessionAuth === 'authenticated') {
        return true;
      }
      
      if (rememberAuth) {
        try {
          const authData = JSON.parse(rememberAuth);
          const expiryTime = new Date(authData.expiry);
          const now = new Date();
          
          if (now < expiryTime) {
            sessionStorage.setItem(SESSION_KEY, 'authenticated');
            return true;
          } else {
            localStorage.removeItem(REMEMBER_KEY);
          }
        } catch (e) {
          localStorage.removeItem(REMEMBER_KEY);
        }
      }
      
      return false;
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥èº«ä»½éªŒè¯
    if (!checkAuth()) {
      window.location.href = './login.html';
    }
  </script>
  <style>
    :root {
      --panel: #ffffff; --border: #e5e7eb; --text: #111827; --muted: #6b7280; 
      --accent: #1b65ff; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      --star-gold: #fbbf24;
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font: 14px/1.45 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, 'PingFang SC','Hiragino Sans GB','Microsoft YaHei', sans-serif;
      color: var(--text);
      background: #f9fafb;
    }
    
    /* å¯¼èˆªæ  */
    .navbar {
      position: sticky; top: 0; z-index: 9999; background: var(--panel);
      border-bottom: 1px solid var(--border); box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }
    .navbar .wrap { display: flex; align-items: center; gap: 10px; padding: 10px 16px; }
    .navbar .brand { font-weight: 700; color: var(--text); margin-right: 6px; }
    .navbar a, .navbar .navlink {
      display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px;
      border: 1px solid var(--border); border-radius: 10px; color: #374151;
      text-decoration: none; font-size: 14px; transition: all 0.2s ease;
    }
    .navbar a:hover, .navbar .navlink:hover { background: #f3f4f6; border-color: #d1d5db; transform: translateY(-1px); }
    .navbar a.active, .navbar .navlink.active { background: var(--accent); border-color: var(--accent); color: #ffffff; }
    
    /* ä¸»å®¹å™¨ */
    .container { display: grid; grid-template-columns: 1fr 400px; height: calc(100vh - 60px); gap: 0; }
    .main-panel { display: flex; flex-direction: column; background: var(--panel); border-right: 1px solid var(--border); }
    
    /* å·¥å…·æ  */
    .toolbar {
      padding: 16px; background: var(--panel); border-bottom: 1px solid var(--border);
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
    }
    .btn {
      appearance: none; border: 1px solid var(--border); background: var(--panel);
      color: var(--text); padding: 8px 16px; border-radius: 8px; cursor: pointer;
      transition: all 0.2s; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:hover { background: #f3f4f6; border-color: #d1d5db; }
    .btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
    .btn.success { background: var(--success); border-color: var(--success); color: white; }
    .btn.danger { background: var(--danger); border-color: var(--danger); color: white; }
    
    /* æœç´¢å’Œè¿‡æ»¤ */
    .filters {
      padding: 12px 16px; background: #f8fafc; border-bottom: 1px solid var(--border);
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
    }
    .search-input, .filter-select {
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
      outline: none; font-size: 14px;
    }
    .search-input { min-width: 200px; flex: 1; max-width: 300px; }
    
    /* æ•°æ®è¡¨æ ¼ */
    .table-container { flex: 1; overflow: auto; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th {
      position: sticky; top: 0; background: #f8fafc; border-bottom: 1px solid var(--border);
      padding: 12px 8px; text-align: left; font-weight: 600; font-size: 12px;
      color: var(--muted); cursor: pointer;
    }
    .data-table th:hover { background: #f1f5f9; }
    .data-table td { border-bottom: 1px solid #f1f5f9; padding: 12px 8px; }
    .data-table tr { cursor: pointer; transition: background-color 0.15s; }
    .data-table tr:hover { background: #f8fafc; }
    .data-table tr.selected { background: #dbeafe; }
    
    /* æ˜Ÿçº§æ˜¾ç¤ºä¼˜åŒ– */
    .star-rating { display: inline-flex; align-items: center; gap: 2px; }
    .star { color: #d1d5db; font-size: 16px; transition: all 0.2s; }
    .star.filled { color: var(--star-gold); text-shadow: 0 0 3px rgba(251, 191, 36, 0.3); }
    .star.predicted { color: var(--star-gold); opacity: 0.6; animation: pulse 2s infinite; }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    
    /* å‡é™æŒ‡ç¤ºä¼˜åŒ– */
    .trend { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 500; padding: 2px 6px; border-radius: 12px; }
    .trend.up { color: var(--success); background: rgba(16, 185, 129, 0.1); }
    .trend.down { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
    .trend.same { color: var(--muted); background: rgba(107, 114, 128, 0.1); }
    
    /* GMVæ˜¾ç¤ºä¼˜åŒ– */
    .gmv-display {
      font-size: 16px;
      font-weight: 700;
      background: linear-gradient(135deg, #10b981, #059669);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .gmv-display.large {
      font-size: 22px;
    }
    
    /* åŠ¨æ€ä¿¡æ¯å¡æ ·å¼å¢å¼º */
    .customer-stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    
    .field-count, .resource-count {
      background: #f3f4f6;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    /* å­—æ®µå€¼ç±»å‹æ ·å¼ */
    .currency-value {
      font-weight: 700;
      color: var(--success);
    }
    
    .rating-value {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    
    .percentage-value {
      color: var(--accent);
      font-weight: 600;
    }
    
    .number-value {
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }
    
    .boolean-value {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .boolean-value:contains('æ˜¯') {
      background: #dcfce7;
      color: #166534;
    }
    
    .boolean-value:contains('å¦') {
      background: #fef2f2;
      color: #991b1b;
    }
    
    .metric-row.highlight {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 4px 0;
    }
    
    /* åˆ†ç±»åŒºå—æ ·å¼ */
    .basic-section {
      border-left: 4px solid #3b82f6;
    }
    
    .financial-section {
      border-left: 4px solid #10b981;
    }
    
    .rating-section {
      border-left: 4px solid #f59e0b;
    }
    
    .target-section {
      border-left: 4px solid #ef4444;
    }
    
    .team-section {
      border-left: 4px solid #8b5cf6;
    }
    
    .industry-section {
      border-left: 4px solid #06b6d4;
    }
    
    .time-section {
      border-left: 4px solid #84cc16;
    }
    
    .general-section {
      border-left: 4px solid #6b7280;
    }
    
    /* èµ„æºæ ‡ç­¾ç¾åŒ– */
    .resource-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 1px solid #f59e0b;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      color: #92400e;
      margin: 2px;
      transition: all 0.2s;
    }
    
    .resource-tag:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }
    
    .resource-tag .icon {
      font-size: 10px;
    }
    
    /* ä¸åŒç±»å‹èµ„æºçš„é¢œè‰²ä¸»é¢˜ */
    .resource-tag.promotion {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      border-color: #3b82f6;
      color: #1e40af;
    }
    
    .resource-tag.content {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border-color: #10b981;
      color: #059669;
    }
    
    .resource-tag.support {
      background: linear-gradient(135deg, #fce7f3, #fbcfe8);
      border-color: #ec4899;
      color: #be185d;
    }
    
    /* è¡¨æ ¼æ ·å¼å¢å¼º */
    .customer-name-cell {
      min-width: 200px;
    }
    
    .customer-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .customer-preview {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.3;
    }
    
    .id-cell {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--accent);
    }
    
    .count-cell {
      text-align: center;
    }
    
    .field-badge, .resource-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .field-badge {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .resource-badge {
      background: #fef3c7;
      color: #92400e;
    }
    
    .action-cell {
      text-align: center;
    }
    
    .btn-view {
      padding: 4px 8px;
      font-size: 11px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-view:hover {
      background: #1854d1;
      transform: translateY(-1px);
    }
    
    /* å·¥å…·æç¤º */
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 1000;
    }
    
    .tooltip:hover::after {
      opacity: 1;
    }
    
    /* å³ä¾§ä¿¡æ¯å¡ */
    .info-card {
      background: var(--panel); display: flex; flex-direction: column;
      height: 100%; overflow: hidden;
    }
    .card-header {
      padding: 20px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .card-title { font-size: 18px; font-weight: 600; color: var(--text); margin: 0; }
    .card-subtitle { font-size: 14px; color: var(--muted); margin: 4px 0 0 0; }
    .card-content { padding: 20px; flex: 1; overflow-y: auto; }
    .info-section { margin-bottom: 24px; }
    .info-section h4 { margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--text); }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .info-item {
      background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center;
    }
    .info-item .label { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .info-item .value { font-size: 18px; font-weight: 600; color: var(--text); }
    .resources-list { list-style: none; margin: 0; padding: 0; }
    .resources-list li {
      padding: 8px 12px; background: #f8fafc; border-radius: 6px;
      margin-bottom: 6px; font-size: 13px; color: var(--text);
      position: relative; transition: all 0.2s;
    }
    
    .resources-list li:hover {
      background: #f1f5f9;
      transform: translateX(4px);
    }
    
    .resources-list li::before {
      content: 'ğŸ';
      margin-right: 8px;
      font-size: 12px;
    }
    
    .resources-list li.empty {
      color: var(--muted);
      font-style: italic;
    }
    
    .resources-list li.empty::before {
      content: 'ğŸ’­';
    }
    .card-actions {
      padding: 20px; border-top: 1px solid var(--border);
      display: flex; gap: 12px;
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 100%; text-align: center; color: var(--muted);
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    
    /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
    .file-input { position: absolute; opacity: 0; pointer-events: none; }
    
    /* çŠ¶æ€æŒ‡ç¤º */
    .status { font-size: 12px; padding: 2px 8px; border-radius: 12px; font-weight: 500; }
    .status.success { background: #dcfce7; color: #166534; }
    .status.warning { background: #fef3c7; color: #92400e; }
    .status.error { background: #fee2e2; color: #dc2626; }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 1024px) {
      .container { grid-template-columns: 1fr; }
      .info-card {
        position: fixed; top: 60px; right: 0; width: 400px; height: calc(100vh - 60px);
        transform: translateX(100%); transition: transform 0.3s ease; z-index: 1000;
        box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
      }
      .info-card.open { transform: translateX(0); }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="wrap">
      <div class="brand">ğŸ› ï¸ å·¥å…·ä¸­å¿ƒ</div>
      <a class="navlink" href="./index.html">é¦–é¡µ</a>
      <a class="navlink" href="./image-gallery.html">æ‰¹é‡å›¾ç‰‡å±•ç¤ºå™¨</a>
      <a class="navlink" href="./customer-search.html">å®¢æˆ·ä¿¡æ¯æœç´¢</a>
      <a class="navlink active" href="./customer-card.html" aria-current="page">å®¢æˆ·ä¿¡æ¯å¡ç”Ÿæˆå™¨</a>
      <a class="navlink" href="./script-editor.html">è¯æœ¯ç¼–è¾‘å™¨</a>
      <div style="flex: 1;"></div>
    </div>
  </nav>

  <div class="container">
    <!-- å·¦ä¾§ä¸»åŒºåŸŸ -->
    <div class="main-panel">
      <!-- å·¥å…·æ  -->
      <div class="toolbar">
        <button class="btn primary" id="importBtn">ğŸ“ å¯¼å…¥æ–‡ä»¶ (XLSX/CSV/TSV)</button>
        <button class="btn" id="downloadTemplateBtn">ğŸ“‹ ä¸‹è½½æ¨¡æ¿</button>
        <button class="btn danger" id="clearBtn" style="display: none;">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
        
        <div style="flex: 1;"></div>
        
        <div class="currency-display" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; background: #f8fafc; font-size: 12px; color: var(--muted);">
          ğŸ’° è´§å¸å•ä½ï¼šç¾å…ƒ (USD)
        </div>
        
        <span class="status" id="dataStatus">
          <span id="statusText">æœªå¯¼å…¥æ•°æ®</span>
        </span>
      </div>
      
      <!-- æœç´¢å’Œè¿‡æ»¤ -->
      <div class="filters">
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢å®¢æˆ·åç§°æˆ–åº—é“ºID...">
        
        <select class="filter-select" id="starFilter">
          <option value="">æ‰€æœ‰æ˜Ÿçº§</option>
          <option value="0">0æ˜Ÿ</option><option value="1">1æ˜Ÿ</option><option value="2">2æ˜Ÿ</option>
          <option value="3">3æ˜Ÿ</option><option value="4">4æ˜Ÿ</option><option value="5">5æ˜Ÿ</option>
        </select>
        
        <select class="filter-select" id="trendFilter">
          <option value="">å‡é™è¶‹åŠ¿</option>
          <option value="up">é¢„æµ‹ä¸Šå‡</option><option value="down">é¢„æµ‹ä¸‹é™</option><option value="same">ä¿æŒä¸å˜</option>
        </select>
        
        <span style="color: var(--muted); font-size: 12px;">
          å·²ç­›é€‰ï¼š<b id="filteredCount">0</b> / æ€»æ•°ï¼š<b id="totalCount">0</b>
        </span>
      </div>
      
      <!-- æ•°æ®è¡¨æ ¼ -->
      <div class="table-container">
        <div class="empty-state" id="emptyState">
          <div class="icon">ğŸ“Š</div>
          <h3>æš‚æ— å®¢æˆ·æ•°æ®</h3>
          <p>è¯·å¯¼å…¥ XLSXã€CSV æˆ– TSV æ–‡ä»¶å¼€å§‹ä½¿ç”¨</p>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn primary" onclick="document.getElementById('importBtn').click()">
              ğŸ“ ç«‹å³å¯¼å…¥
            </button>
            <button class="btn" id="loadSampleBtn">
              ğŸ† åŠ è½½æ¼”ç¤ºæ•°æ®
            </button>
          </div>
        </div>
        
        <table class="data-table" id="dataTable" style="display: none;">
          <thead>
            <tr>
              <th data-sort="customer_name">å®¢æˆ·åç§°</th>
              <th data-sort="shop_id">å›½é™…ç«™ID</th>
              <th data-sort="star_current">è¯„å®šæ˜Ÿç­‰çº§</th>
              <th data-sort="star_predicted">é¢„æµ‹æ˜Ÿç­‰çº§</th>
              <th data-sort="gmv_month">æœ¬æœˆå®æ”¶GMV</th>
              <th>å‡é™è¶‹åŠ¿</th>
              <th class="resource-col">æƒç›Šèµ„æº</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- å³ä¾§ä¿¡æ¯å¡ -->
    <div class="info-card" id="infoCard">
      <div class="empty-state">
        <div class="icon">ğŸ‘¤</div>
        <h3>é€‰æ‹©å®¢æˆ·æŸ¥çœ‹è¯¦æƒ…</h3>
        <p>ç‚¹å‡»è¡¨æ ¼ä¸­çš„ä»»æ„å®¢æˆ·è¡ŒæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯å¡</p>
      </div>
      
      <!-- å®¢æˆ·è¯¦æƒ…å†…å®¹ -->
      <div id="cardContent" style="display: none;">
        <div class="card-header">
          <div>
            <h2 class="card-title" id="cardCustomerName">å®¢æˆ·åç§°</h2>
            <p class="card-subtitle" id="cardShopId">å›½é™…ç«™ID: -</p>
          </div>
          <button class="btn" onclick="closeInfoCard()">âœ•</button>
        </div>
        
        <div class="card-content">
          <div class="info-section">
            <h4>æ˜Ÿçº§è¯„ä¼°</h4>
            <div class="info-grid">
              <div class="info-item">
                <div class="label">è¯„å®šæ˜Ÿç­‰çº§</div>
                <div class="value" id="cardCurrentStar">-</div>
              </div>
              <div class="info-item">
                <div class="label">é¢„æµ‹æ˜Ÿç­‰çº§</div>
                <div class="value" id="cardPredictedStar">-</div>
              </div>
            </div>
            <div style="margin-top: 12px; text-align: center;">
              <span id="cardTrend" class="trend">â†’ æ— å˜åŒ–</span>
            </div>
          </div>
          
          <div class="info-section">
            <h4>ä¸šåŠ¡æ•°æ®</h4>
            <div class="info-item highlight">
              <div class="label">æœ¬æœˆå®æ”¶GMV</div>
              <div class="value gmv-display large" id="cardGmv">-</div>
            </div>
            <div style="margin-top: 8px; font-size: 12px; color: var(--muted); text-align: center;">
              <span id="gmvTrend">è¾ƒä¸Šæœˆè¶‹åŠ¿å¾…åˆ†æ</span>
            </div>
          </div>
          
          <div class="info-section">
            <h4>æƒç›Šèµ„æº <span style="font-size: 12px; color: var(--muted); font-weight: normal;" id="resourceCount">(0é¡¹)</span></h4>
            <ul class="resources-list" id="cardResources">
              <li class="empty">æš‚æ— æƒç›Šèµ„æºä¿¡æ¯</li>
            </ul>
          </div>
        </div>
        
        <div class="card-actions">
          <button class="btn primary" id="copyImageBtn">ğŸ“· å¤åˆ¶ä¸ºå›¾ç‰‡</button>
          <button class="btn" id="copyTextBtn">ğŸ“ å¤åˆ¶ä¸ºæ–‡æœ¬</button>
          <button class="btn" id="downloadPngBtn">ğŸ’¾ ä¸‹è½½PNG</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- éšè—çš„æ–‡ä»¶è¾“å…¥å·²åˆ é™¤ -->
  
  <!-- ä¾èµ–è„šæœ¬ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <!-- ä¸»åŠŸèƒ½è„šæœ¬ -->
  <script>
    // åº”ç”¨çŠ¶æ€
    const appState = {
      customers: [],
      filteredCustomers: [],
      selectedCustomer: null,
      currency: 'USD', // é»˜è®¤ä½¿ç”¨ç¾å…ƒ
      sortBy: 'gmv_month',
      sortOrder: 'desc'
    };
    
    // DOM å…ƒç´ å¿«é€Ÿè®¿é—®
    const $ = id => document.getElementById(id);
    
    // åˆå§‹åŒ–åº”ç”¨
    function initApp() {
      console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
      
      // æ£€æŸ¥å…³é”® DOM å…ƒç´ 
      const importBtn = $('importBtn');
      const downloadTemplateBtn = $('downloadTemplateBtn');
      // const fileInput = $('fileInput'); // æ–‡ä»¶è¾“å…¥å·²åˆ é™¤
      
      console.log('DOM å…ƒç´ æ£€æŸ¥:');
      console.log('- importBtn:', importBtn);
      console.log('- downloadTemplateBtn:', downloadTemplateBtn);
      // console.log('- fileInput:', fileInput); // æ–‡ä»¶è¾“å…¥å·²åˆ é™¤
      
      if (!importBtn || !downloadTemplateBtn) {
        console.error('å…³é”® DOM å…ƒç´ ç¼ºå¤±ï¼');
        return;
      }
      
      bindEvents();
      updateUI();
      
      console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
    }
    
    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¾“å‡ºè­¦å‘Š
      const importBtn = $('importBtn');
      // const fileInput = $('fileInput'); // æ–‡ä»¶è¾“å…¥å·²åˆ é™¤
      const downloadTemplateBtn = $('downloadTemplateBtn');
      const clearBtn = $('clearBtn');
      const searchInput = $('searchInput');
      const starFilter = $('starFilter');
      const trendFilter = $('trendFilter');
      const copyImageBtn = $('copyImageBtn');
      const copyTextBtn = $('copyTextBtn');
      const downloadPngBtn = $('downloadPngBtn');
      
      if (!importBtn) {
        console.error('importBtn element not found');
        return;
      }
      // fileInput æ£€æŸ¥å·²åˆ é™¤ï¼Œå› ä¸ºå…ƒç´ å·²è¢«ç§»é™¤
      if (!downloadTemplateBtn) {
        console.error('downloadTemplateBtn element not found');
        return;
      }
      
      // ç»‘å®šå¯¼å…¥ç›¸å…³äº‹ä»¶ - fileInputç›¸å…³åŠŸèƒ½å·²åˆ é™¤
      // importBtn.addEventListener('click', function(e) {
      //   e.preventDefault();
      //   console.log('Import button clicked');
      //   fileInput.click();
      // });
      // 
      // fileInput.addEventListener('change', handleFileImport);
      
      // ç»‘å®šä¸‹è½½æ¨¡æ¿äº‹ä»¶
      downloadTemplateBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Download template button clicked');
        downloadTemplate();
      });
      
      // å…¶ä»–äº‹ä»¶ç»‘å®š
      if (clearBtn) clearBtn.addEventListener('click', clearData);
      if (searchInput) searchInput.addEventListener('input', handleFilter);
      if (starFilter) starFilter.addEventListener('change', handleFilter);
      if (trendFilter) trendFilter.addEventListener('change', handleFilter);
      if (copyImageBtn) copyImageBtn.addEventListener('click', copyAsImage);
      if (copyTextBtn) copyTextBtn.addEventListener('click', copyAsText);
      if (downloadPngBtn) downloadPngBtn.addEventListener('click', downloadPNG);
      
      // åŠ è½½æ¼”ç¤ºæ•°æ®æŒ‰é’®
      const loadSampleBtn = $('loadSampleBtn');
      if (loadSampleBtn) {
        loadSampleBtn.addEventListener('click', loadSampleData);
      }
      
      // è¡¨æ ¼æ’åºäº‹ä»¶
      document.querySelectorAll('[data-sort]').forEach(th => {
        th.addEventListener('click', () => handleSort(th.dataset.sort));
      });
      
      console.log('All events bound successfully');
    }
    
    // æ–‡ä»¶å¯¼å…¥å¤„ç†
    async function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      try {
        updateStatus('æ­£åœ¨å¯¼å…¥...', 'warning');
        
        const data = await parseFile(file);
        const processed = processCustomerData(data);
        
        appState.customers = processed.valid;
        appState.filteredCustomers = [...appState.customers];
        
        updateStatus(`æˆåŠŸå¯¼å…¥ ${processed.valid.length} æ¡å®¢æˆ·æ•°æ®`, 'success');
        if (processed.errors.length > 0) {
          console.warn('å¯¼å…¥è­¦å‘Š:', processed.errors);
        }
        
        updateUI();
        
      } catch (error) {
        updateStatus('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
        console.error('Import error:', error);
      }
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
      event.target.value = '';
    }
    
    // è§£ææ–‡ä»¶
    async function parseFile(file) {
      const fileName = file.name.toLowerCase();
      
      if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        return parseExcelFile(file);
      } else if (fileName.endsWith('.csv') || fileName.endsWith('.tsv') || fileName.endsWith('.txt')) {
        return parseTextFile(file);
      } else {
        throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä½¿ç”¨ XLSXã€CSV æˆ– TSV æ–‡ä»¶');
      }
    }
    
    // è§£æ Excel æ–‡ä»¶
    async function parseExcelFile(file) {
      if (typeof XLSX === 'undefined') {
        throw new Error('XLSX åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
      
      const arrayBuffer = await file.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      
      return XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    }
    
    // è§£ææ–‡æœ¬æ–‡ä»¶
    async function parseTextFile(file) {
      const text = await file.text();
      const lines = text.replace(/^\uFEFF/, '').trim().split(/\r?\n/);
      
      // æ£€æµ‹åˆ†éš”ç¬¦
      const firstLine = lines[0] || '';
      const delimiter = firstLine.includes('\t') ? '\t' : ',';
      
      return lines.map(line => {
        // ç®€å•çš„ CSV è§£æï¼ˆå¤„ç†å¼•å·ï¼‰
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === delimiter && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      });
    }
    
    // å¤„ç†å®¢æˆ·æ•°æ®
    function processCustomerData(rawData) {
      if (!rawData || rawData.length < 2) {
        throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
      }
      
      const headers = rawData[0].map(h => String(h).trim().toLowerCase());
      const rows = rawData.slice(1).filter(row => row.some(cell => String(cell).trim()));
      
      console.log('æ£€æµ‹åˆ°çš„å­—æ®µåç§°:', rawData[0]);
      console.log('å¤„ç†åçš„å­—æ®µåç§°:', headers);
      
      // å­—æ®µæ˜ å°„
      const fieldMap = mapFields(headers);
      console.log('å­—æ®µæ˜ å°„ç»“æœ:', fieldMap);
      
      // å­˜å‚¨å­—æ®µæ˜ å°„ä¿¡æ¯åˆ°å…¨å±€çŠ¶æ€
      if (!window.appState) window.appState = {};
      window.appState.fieldMap = fieldMap;
      window.appState.headers = rawData[0];
      
      const valid = [];
      const errors = [];
      
      rows.forEach((row, index) => {
        try {
          const customer = processCustomerRow(row, fieldMap, index + 2);
          if (customer) {
            valid.push(customer);
          }
        } catch (error) {
          errors.push({
            row: index + 2,
            error: error.message,
            data: row
          });
        }
      });
      
      // æ˜¾ç¤ºå­—æ®µæ˜ å°„ä¿¡æ¯
      const mappedFields = Object.keys(fieldMap).filter(key => key !== 'resources').map(key => {
        return `${key}: ${rawData[0][fieldMap[key]] || 'æœªæ‰¾åˆ°'}`;
      }).join(', ');
      
      const resourceFields = fieldMap.resources.map(index => rawData[0][index]).join(', ');
      
      console.log(`æ˜ å°„çš„å­—æ®µ: ${mappedFields}`);
      if (resourceFields) {
        console.log(`èµ„æºå­—æ®µ: ${resourceFields}`);
      }
      
      return { valid, errors, total: rows.length, fieldMapping: { mapped: mappedFields, resources: resourceFields } };
    }
    
    // åŠ¨æ€å­—æ®µæ˜ å°„ - è‡ªåŠ¨è¯†åˆ«æ‰€æœ‰å­—æ®µï¼Œä¸é™åˆ¶ç‰¹å®šå­—æ®µ
    function mapFields(headers) {
      console.log('å¼€å§‹åŠ¨æ€å­—æ®µæ˜ å°„ï¼Œè¡¨å¤´:', headers);
      
      const map = {
        allFields: [],  // å­˜å‚¨æ‰€æœ‰å­—æ®µä¿¡æ¯
        keyFields: {},  // å­˜å‚¨å…³é”®å­—æ®µçš„ç´¢å¼•
        resources: []   // å­˜å‚¨èµ„æºç›¸å…³å­—æ®µ
      };
      
      // å®šä¹‰å…³é”®å­—æ®µçš„è¯†åˆ«æ¨¡å¼ï¼ˆç”¨äºç‰¹æ®Šå¤„ç†ï¼‰
      const keyPatterns = {
        customer_name: ['å®¢æˆ·åç§°', 'customer_name', 'å®¢æˆ·', 'åç§°', 'name', 'å…¬å¸åç§°', 'å•†æˆ·åç§°', 'company'],
        shop_id: ['å›½é™…ç«™id', 'å›½é™…ç«™ID', 'shop_id', 'shopid', 'åº—é“ºid', 'åº—é“ºID', 'id', 'merchant_id', 'ç¼–å·'],
        star_current: ['è¯„å®šæ˜Ÿç­‰çº§', 'ç›®å‰æ˜Ÿç­‰çº§', 'star_current', 'å½“å‰æ˜Ÿçº§', 'æ˜Ÿçº§', 'ç­‰çº§'],
        star_predicted: ['é¢„æµ‹æ˜Ÿç­‰çº§', 'star_predicted', 'é¢„æµ‹æ˜Ÿçº§', 'é¢„æµ‹'],
        gmv_month: ['æœ¬æœˆå®æ”¶gmv', 'æœ¬æœˆå®æ”¶GMV', 'gmv_month', 'gmv', 'äº¤æ˜“é¢', 'é”€å”®é¢', 'è¥ä¸šé¢']
      };
      
      // éå†æ‰€æœ‰è¡¨å¤´ï¼Œåˆ›å»ºå­—æ®µæ˜ å°„
      headers.forEach((header, index) => {
        const fieldInfo = {
          index: index,
          name: header,
          displayName: header,
          type: 'text',  // é»˜è®¤ç±»å‹
          isKey: false,
          category: 'general'
        };
        
        const headerLower = header.toLowerCase();
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå…³é”®å­—æ®µ
        for (const [keyField, patterns] of Object.entries(keyPatterns)) {
          if (patterns.some(pattern => 
            headerLower.includes(pattern.toLowerCase()) || 
            pattern.toLowerCase().includes(headerLower)
          )) {
            map.keyFields[keyField] = index;
            fieldInfo.isKey = true;
            fieldInfo.keyType = keyField;
            console.log(`è¯†åˆ«å…³é”®å­—æ®µ: ${keyField} -> ${header} (ç´¢å¼•: ${index})`);
            break;
          }
        }
        
        // æ™ºèƒ½åˆ†ç±»å­—æ®µ
        fieldInfo.category = categorizeField(header);
        fieldInfo.type = detectFieldType(header);
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºèµ„æºå­—æ®µ
        if (isResourceField(header)) {
          map.resources.push(index);
          fieldInfo.category = 'resource';
        }
        
        map.allFields.push(fieldInfo);
      });
      
      // æ™ºèƒ½å›é€€ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°å…³é”®å­—æ®µï¼Œä½¿ç”¨æœ€ä½³çŒœæµ‹
      if (!map.keyFields.customer_name) {
        const nameField = findBestMatch(headers, ['åç§°', 'å®¢æˆ·', 'å…¬å¸', 'name', 'company']);
        if (nameField !== -1) {
          map.keyFields.customer_name = nameField;
          map.allFields[nameField].isKey = true;
          map.allFields[nameField].keyType = 'customer_name';
          console.log(`æ™ºèƒ½åŒ¹é…å®¢æˆ·åç§°å­—æ®µ: ${headers[nameField]}`);
        }
      }
      
      if (!map.keyFields.shop_id) {
        const idField = findBestMatch(headers, ['id', 'ID', 'ç¼–å·', 'code']);
        if (idField !== -1) {
          map.keyFields.shop_id = idField;
          map.allFields[idField].isKey = true;
          map.allFields[idField].keyType = 'shop_id';
          console.log(`æ™ºèƒ½åŒ¹é…IDå­—æ®µ: ${headers[idField]}`);
        } else {
          // ä½¿ç”¨ç¬¬ä¸€åˆ—ä½œä¸ºID
          map.keyFields.shop_id = 0;
          map.allFields[0].isKey = true;
          map.allFields[0].keyType = 'shop_id';
          console.log(`ä½¿ç”¨ç¬¬ä¸€åˆ—ä½œä¸ºID: ${headers[0]}`);
        }
      }
      
      console.log('åŠ¨æ€å­—æ®µæ˜ å°„å®Œæˆ:', map);
      console.log(`å…±è¯†åˆ« ${headers.length} ä¸ªå­—æ®µï¼Œå…¶ä¸­ ${Object.keys(map.keyFields).length} ä¸ªå…³é”®å­—æ®µï¼Œ${map.resources.length} ä¸ªèµ„æºå­—æ®µ`);
      
      return map;
    }
    
    // æ™ºèƒ½åˆ†ç±»å­—æ®µ
    function categorizeField(fieldName) {
      const name = fieldName.toLowerCase();
      
      if (name.includes('gmv') || name.includes('é”€å”®') || name.includes('è¥ä¸š') || name.includes('äº¤æ˜“') || name.includes('æ”¶å…¥')) {
        return 'financial';
      }
      if (name.includes('æ˜Ÿ') || name.includes('ç­‰çº§') || name.includes('çº§åˆ«') || name.includes('è¯„') || name.includes('level')) {
        return 'rating';
      }
      if (name.includes('ç›®æ ‡') || name.includes('å®Œæˆ') || name.includes('è¿›åº¦') || name.includes('å¯¹èµŒ') || name.includes('target')) {
        return 'target';
      }
      if (name.includes('å®¢æœ') || name.includes('é”€å”®') || name.includes('ç»ç†') || name.includes('æ‹æ¡£') || name.includes('æœåŠ¡')) {
        return 'team';
      }
      if (name.includes('è¡Œä¸š') || name.includes('åˆ†ç±»') || name.includes('ç±»ç›®') || name.includes('industry')) {
        return 'industry';
      }
      if (name.includes('æ—¶é—´') || name.includes('æ—¥æœŸ') || name.includes('å¹´') || name.includes('æœˆ') || name.includes('date')) {
        return 'time';
      }
      return 'general';
    }
    
    // æ£€æµ‹å­—æ®µç±»å‹
    function detectFieldType(fieldName) {
      const name = fieldName.toLowerCase();
      
      if (name.includes('gmv') || name.includes('é‡‘é¢') || name.includes('ä»·æ ¼') || name.includes('è´¹ç”¨')) {
        return 'currency';
      }
      if (name.includes('æ˜Ÿ') || name.includes('ç­‰çº§') || name.includes('åˆ†') || name.includes('è¯„åˆ†')) {
        return 'rating';
      }
      if (name.includes('ç‡') || name.includes('percent') || name.includes('%')) {
        return 'percentage';
      }
      if (name.includes('æ•°é‡') || name.includes('ä¸ªæ•°') || name.includes('count')) {
        return 'number';
      }
      if (name.includes('æ˜¯å¦') || name.includes('bool')) {
        return 'boolean';
      }
      return 'text';
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºèµ„æºå­—æ®µ
    function isResourceField(fieldName) {
      const name = fieldName.toLowerCase();
      const resourceKeywords = [
        'èµ„æº', 'æƒç›Š', 'è®¡åˆ’', 'é¢„æµ‹', 'æ‘˜æ˜Ÿ', 'å€å¢', 'ä¿±ä¹éƒ¨', 'å¤è´­',
        'æŒ‘æˆ˜', 'å¯¹èµŒ', 'ç­¾çº¦', 'é’»äº«', 'tad', 'ç™½åå•', 'ç§¯åˆ†', 'hotpicks',
        'æ¦œå•', 'å·¥å‚æ¦œ', 'ä¼˜å“æ¦œ', 'acp', 'é—¨æ§›', 'æ’å'
      ];
      
      return resourceKeywords.some(keyword => name.includes(keyword)) ||
             (name.includes('æ˜¯å¦') && resourceKeywords.some(keyword => name.includes(keyword)));
    }
    
    // æ‰¾åˆ°æœ€ä½³åŒ¹é…å­—æ®µ
    function findBestMatch(headers, keywords) {
      for (const keyword of keywords) {
        const index = headers.findIndex(h => 
          h.toLowerCase().includes(keyword.toLowerCase())
        );
        if (index !== -1) return index;
      }
      return -1;
    }
    
    // æŸ¥æ‰¾å­—æ®µç´¢å¼• - ä¿®å¤å­—æ®µè¯†åˆ«é—®é¢˜
    function findFieldIndex(headers, aliases) {
      for (const alias of aliases) {
        const index = headers.findIndex(h => {
          const headerLower = h.toLowerCase();
          const aliasLower = alias.toLowerCase();
          return headerLower.includes(aliasLower) || aliasLower.includes(headerLower);
        });
        if (index !== -1) {
          console.log(`æ‰¾åˆ°å­—æ®µåŒ¹é…: "${headers[index]}" åŒ¹é…åˆ° "${alias}" (ç´¢å¼•: ${index})`);
          return index;
        }
      }
      return -1;
    }
    
    // åŠ¨æ€å¤„ç†å®¢æˆ·æ•°æ® - å¤„ç†æ‰€æœ‰å­—æ®µï¼Œä¸é™åˆ¶ç‰¹å®šç»“æ„
    function processCustomerRow(row, fieldMap, rowNumber) {
      console.log(`å¤„ç†ç¬¬ ${rowNumber + 1} è¡Œæ•°æ®`);
      const customer = {
        allData: {},  // å­˜å‚¨æ‰€æœ‰åŸå§‹æ•°æ®
        displayData: {},  // å­˜å‚¨æ ¼å¼åŒ–åçš„æ˜¾ç¤ºæ•°æ®
        resources: []  // èµ„æºæ•°æ®
      };
      
      // å¤„ç†æ‰€æœ‰å­—æ®µæ•°æ®
      fieldMap.allFields.forEach((fieldInfo, index) => {
        const rawValue = row[fieldInfo.index];
        const fieldName = fieldInfo.name;
        
        // å­˜å‚¨åŸå§‹æ•°æ®
        customer.allData[fieldName] = rawValue;
        
        // æ ¹æ®å­—æ®µç±»å‹æ ¼å¼åŒ–æ•°æ®
        customer.displayData[fieldName] = formatFieldValue(rawValue, fieldInfo.type);
        
        // å¤„ç†å…³é”®å­—æ®µ
        if (fieldInfo.isKey) {
          customer[fieldInfo.keyType] = String(rawValue || '').trim();
        }
      });
      
      // å¤„ç†èµ„æºå­—æ®µ
      fieldMap.resources.forEach(resourceIndex => {
        const fieldInfo = fieldMap.allFields.find(f => f.index === resourceIndex);
        const resourceValue = String(row[resourceIndex] || '').trim();
        
        if (resourceValue && resourceValue !== '0' && 
            resourceValue.toLowerCase() !== 'false' && 
            resourceValue !== '-' && resourceValue !== 'æ— ') {
          customer.resources.push({
            name: fieldInfo.name,
            value: resourceValue,
            displayValue: formatFieldValue(resourceValue, fieldInfo.type)
          });
        }
      });
      
      // ç¡®ä¿å¿…è¦çš„å­—æ®µ
      if (!customer.customer_name) {
        const firstNameField = fieldMap.allFields.find(f => 
          f.name.toLowerCase().includes('åç§°') || 
          f.name.toLowerCase().includes('name')
        );
        if (firstNameField) {
          customer.customer_name = String(row[firstNameField.index] || `å®¢æˆ·${rowNumber + 1}`).trim();
        } else {
          customer.customer_name = `å®¢æˆ·${rowNumber + 1}`;
        }
      }
      
      if (!customer.shop_id) {
        customer.shop_id = `customer_${rowNumber + 1}`;
      }
      
      // ç”Ÿæˆå”¯ä¸€ID
      customer.id = `${customer.customer_name}_${customer.shop_id}_${Date.now()}_${rowNumber}`;
      
      // ä¿æŒå‘åå…¼å®¹ï¼Œè®¾ç½®ä¸€äº›é»˜è®¤å€¼
      customer.star_current = parseStarRating(customer.star_current);
      customer.star_predicted = parseStarRating(customer.star_predicted);
      customer.trend = calculateTrend(customer.star_current, customer.star_predicted);
      
      console.log(`å®¢æˆ· "${customer.customer_name}" æ•°æ®å¤„ç†å®Œæˆï¼Œå…± ${Object.keys(customer.allData).length} ä¸ªå­—æ®µï¼Œ${customer.resources.length} ä¸ªèµ„æº`);
      
      return customer;
    }
    
    // æ ¼å¼åŒ–å­—æ®µå€¼
    function formatFieldValue(value, type) {
      if (value === null || value === undefined || value === '') {
        return '';
      }
      
      const strValue = String(value).trim();
      
      switch (type) {
        case 'currency':
          const numValue = parseFloat(strValue.replace(/[^0-9.-]/g, ''));
          return isNaN(numValue) ? strValue : formatCurrency(numValue);
          
        case 'rating':
          const rating = parseInt(strValue);
          return isNaN(rating) ? strValue : `${rating}æ˜Ÿ`;
          
        case 'percentage':
          if (strValue.includes('%')) return strValue;
          const percent = parseFloat(strValue);
          return isNaN(percent) ? strValue : `${percent}%`;
          
        case 'number':
          const num = parseFloat(strValue);
          return isNaN(num) ? strValue : num.toLocaleString();
          
        case 'boolean':
          if (strValue === '1' || strValue.toLowerCase() === 'true' || strValue === 'æ˜¯') return 'æ˜¯';
          if (strValue === '0' || strValue.toLowerCase() === 'false' || strValue === 'å¦') return 'å¦';
          return strValue;
          
        default:
          return strValue;
      }
    }
    
    // è§£ææ˜Ÿçº§
    function parseStarRating(value) {
      if (value === undefined || value === null || value === '') return 0;
      const num = parseInt(value);
      return isNaN(num) ? 0 : Math.max(0, Math.min(5, num));
    }
    
    // è§£æ GMV
    function parseGMV(value) {
      if (value === undefined || value === null || value === '') return 0;
      
      const str = String(value).replace(/[Â¥$,\s]/g, '');
      const num = parseFloat(str);
      return isNaN(num) ? 0 : num;
    }
    
    // è®¡ç®—è¶‹åŠ¿
    function calculateTrend(current, predicted) {
      if (predicted > current) return 'up';
      if (predicted < current) return 'down';
      return 'same';
    }
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(text, type = 'success') {
      $('statusText').textContent = text;
      $('dataStatus').className = `status ${type}`;
    }
    
    // æ›´æ–° UI
    function updateUI() {
      updateTable();
      updateEmptyState();
      updateClearButton();
      updateCounts();
    }
    
    // æ›´æ–°è¡¨æ ¼ - åŠ¨æ€æ˜¾ç¤ºæ‰€æœ‰å­—æ®µ
    function updateTable() {
      if (appState.filteredCustomers.length === 0) {
        $('dataTable').style.display = 'none';
        return;
      }
      
      $('dataTable').style.display = 'table';
      $('emptyState').style.display = 'none';
      
      // æ›´æ–°è¡¨å¤´
      updateTableHeader();
      
      // æ›´æ–°è¡¨ä½“
      const tbody = $('tableBody');
      tbody.innerHTML = '';
      
      appState.filteredCustomers.forEach((customer, index) => {
        const tr = document.createElement('tr');
        tr.addEventListener('click', () => showCustomerCard(customer));
        
        // åŸºæœ¬ä¿¡æ¯åˆ—
        tr.innerHTML = generateTableRowHTML(customer);
        
        tbody.appendChild(tr);
      });
    }
    
    // æ›´æ–°è¡¨å¤´
    function updateTableHeader() {
      const thead = $('tableHead');
      if (!thead) {
        // å¦‚æœæ²¡æœ‰è¡¨å¤´å…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª
        const table = $('dataTable');
        const newThead = document.createElement('thead');
        newThead.id = 'tableHead';
        table.insertBefore(newThead, table.firstChild);
      }
      
      const headerRow = document.createElement('tr');
      
      // åŸºæœ¬åˆ—
      headerRow.innerHTML = `
        <th>å®¢æˆ·åç§°</th>
        <th>ID</th>
        <th>å­—æ®µæ•°</th>
        <th>èµ„æºæ•°</th>
        <th>æ“ä½œ</th>
      `;
      
      $('tableHead').innerHTML = '';
      $('tableHead').appendChild(headerRow);
    }
    
    // ç”Ÿæˆè¡¨æ ¼è¡Œ HTML
    function generateTableRowHTML(customer) {
      const fieldCount = Object.keys(customer.allData || {}).length;
      const resourceCount = (customer.resources || []).length;
      
      return `
        <td class="customer-name-cell">
          <div class="customer-name">${customer.customer_name || 'æœªçŸ¥å®¢æˆ·'}</div>
          <div class="customer-preview">${getCustomerPreview(customer)}</div>
        </td>
        <td class="id-cell">${customer.shop_id || 'N/A'}</td>
        <td class="count-cell">
          <span class="field-badge">${fieldCount} å­—æ®µ</span>
        </td>
        <td class="count-cell">
          <span class="resource-badge">${resourceCount} èµ„æº</span>
        </td>
        <td class="action-cell">
          <button class="btn-view" onclick="event.stopPropagation(); showCustomerCard(arguments[0])" data-customer='${JSON.stringify(customer).replace(/'/g, "&apos;")}'>æŸ¥çœ‹è¯¦æƒ…</button>
        </td>
      `;
    }
    
    // è·å–å®¢æˆ·é¢„è§ˆä¿¡æ¯
    function getCustomerPreview(customer) {
      const allData = customer.allData || {};
      const previewFields = [];
      
      // ä¼˜å…ˆæ˜¾ç¤ºé‡è¦å­—æ®µ
      const importantKeywords = ['gmv', 'é”€å”®', 'è¥ä¸š', 'æ˜Ÿ', 'ç­‰çº§', 'ç›®æ ‡'];
      
      Object.entries(allData).forEach(([key, value]) => {
        if (value && value !== '' && value !== '-' && previewFields.length < 3) {
          const isImportant = importantKeywords.some(keyword => 
            key.toLowerCase().includes(keyword)
          );
          if (isImportant) {
            previewFields.unshift(`${key}: ${value}`);
          } else if (previewFields.length < 2) {
            previewFields.push(`${key}: ${value}`);
          }
        }
      });
      
      return previewFields.slice(0, 2).join(' | ') || 'æ— é¢„è§ˆä¿¡æ¯';
    }
    
    // æ¸²æŸ“æ˜Ÿçº§
    function renderStars(count, predicted = false) {
      let html = '';
      for (let i = 1; i <= 5; i++) {
        if (i <= count) {
          html += predicted ? 
            '<span class="star predicted">â˜…</span>' : 
            '<span class="star filled">â˜…</span>';
        } else {
          html += '<span class="star">â˜†</span>';
        }
      }
      return html;
    }
    
    // æ¸²æŸ“èµ„æºæ ‡ç­¾ï¼ˆä¼˜åŒ–æ˜¾ç¤ºï¼‰
    function renderResourceTags(resources) {
      if (!resources || resources.length === 0) return 'æš‚æ— èµ„æº';
      
      return resources.slice(0, 2).map(resource => {
        const type = getResourceType(resource);
        return `<span class="resource-tag ${type}">${resource}</span>`;
      }).join(' ') + (resources.length > 2 ? ` +${resources.length - 2}` : '');
    }
    
    // åˆ¤æ–­èµ„æºç±»å‹
    function getResourceType(resource) {
      const str = resource.toLowerCase();
      if (str.includes('æ¨è') || str.includes('ç„¦ç‚¹') || str.includes('é¦–é¡µ') || str.includes('ä¿ƒé”€') || str.includes('æ´»åŠ¨')) {
        return 'promotion';
      } else if (str.includes('ç›´æ’­') || str.includes('å†…å®¹') || str.includes('å‘å¸ƒ') || str.includes('ç§è‰') || str.includes('è¥é”€')) {
        return 'content';
      } else if (str.includes('æ”¯æŒ') || str.includes('åŸºç¡€') || str.includes('æ‰¶æŒ') || str.includes('ä½“éªŒ')) {
        return 'support';
      }
      return '';
    }
    
    // æ ¼å¼åŒ–è´§å¸ï¼ˆåªæ”¯æŒç¾å…ƒï¼‰
    function formatCurrency(amount) {
      return `$${amount.toLocaleString()}`;
    }
    
    // ç”ŸæˆGMVè¶‹åŠ¿æ–‡æœ¬
    function generateGMVTrend(currentGMV) {
      // æ¨¡æ‹Ÿä¸Šæœˆæ•°æ®ï¼ˆå®é™…ä½¿ç”¨ä¸­å¯ä»æ•°æ®åº“è·å–ï¼‰
      const lastMonthGMV = currentGMV * (0.75 + Math.random() * 0.5); // éšæœºç”Ÿæˆä¸Šæœˆæ•°æ®
      const growth = ((currentGMV - lastMonthGMV) / lastMonthGMV * 100).toFixed(1);
      
      if (growth > 5) {
        return `ğŸ“ˆ è¾ƒä¸Šæœˆå¢é•¿ ${growth}%`;
      } else if (growth < -5) {
        return `ğŸ“‰ è¾ƒä¸Šæœˆä¸‹é™ ${Math.abs(growth)}%`;
      } else {
        return `ğŸ“€ è¾ƒä¸ŠæœˆåŸºæœ¬æŒå¹³ (${growth > 0 ? '+' : ''}${growth}%)`;
      }
    }
    
    // æ˜¾ç¤ºå®¢æˆ·å¡ç‰‡ - é‡æ–°è®¾è®¡ä»¥æ”¯æŒæ–°å­—æ®µ
    function showCustomerCard(customer) {
      appState.selectedCustomer = customer;
      
      // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.data-table tr.selected').forEach(tr => {
        tr.classList.remove('selected');
      });
      
      // æ·»åŠ é€‰ä¸­çŠ¶æ€åˆ°å½“å‰è¡Œ
      if (event && event.target) {
        event.target.closest('tr').classList.add('selected');
      }
      
      // ç”Ÿæˆå¡ç‰‡HTML
      const cardHtml = generateCustomerCardHTML(customer);
      
      // æ›´æ–°å¡ç‰‡å†…å®¹
      const cardContainer = $('cardContent');
      cardContainer.innerHTML = cardHtml;
      
      // æ˜¾ç¤ºå¡ç‰‡
      $('infoCard').querySelector('.empty-state').style.display = 'none';
      cardContainer.style.display = 'block';
      
      // å“åº”å¼å¤„ç†
      if (window.innerWidth <= 1024) {
        $('infoCard').classList.add('open');
      }
    }
    
    // åŠ¨æ€ç”Ÿæˆå®¢æˆ·ä¿¡æ¯å¡HTML - æ ¹æ®å®é™…æ•°æ®ç»“æ„ç”Ÿæˆ
    function generateCustomerCardHTML(customer) {
      const resources = customer.resources || [];
      const allData = customer.allData || {};
      const displayData = customer.displayData || {};
      
      // æŒ‰ç±»åˆ«åˆ†ç»„å­—æ®µ
      const fieldsByCategory = groupFieldsByCategory(allData, appState.fieldMap);
      
      return `
        <div class="card-content">
          <div class="card-header">
            <div class="customer-basic">
              <h2 class="customer-name">${customer.customer_name || 'æœªçŸ¥å®¢æˆ·'}</h2>
              <div class="customer-id">${getIdFieldDisplay(customer, allData)}</div>
            </div>
            <div class="customer-stats">
              <div class="field-count">å­—æ®µæ•°: ${Object.keys(allData).length}</div>
              <div class="resource-count">èµ„æºæ•°: ${resources.length}</div>
            </div>
          </div>

          <div class="card-body">
            ${generateFieldSections(fieldsByCategory, displayData)}
            
            ${resources.length > 0 ? `
            <div class="resources-section">
              <h3>ğŸ èµ„æºä¿¡æ¯</h3>
              <div class="resources-grid">
                ${resources.map(resource => `
                  <div class="resource-tag ${getResourceType(resource.name)}">
                    <span class="icon">${getResourceIcon(resource.name)}</span>
                    <div class="resource-content">
                      <div class="resource-name">${resource.name}</div>
                      <div class="resource-value">${resource.displayValue || resource.value}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>` : ''}
          </div>

          <div class="card-footer">
            <div class="generation-time">ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}</div>
            <div class="data-source">æ•°æ®æ¥æº: å®¢æˆ·ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</div>
          </div>
        </div>
      `;
    }
    
    // æŒ‰ç±»åˆ«åˆ†ç»„å­—æ®µ
    function groupFieldsByCategory(allData, fieldMap) {
      const categories = {
        basic: { title: 'ğŸ’¼ åŸºæœ¬ä¿¡æ¯', fields: [] },
        financial: { title: 'ğŸ’° è´¢åŠ¡æ•°æ®', fields: [] },
        rating: { title: 'â­ è¯„çº§ä¿¡æ¯', fields: [] },
        target: { title: 'ğŸ¯ ç›®æ ‡è¿›åº¦', fields: [] },
        team: { title: 'ğŸ‘¥ å›¢é˜Ÿä¿¡æ¯', fields: [] },
        industry: { title: 'ğŸ¢ è¡Œä¸šä¿¡æ¯', fields: [] },
        time: { title: 'ğŸ•°ï¸ æ—¶é—´ä¿¡æ¯', fields: [] },
        general: { title: 'ğŸ“Š å…¶ä»–ä¿¡æ¯', fields: [] }
      };
      
      Object.keys(allData).forEach(fieldName => {
        const fieldInfo = fieldMap.allFields.find(f => f.name === fieldName);
        const category = fieldInfo ? fieldInfo.category : 'general';
        
        // è·³è¿‡ç©ºå€¼å’Œå…³é”®å­—æ®µï¼ˆå·²åœ¨å¤´éƒ¨æ˜¾ç¤ºï¼‰
        if (allData[fieldName] && 
            (!fieldInfo || !fieldInfo.isKey) &&
            allData[fieldName] !== '' && 
            allData[fieldName] !== '-' && 
            allData[fieldName] !== '0') {
          categories[category].fields.push({
            name: fieldName,
            value: allData[fieldName],
            type: fieldInfo ? fieldInfo.type : 'text'
          });
        }
      });
      
      // è¿‡æ»¤ç©ºç±»åˆ«
      Object.keys(categories).forEach(key => {
        if (categories[key].fields.length === 0) {
          delete categories[key];
        }
      });
      
      return categories;
    }
    
    // ç”Ÿæˆå­—æ®µåŒºå—
    function generateFieldSections(fieldsByCategory, displayData) {
      return Object.entries(fieldsByCategory).map(([category, categoryInfo]) => {
        if (categoryInfo.fields.length === 0) return '';
        
        return `
          <div class="metric-section ${category}-section">
            <h3>${categoryInfo.title}</h3>
            ${categoryInfo.fields.map(field => {
              const displayValue = displayData[field.name] || field.value;
              const isHighlight = isHighlightField(field.name, field.value);
              
              return `
                <div class="metric-row ${isHighlight ? 'highlight' : ''}">
                  <span class="label">${field.name}</span>
                  <span class="value ${getValueClass(field.type)}">${displayValue}</span>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }).join('');
    }
    
    // è·å–IDå­—æ®µæ˜¾ç¤º
    function getIdFieldDisplay(customer, allData) {
      if (customer.shop_id && customer.shop_id !== customer.customer_name) {
        return `ID: ${customer.shop_id}`;
      }
      
      // æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„IDå­—æ®µ
      const idFields = Object.keys(allData).filter(key => 
        key.toLowerCase().includes('id') || 
        key.toLowerCase().includes('ç¼–å·')
      );
      
      if (idFields.length > 0) {
        return `${idFields[0]}: ${allData[idFields[0]]}`;
      }
      
      return 'ç³»ç»Ÿè‡ªåŠ¨ç”ŸæˆID';
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºé‡ç‚¹å­—æ®µ
    function isHighlightField(fieldName, value) {
      const name = fieldName.toLowerCase();
      return name.includes('gmv') || 
             name.includes('é”€å”®') || 
             name.includes('è¥ä¸š') || 
             name.includes('æ˜Ÿ') || 
             name.includes('ç­‰çº§') ||
             name.includes('ç›®æ ‡') ||
             (name.includes('å®Œæˆ') && String(value).includes('%'));
    }
    
    // è·å–å€¼çš„CSSç±»å
    function getValueClass(type) {
      switch (type) {
        case 'currency': return 'currency-value';
        case 'rating': return 'rating-value';
        case 'percentage': return 'percentage-value';
        case 'number': return 'number-value';
        case 'boolean': return 'boolean-value';
        default: return 'text-value';
      }
    }
    
    // å…³é—­ä¿¡æ¯å¡
    function closeInfoCard() {
      $('infoCard').querySelector('.empty-state').style.display = 'flex';
      $('cardContent').style.display = 'none';
      $('infoCard').classList.remove('open');
      
      // ç§»é™¤é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.data-table tr.selected').forEach(tr => {
        tr.classList.remove('selected');
      });
      
      appState.selectedCustomer = null;
    }
    
    // æ›´æ–°ç©ºçŠ¶æ€
    function updateEmptyState() {
      if (appState.customers.length === 0) {
        $('emptyState').style.display = 'flex';
        $('dataTable').style.display = 'none';
      }
    }
    
    // æ›´æ–°æ¸…ç©ºæŒ‰é’®
    function updateClearButton() {
      $('clearBtn').style.display = appState.customers.length > 0 ? 'block' : 'none';
    }
    
    // æ›´æ–°è®¡æ•°
    function updateCounts() {
      $('totalCount').textContent = appState.customers.length;
      $('filteredCount').textContent = appState.filteredCustomers.length;
    }
    
    // è¿‡æ»¤å¤„ç†
    function handleFilter() {
      const search = $('searchInput').value.toLowerCase().trim();
      const starFilter = $('starFilter').value;
      const trendFilter = $('trendFilter').value;
      
      appState.filteredCustomers = appState.customers.filter(customer => {
        // æœç´¢è¿‡æ»¤
        const matchSearch = !search || 
          customer.customer_name.toLowerCase().includes(search) ||
          customer.shop_id.toLowerCase().includes(search);
        
        // æ˜Ÿçº§è¿‡æ»¤
        const matchStar = !starFilter || customer.star_current.toString() === starFilter;
        
        // è¶‹åŠ¿è¿‡æ»¤
        const matchTrend = !trendFilter || customer.trend === trendFilter;
        
        return matchSearch && matchStar && matchTrend;
      });
      
      updateTable();
      updateCounts();
    }
    
    // æ’åºå¤„ç†
    function handleSort(field) {
      if (appState.sortBy === field) {
        appState.sortOrder = appState.sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        appState.sortBy = field;
        appState.sortOrder = 'desc';
      }
      
      appState.filteredCustomers.sort((a, b) => {
        let aVal = a[field];
        let bVal = b[field];
        
        // æ•°å­—ç±»å‹æ’åº
        if (field === 'gmv_month' || field === 'star_current' || field === 'star_predicted') {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        } else {
          // å­—ç¬¦ä¸²æ’åº
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }
        
        if (aVal < bVal) return appState.sortOrder === 'asc' ? -1 : 1;
        if (aVal > bVal) return appState.sortOrder === 'asc' ? 1 : -1;
        return 0;
      });
      
      updateTable();
    }
    
    // ä¸‹è½½æ¨¡æ¿ï¼ˆæ ¹æ®å®é™…æ•°æ®ç»“æ„è°ƒæ•´ï¼‰
    function downloadTemplate() {
      console.log('å¼€å§‹ä¸‹è½½æ¨¡æ¿...');
      
      try {
        const template = [
          ['å›½é™…ç«™ID', 'å®¢æˆ·åç§°', 'è¯„å®šæ˜Ÿç­‰çº§', 'å½“å‰é¢„æµ‹æ˜Ÿç­‰çº§', 'æœ¬æœˆå®æ”¶GMV', 'æ‘˜æ˜Ÿè®¡åˆ’æƒç›Šé¢„æµ‹', 'äº¤æ˜“å€å¢ä¿±ä¹éƒ¨æƒç›Šé¢„æµ‹', 'é’»äº«è®¡åˆ’æƒç›Šé¢„æµ‹', 'é’»äº«å­£åº¦èµ„æºé¢„ä¼°', 'é’»äº«æœˆåº¦èµ„æºé¢„ä¼°'],
          ['customer001', 'å®¢æˆ·001', '2', '2', '8720', '-', 'æ— èµ„æº', '-', '-', '-'],
          ['customer002', 'å®¢æˆ·002', '4', '4', '0', 'å¤§æµ·æ™¯+ä¼˜å“', 'æ— èµ„æº', '-', '-', '-'],
          ['customer003', 'å®¢æˆ·003', '1', '1', '141', '-', 'æ— èµ„æº', '-', '-', '-'],
          ['customer004', 'å®¢æˆ·004', '5', '5', '373039', 'å¤§æµ·æ™¯+ä¼˜å“', 'å¤§æµ·æ™¯èµ„æºå’Œä¼˜å“', 'é’»äº«å±¥çº¦æƒç›Š', 'å¤§ä¿ƒæ¦œå•', 'é’»äº«å±¥çº¦æƒç›Š'],
          ['customer005', 'å®¢æˆ·005', '5', '5', '937158', 'å¤§æµ·æ™¯+ä¼˜å“', 'å¤§æµ·æ™¯èµ„æºå’Œä¼˜å“', 'é’»äº«å±¥çº¦æƒç›Š', 'å¤§ä¿ƒæ¦œå•', 'é’»äº«å±¥çº¦æƒç›Š'],
          ['customer006', 'å®¢æˆ·006', '4', '4', '67844', 'å¤§æµ·æ™¯+ä¼˜å“', 'å°æµ·æ™¯èµ„æºå’Œä¼˜å“', '-', '-', '-'],
          ['customer007', 'å®¢æˆ·007', '3', '3', '11588', 'å¤§æµ·æ™¯+ä¼˜å“', 'æ— èµ„æº', '-', '-', '-'],
          ['customer008', 'å®¢æˆ·008', '3', '3', '17626', 'å¤§æµ·æ™¯+ä¼˜å“', 'æ— èµ„æº', '-', '-', '-']
        ];
        
        console.log('æ¨¡æ¿æ•°æ®å‡†å¤‡å®Œæˆ:', template);
        
        const csv = template.map(row => 
          row.map(cell => '"' + String(cell).replace(/"/g, '""') + '"').join(',')
        ).join('\n');
        
        console.log('CSVæ•°æ®ç”Ÿæˆå®Œæˆ');
        
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        console.log('Blob URLåˆ›å»ºå®Œæˆ:', url);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'å®¢æˆ·ä¿¡æ¯å¯¼å…¥æ¨¡æ¿.csv';
        a.style.display = 'none';
        document.body.appendChild(a);
        
        console.log('å¼€å§‹ä¸‹è½½...');
        a.click();
        
        // æ¸…ç†
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          console.log('æ¸…ç†å®Œæˆ');
        }, 100);
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        setTimeout(() => {
          alert('ğŸ“‹ æ¨¡æ¿ä¸‹è½½æˆåŠŸï¼\n\nğŸ“Œ ä½¿ç”¨è¯´æ˜ï¼š\n1. å¿…å¡«å­—æ®µï¼šå›½é™…ç«™IDã€å®¢æˆ·åç§°\n2. æ˜Ÿçº§èŒƒå›´ï¼š0-5ï¼ˆæ”¯æŒé¢„æµ‹å˜åŒ–ï¼‰\n3. GMVè¾“å…¥æ•°å­—ï¼ˆç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨ç¾å…ƒæ ¼å¼ï¼‰\n4. æƒç›Šèµ„æºåˆ—å¯ç•™ç©ºï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«\n5. æ¨¡æ¿åŒ…å«çœŸå®å®¢æˆ·æ¡ˆä¾‹ä¾›å‚è€ƒ\n\nğŸ’¡ æ”¯æŒå­—æ®µï¼šè¯„å®šæ˜Ÿç­‰çº§ã€é¢„æµ‹æ˜Ÿç­‰çº§ã€æœ¬æœˆå®æ”¶GMVç­‰');
        }, 200);
        
      } catch (error) {
        console.error('ä¸‹è½½æ¨¡æ¿é”™è¯¯:', error);
        alert('ä¸‹è½½æ¨¡æ¿å¤±è´¥: ' + error.message);
      }
    }
    
    // æ¸…ç©ºæ•°æ®
    function clearData() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        appState.customers = [];
        appState.filteredCustomers = [];
        closeInfoCard();
        updateStatus('å·²æ¸…ç©ºæ•°æ®', 'warning');
        updateUI();
      }
    }
    
    // å¤åˆ¶ä¸ºå›¾ç‰‡
    async function copyAsImage() {
      if (!appState.selectedCustomer) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®¢æˆ·');
        return;
      }
      
      try {
        const card = $('cardContent');
        if (typeof html2canvas === 'undefined') {
          alert('æˆªå›¾åŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          return;
        }
        
        updateStatus('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...', 'warning');
        
        const canvas = await html2canvas(card, {
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true,
          allowTaint: true,
          foreignObjectRendering: false
        });
        
        canvas.toBlob(async (blob) => {
          try {
            // å°è¯•å†™å…¥å‰ªè´´æ¿
            if (navigator.clipboard && window.ClipboardItem) {
              await navigator.clipboard.write([
                new ClipboardItem({ 'image/png': blob })
              ]);
              updateStatus('å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
              alert('âœ… å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nå¯åœ¨å¾®ä¿¡èŠå¤©çª—å£ç›´æ¥ Ctrl+V ç²˜è´´å‘é€');
            } else {
              throw new Error('æµè§ˆå™¨ä¸æ”¯æŒå‰ªè´´æ¿å›¾ç‰‡');
            }
          } catch (e) {
            // é™çº§ï¼šè‡ªåŠ¨ä¸‹è½½
            downloadBlob(blob, `${appState.selectedCustomer.customer_name}_ä¿¡æ¯å¡.png`);
            updateStatus('å·²ä¸‹è½½å›¾ç‰‡æ–‡ä»¶', 'success');
            alert('ğŸ“¥ å›¾ç‰‡å·²ä¸‹è½½åˆ°æœ¬åœ°ï¼\n\nè¯·åœ¨å¾®ä¿¡ä¸­é€‰æ‹©"å‘é€å›¾ç‰‡"åŠŸèƒ½ä¸Šä¼ ');
          }
        }, 'image/png');
        
      } catch (error) {
        updateStatus('ç”Ÿæˆå›¾ç‰‡å¤±è´¥', 'error');
        console.error('Copy image error:', error);
        alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥: ' + error.message);
      }
    }
    
    // å¤åˆ¶ä¸ºæ–‡æœ¬
    function copyAsText() {
      if (!appState.selectedCustomer) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®¢æˆ·');
        return;
      }
      
      const c = appState.selectedCustomer;
      const diff = c.star_predicted - c.star_current;
      const trendText = diff > 0 ? `ä¸Šå‡${diff}æ˜Ÿ` : diff < 0 ? `ä¸‹é™${Math.abs(diff)}æ˜Ÿ` : 'ä¿æŒä¸å˜';
      
      const text = `ğŸ“‹ å®¢æˆ·ä¿¡æ¯å¡\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘¤ å®¢æˆ·åç§°ï¼š${c.customer_name}\nğŸª å›½é™…ç«™IDï¼š${c.shop_id}\nâ­ è¯„å®šæ˜Ÿç­‰çº§ï¼š${c.star_current}æ˜Ÿ\nğŸ”® é¢„æµ‹æ˜Ÿç­‰çº§ï¼š${c.star_predicted}æ˜Ÿ (${trendText})\nğŸ’° æœ¬æœˆå®æ”¶GMVï¼š$${c.gmv_month.toLocaleString()}\nğŸ“¦ æƒç›Šèµ„æºï¼š${c.resources.length > 0 ? c.resources.join('ã€') : 'æš‚æ— '}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¼ å®¢æˆ·ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ`;
      
      navigator.clipboard.writeText(text).then(() => {
        updateStatus('æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        alert('âœ… æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nå¯ç›´æ¥ç²˜è´´åˆ°å¾®ä¿¡ã€é‚®ä»¶ç­‰åº”ç”¨ä¸­');
      }).catch(() => {
        // é™çº§å¤„ç†
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        updateStatus('æ–‡æœ¬å·²å¤åˆ¶', 'success');
        alert('âœ… æ–‡æœ¬å·²å¤åˆ¶ï¼');
      });
    }
    
    // ä¸‹è½½PNG
    async function downloadPNG() {
      if (!appState.selectedCustomer) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå®¢æˆ·');
        return;
      }
      
      try {
        const card = $('cardContent');
        if (typeof html2canvas === 'undefined') {
          alert('æˆªå›¾åŠŸèƒ½æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          return;
        }
        
        updateStatus('æ­£åœ¨ç”ŸæˆPNG...', 'warning');
        
        const canvas = await html2canvas(card, {
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true
        });
        
        canvas.toBlob((blob) => {
          downloadBlob(blob, `${appState.selectedCustomer.customer_name}_ä¿¡æ¯å¡.png`);
          updateStatus('PNGä¸‹è½½å®Œæˆ', 'success');
        }, 'image/png');
        
      } catch (error) {
        updateStatus('ä¸‹è½½å¤±è´¥', 'error');
        console.error('Download PNG error:', error);
        alert('ä¸‹è½½å¤±è´¥: ' + error.message);
      }
    }
    
    // ä¸‹è½½Blobæ–‡ä»¶
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // åŠ è½½æ¼”ç¤ºæ•°æ®ï¼ˆæ ¹æ®å®é™…æ•°æ®ç»“æ„è°ƒæ•´ï¼‰
    function loadSampleData() {
      const sampleData = [
        {
          customer_name: 'å®¢æˆ·001',
          shop_id: 'customer001',
          star_current: 2,
          star_predicted: 2,
          gmv_month: 8720,
          resources: ['æ— èµ„æº'],
          trend: 'same',
          id: 'sample_1'
        },
        {
          customer_name: 'å®¢æˆ·002',
          shop_id: 'customer002',
          star_current: 4,
          star_predicted: 4,
          gmv_month: 0,
          resources: ['å¤§æµ·æ™¯+ä¼˜å“', 'æ— èµ„æº'],
          trend: 'same',
          id: 'sample_2'
        },
        {
          customer_name: 'å®¢æˆ·003',
          shop_id: 'customer003',
          star_current: 1,
          star_predicted: 1,
          gmv_month: 141,
          resources: ['æ— èµ„æº'],
          trend: 'same',
          id: 'sample_3'
        },
        {
          customer_name: 'å®¢æˆ·004',
          shop_id: 'customer004',
          star_current: 3,
          star_predicted: 3,
          gmv_month: 3170,
          resources: ['å¤§æµ·æ™¯+ä¼˜å“', 'æ— èµ„æº'],
          trend: 'same',
          id: 'sample_4'
        },
        {
          customer_name: 'å®¢æˆ·005',
          shop_id: 'customer005',
          star_current: 5,
          star_predicted: 5,
          gmv_month: 373039,
          resources: ['å¤§æµ·æ™¯+ä¼˜å“', 'å¤§æµ·æ™¯èµ„æºå’Œä¼˜å“', 'é’»äº«å±¥çº¦æƒç›Š', 'å¤§ä¿ƒæ¦œå•'],
          trend: 'same',
          id: 'sample_5'
        },
        {
          customer_name: 'å®¢æˆ·006',
          shop_id: 'customer006',
          star_current: 5,
          star_predicted: 5,
          gmv_month: 937158,
          resources: ['å¤§æµ·æ™¯+ä¼˜å“', 'å¤§æµ·æ™¯èµ„æºå’Œä¼˜å“', 'é’»äº«å±¥çº¦æƒç›Š', 'å¤§ä¿ƒæ¦œå•'],
          trend: 'same',
          id: 'sample_6'
        },
        {
          customer_name: 'å®¢æˆ·007',
          shop_id: 'customer007',
          star_current: 4,
          star_predicted: 4,
          gmv_month: 67844,
          resources: ['å¤§æµ·æ™¯+ä¼˜å“', 'å°æµ·æ™¯èµ„æºå’Œä¼˜å“'],
          trend: 'same',
          id: 'sample_7'
        },
        {
          customer_name: 'å®¢æˆ·008',
          shop_id: 'customer008',
          star_current: 3,
          star_predicted: 3,
          gmv_month: 11588,
          resources: ['å¤§æµ·æ™¯+ä¼˜å“', 'æ— èµ„æº'],
          trend: 'same',
          id: 'sample_8'
        }
      ];
      
      appState.customers = sampleData;
      appState.filteredCustomers = [...sampleData];
      
      updateStatus('å·²åŠ è½½8ä¸ªå®¢æˆ·æ¼”ç¤ºæ•°æ®', 'success');
      updateUI();
      
      // è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªå®¢æˆ·ä½œä¸ºç¤ºä¾‹
      setTimeout(() => {
        const firstRow = document.querySelector('.data-table tbody tr');
        if (firstRow) {
          firstRow.click();
        }
      }, 500);
    }
    
    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
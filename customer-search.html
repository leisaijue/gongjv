<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å®¢æˆ·ä¿¡æ¯æœç´¢å·¥å…· - å·¥å…·ä¸­å¿ƒ</title>
  <script>
    // èº«ä»½éªŒè¯æ£€æŸ¥
    const SESSION_KEY = 'toolcenter_auth';
    const REMEMBER_KEY = 'toolcenter_remember';
    
    function checkAuth() {
      const sessionAuth = sessionStorage.getItem(SESSION_KEY);
      const rememberAuth = localStorage.getItem(REMEMBER_KEY);
      
      if (sessionAuth === 'authenticated') {
        return true;
      }
      
      if (rememberAuth) {
        try {
          const authData = JSON.parse(rememberAuth);
          const expiryTime = new Date(authData.expiry);
          const now = new Date();
          
          if (now < expiryTime) {
            sessionStorage.setItem(SESSION_KEY, 'authenticated');
            return true;
          } else {
            localStorage.removeItem(REMEMBER_KEY);
          }
        } catch (e) {
          localStorage.removeItem(REMEMBER_KEY);
        }
      }
      
      return false;
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥èº«ä»½éªŒè¯
    if (!checkAuth()) {
      window.location.href = './login.html';
    }
  </script>
  <style>
    :root { --nav-h: 52px; --panel:#ffffff; --border:#e5e7eb; --text:#111827; --muted:#6b7280; --accent:#1b65ff; }
    body { margin:0; font:14px/1.45 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, 'PingFang SC','Hiragino Sans GB','Microsoft YaHei', sans-serif; color:var(--text); background:#fff; }
    .navbar { position: sticky; top: 0; z-index: 9999; background:#fff; border-bottom:1px solid var(--border); }
    .navbar .wrap { display:flex; align-items:center; gap:10px; padding:10px 16px; }
    .navbar .brand { font-weight:700; color:#111827; margin-right:6px; }
    .navbar a, .navbar .navlink { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border:1px solid var(--border); border-radius:10px; text-decoration:none; color:#374151; transition: all 0.2s ease; font-size: 14px; }
    .navbar a:hover, .navbar .navlink:hover { background: #f3f4f6; border-color: #d1d5db; transform: translateY(-1px); }
    .navbar a.active, .navbar .navlink.active { background:var(--accent); border-color:var(--accent); color:#fff; }
    header.pagehead { padding:12px 16px; border-bottom:1px solid var(--border); position:sticky; top:var(--nav-h); background:#fff; z-index:5; }
    header.pagehead h1 { margin:0 0 6px; font-size:18px; }
    .controls, .filters { display:flex; flex-wrap:wrap; gap:10px 12px; align-items:center; padding:10px 16px; }
    .controls .row { display:flex; gap:10px 12px; align-items:center; flex-wrap:wrap; }
    .btn { appearance:none; border:1px solid var(--border); background:#fff; color:#333; padding:8px 12px; border-radius:12px; cursor:pointer; transition:.15s; }
    .btn:hover { border-color:#cfcfcf; background:#f7f7f7; transform:translateY(-1px); }
    .btn.primary { background:#1b65ff; border-color:#1b65ff; color:#fff; }
    .btn.destructive { background:#d64545; border-color:#d64545; color:#fff; }
    label { font-size:12px; color:var(--muted); }
    input[type="text"], select { color:#111827; background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px 10px; outline:none; min-width:220px; }
    .status { font-size:12px; padding:2px 8px; border:1px solid var(--border); border-radius:999px; }
    .status.ok { color:#16a34a; border-color:#b7e4c7; background:#ecfdf5; }
    .status.warn { color:#b45309; border-color:#fcd34d; background:#fffbeb; }
    .status.err { color:#b91c1c; border-color:#fecaca; background:#fef2f2; }
    .colpicker { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px; padding:0 16px 10px; max-height:300px; overflow-y:auto; }
    .colchip { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:8px; padding:8px 12px; background:#f9fafb; transition:all 0.2s ease; cursor:pointer; }
    .colchip:hover { background:#f3f4f6; border-color:#d1d5db; transform:translateY(-1px); }
    .colchip.checked { background:#dbeafe; border-color:#3b82f6; }
    .colchip input[type="checkbox"] { margin:0; }
    .colchip .col-name { font-size:13px; font-weight:500; }
    .col-search-box { padding:0 16px 10px; }
    .col-search-input { width:100%; max-width:400px; margin-bottom:8px; }
    .col-categories { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
    .col-category-btn { padding:4px 12px; border:1px solid var(--border); border-radius:20px; background:#fff; cursor:pointer; font-size:12px; transition:all 0.2s; }
    .col-category-btn:hover { background:#f3f4f6; }
    .col-category-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .col-stats { font-size:12px; color:var(--muted); margin-top:8px; }
    .table-responsive { overflow-x:auto; }
    .table-responsive table { min-width:600px; }
    .tablewrap { padding:0 16px 24px; }
    table { width:100%; border-collapse:separate; border-spacing:0; }
    thead th { position:sticky; top:calc(var(--nav-h) + 144px); background:#fff; z-index:2; border-bottom:1px solid var(--border); padding:8px; font-weight:600; font-size:12px; color:#374151; text-align:left; cursor:pointer; }
    tbody td { border-bottom:1px solid #f1f5f9; padding:8px; font-size:13px; color:#111827; }
    tbody tr { cursor:pointer; }
    tbody tr:hover { background:#f3f6fb; }
    .drop { border:1px dashed var(--border); border-radius:10px; padding:8px 10px; color:var(--muted); margin:0 16px 8px 16px; }
    .drop.over { border-color:var(--accent); color:#111827; }
    .footer-tip { text-align:center; color:var(--muted); font-size:12px; padding:12px 0 24px; }
    .lightbox { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:20px; z-index:99999; }
    .lightbox.open { display:flex; }
    .lightbox .panel { background:#fff; border:1px solid var(--border); border-radius:16px; padding:16px; width:min(92vw,980px); color:#111827; }
    .report-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .report-title { font-size:18px; font-weight:700; }
    .report-grid { display:grid; grid-template-columns:160px 1fr; gap:6px 10px; }
    .report-grid label { color:#6b7280; text-align:right; font-weight:600; }
    .report-grid .val { background:#f9fafb; border:1px solid #e5e7eb; padding:6px 8px; border-radius:8px; }
    .report-toolbar { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  </style>

  <!-- Robust XLSX loader -->
  <script>
  (function(){
    var statusEl;
    function setStatus(txt, cls){
      if(!statusEl){ statusEl = document.getElementById('xlsxState') || document.getElementById('fileInfo'); }
      if(!statusEl) return;
      var isFileInfo = statusEl.id === 'fileInfo';
      statusEl.textContent = isFileInfo ? txt.replace(/^XLSX\s*/, '') : ('XLSX å¼•æ“ï¼š' + txt);
      statusEl.className = 'status ' + (isFileInfo ? (cls||'') : ('inline ' + (cls||'')));
    }
    if (typeof XLSX !== 'undefined'){ setStatus('å·²åŠ è½½','ok'); return; }
    var sources = [
      './xlsx.full.min.js',
      '/xlsx.full.min.js',
      (location && location.origin ? (location.origin + '/xlsx.full.min.js') : ''),
      'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js',
      'https://unpkg.com/xlsx/dist/xlsx.full.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
    ];
    var i = 0;
    function next(){
      if (typeof XLSX !== 'undefined'){ setStatus('å·²åŠ è½½','ok'); return; }
      if (i >= sources.length){ setStatus('æœªåŠ è½½ï¼ˆè¯·æŠŠ xlsx.full.min.js æ”¾åœ¨ä¸ HTML åŒç›®å½•ï¼‰','warn'); return; }
      var src = sources[i++];
      if(!src){ next(); return; }
      setStatus('åŠ è½½ä¸­â€¦ï¼ˆå°è¯•æºï¼š' + src + 'ï¼‰','warn');
      var s = document.createElement('script');
      s.src = src; s.async = true; s.crossOrigin = 'anonymous';
      var timer = setTimeout(function(){ s.onerror && s.onerror(); }, 10000);
      s.onload = function(){ clearTimeout(timer); if (typeof XLSX==='undefined'){ next(); } else { setStatus('å·²åŠ è½½','ok'); } };
      s.onerror = function(){ clearTimeout(timer); next(); };
      document.head.appendChild(s);
    }
    next();
  })();
  </script>
</head>
<body>
  <nav class="navbar"><div class="wrap">
    <div class="brand">ğŸ› ï¸ å·¥å…·ä¸­å¿ƒ</div>
    <a class="navlink" href="./index.html">é¦–é¡µ</a>
    <a class="navlink" href="./image-gallery.html">æ‰¹é‡å›¾ç‰‡å±•ç¤ºå™¨</a>
    <a class="navlink active" href="./customer-search.html" aria-current="page">å®¢æˆ·ä¿¡æ¯æœç´¢</a>
    <a class="navlink" href="./customer-card.html">å®¢æˆ·ä¿¡æ¯å¡ç”Ÿæˆå™¨</a>
    <a class="navlink" href="./script-editor.html">è¯æœ¯ç¼–è¾‘å™¨</a>
    <div style="flex:1"></div>
  </div></nav>

  <header class="pagehead">
    <h1>é¡µé¢äºŒï¼šå®¢æˆ·ä¿¡æ¯æœç´¢ï¼ˆç¨³å®šç‰ˆï¼‰</h1>
    <div class="status" id="xlsxState">XLSX å¼•æ“ï¼šåˆå§‹åŒ–</div>
  </header>

  <section class="controls">
    <div class="row">
      <button class="btn primary" id="btnImport">å¯¼å…¥è¡¨æ ¼æ–‡ä»¶ (XLSX/CSV/TSV)</button>
      <div id="fileInfo" class="status warn">æœªåŠ è½½æ•°æ®</div>
      <div style="margin-left:auto; display:inline-flex; gap:8px;">
        <label>æ¯é¡µ</label>
        <select id="pageSize"><option>20</option><option selected>50</option><option>100</option><option>200</option></select>
        <button class="btn" id="btnExport">å¯¼å‡ºç­›é€‰ç»“æœ (CSV)</button>
        <button class="btn destructive" id="btnClear">æ¸…ç©ºæ•°æ®</button>
      </div>
    </div>
    <div class="row">
      <label>å®¢æˆ·åç§°åˆ—</label>
      <select id="nameCol" style="min-width:220px"></select>
      <label>æœç´¢å®¢æˆ·åç§°</label>
      <input type="text" id="nameQ" placeholder="è¾“å…¥å®¢æˆ·åç§°å…³é”®è¯ï¼Œæ”¯æŒå¤šå…³é”®è¯ ç©ºæ ¼åˆ†éš”" style="min-width:360px" />
      <span style="color:#6b7280;font-size:12px;">å·²ç­›é€‰ï¼š<b id="countFiltered">0</b> / æ€»æ•°ï¼š<b id="countTotal">0</b></span>
    </div>
  </section>

  <div id="dropZone" class="drop">æ‹–æ‹½ Excel/CSV/TSV æ–‡ä»¶åˆ°æ­¤åŒºåŸŸå¯¼å…¥ï¼ˆæˆ–ç‚¹å‡»æ­¤åŒºåŸŸï¼‰</div>

  <section class="filters">
    <div style="padding:0 16px; display:flex; justify-content:space-between; align-items:center; width:100%;">
      <div>
        <label>é€‰æ‹©å±•ç¤ºçš„åˆ—</label>
        <div style="color:#6b7280;font-size:12px;">å‹¾é€‰/å–æ¶ˆåˆ—åï¼Œç«‹å³ç”Ÿæ•ˆï¼›æ”¯æŒæ’åºï¼ˆç‚¹å‡»è¡¨å¤´ï¼‰ã€‚</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="btnSelectAll">å…¨é€‰</button>
        <button class="btn" id="btnInvert">åé€‰</button>
        <button class="btn" id="btnDefaultCols">å¸¸ç”¨åˆ—</button>
        <button class="btn" id="btnToggleCollapse">æ”¶èµ·/å±•å¼€</button>
      </div>
    </div>
    
    <div class="col-search-box">
      <input type="text" id="colSearchInput" class="col-search-input" placeholder="æœç´¢åˆ—å..." />
      <div class="col-categories" id="colCategories"></div>
      <div class="col-stats" id="colStats">å·²é€‰æ‹© 0 åˆ—</div>
    </div>
    
    <div id="colPicker" class="colpicker"></div>
  </section>

  <main class="tablewrap">
    <div class="table-responsive">
      <table id="tbl"><thead><tr id="theadRow"></tr></thead><tbody id="tbody"></tbody></table>
    </div>
    <div style="display:flex; align-items:center; gap:8px; padding:8px 0 0;">
      <button class="btn" id="prev">ä¸Šä¸€é¡µ</button>
      <button class="btn" id="next">ä¸‹ä¸€é¡µ</button>
      <span style="color:#6b7280;font-size:12px;">ç¬¬ <b id="pageIdx">1</b> / <b id="pageTotal">1</b> é¡µ</span>
    </div>
    <div class="footer-tip">Â© 2025 å®¢æˆ·ä¿¡æ¯æœç´¢ Â· çº¯å‰ç«¯æœ¬åœ°è¿è¡Œï¼Œä¸ä¸Šä¼ ä½ çš„æ•°æ®</div>
  </main>

  <div id="detail" class="lightbox" aria-hidden="true" role="dialog">
    <div class="panel" id="reportPanel">
      <div class="report-head">
        <div class="report-title" id="reportTitle">å®¢æˆ·ä¿¡æ¯æ±‡æ€»</div>
        <div class="report-toolbar">
          <button class="btn" id="btnCopy">å¤åˆ¶ä¸ºæ–‡æœ¬</button>
          <button class="btn" id="btnSavePng">å¯¼å‡ºä¸ºPNG</button>
          <button class="btn destructive" id="btnClose">å…³é—­</button>
        </div>
      </div>
      <div class="report-grid" id="reportGrid"></div>
    </div>
  </div>

  <script>
  (function(){
    // Tiny helpers
    function $(sel, el){ return (el||document).querySelector(sel); }
    function $all(sel, el){ return Array.prototype.slice.call((el||document).querySelectorAll(sel)); }

    var state = { raw: [], columns: [], visibleCols: {}, pageSize: 50, page: 1, loadToken: 0,
      sort: { key: '', dir: 1 }, nameCol: '', nameQ: '', colSearch: '', collapseColumns: false
    };

    var fileInfo = $('#fileInfo');
    var nameColSel = $('#nameCol');
    var nameQ = $('#nameQ');
    var theadRow = $('#theadRow');
    var tbody = $('#tbody');
    var pageIdx = $('#pageIdx');
    var pageTotal = $('#pageTotal');
    var countTotal = $('#countTotal');
    var countFiltered = $('#countFiltered');
    var colPicker = $('#colPicker');
    var colSearchInput = $('#colSearchInput');
    var colCategories = $('#colCategories');
    var colStats = $('#colStats');

    function setFileInfo(msg, cls){
      if (!fileInfo) return;
      fileInfo.textContent = msg;
      fileInfo.className = 'status ' + (cls||'');
    }

    function parseCSVorTSV(text){
      // ç§»é™¤BOMæ ‡è®°
      text = text.replace(/^\uFEFF/, '');
      
      if (!text.trim()) {
        return { header: [], records: [] };
      }
      
      var lines = text.split(/\r?\n/);
      var first = '';
      
      // æ‰¾åˆ°ç¬¬ä¸€è¡Œéç©ºè¡Œæ¥åˆ¤æ–­åˆ†éš”ç¬¦
      for (var i=0;i<lines.length;i++){ 
        if(lines[i].trim().length){ 
          first = lines[i]; 
          break; 
        } 
      }
      
      if (!first) {
        return { header: [], records: [] };
      }
      
      // æ™ºèƒ½åˆ¤æ–­åˆ†éš”ç¬¦
      var tabCount = (first.match(/\t/g)||[]).length;
      var commaCount = (first.match(/,/g)||[]).length;
      var sep = tabCount > commaCount ? '\t' : ',';
      
      function parseDSV(str, d){
        var rows=[], row=[], field='', inQ=false;
        for(var i=0;i<str.length;i++){
          var c=str[i], n=str[i+1];
          if(inQ){
            if(c === '"' && n === '"'){ field+='"'; i++; continue; }
            if(c === '"'){ inQ=false; continue; }
            field += c;
          }else{
            if(c === '"'){ inQ=true; continue; }
            if(c === d){ row.push(field); field=''; continue; }
            if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=''; continue; }
            if(c === '\r'){ continue; }
            field += c;
          }
        }
        if (field || row.length) {
          row.push(field); 
          rows.push(row);
        }
        
        // è¿‡æ»¤ç©ºè¡Œ
        var filtered = [];
        for (var r=0;r<rows.length;r++){
          var hasContent = false;
          for (var j=0;j<rows[r].length;j++){ 
            if(String(rows[r][j]||'').trim().length){ 
              hasContent=true; 
              break; 
            } 
          }
          if (hasContent) filtered.push(rows[r]);
        }
        return filtered;
      }
      
      var rows = parseDSV(text, sep);
      if(!rows.length) return { header: [], records: [] };
      
      var header = rows[0].map(function(x){ return String(x||'').trim(); });
      
      // éªŒè¯è¡¨å¤´
      if (header.length === 0 || header.every(function(h){ return !h; })) {
        return { header: [], records: [] };
      }
      
      var recs = [];
      for (var i=1;i<rows.length;i++){
        var r = rows[i], obj = {};
        for (var k=0;k<header.length;k++){ 
          obj[header[k]] = String(r[k] == null ? '' : r[k]).trim(); 
        }
        recs.push(obj);
      }
      return { header: header, records: recs };
    }

    function categorizeColumns(columns) {
      var categories = {
        'åŸºæœ¬ä¿¡æ¯': [],
        'è”ç³»æ–¹å¼': [],
        'åœ°åŸŸä¿¡æ¯': [],
        'ä¸šåŠ¡æ•°æ®': [],
        'çŠ¶æ€ä¿¡æ¯': [],
        'æ—¶é—´ä¿¡æ¯': [],
        'å…¶ä»–': []
      };
      
      var patterns = {
        'åŸºæœ¬ä¿¡æ¯': /(å®¢æˆ·|å…¬å¸|åº—é“º|ä¼ä¸š|åç§°|name|company|shop|store|è´Ÿè´£äºº|è”ç³»äºº|å§“å)/i,
        'è”ç³»æ–¹å¼': /(ç”µè¯|æ‰‹æœº|é‚®ç®±|email|phone|tel|mobile|qq|å¾®ä¿¡|wechat)/i,
        'åœ°åŸŸä¿¡æ¯': /(å›½å®¶|çœ|å¸‚|åœ°åŒº|åœ°å€|country|province|city|address|åŒºåŸŸ)/i,
        'ä¸šåŠ¡æ•°æ®': /(GMV|é‡‘é¢|æˆäº¤|è®¢å•|é”€é‡|æ”¶å…¥|revenue|sales|ç›®æ ‡|ä¸šç»©)/i,
        'çŠ¶æ€ä¿¡æ¯': /(çŠ¶æ€|ç­‰çº§|æ˜Ÿ|åˆ†æ•°|status|level|star|score|æ´»è·ƒ|ä¼˜å…ˆ)/i,
        'æ—¶é—´ä¿¡æ¯': /(æ—¶é—´|æ—¥æœŸ|time|date|åˆ›å»º|æ›´æ–°|æœ€è¿‘|æœ€å)/i
      };
      
      for (var i = 0; i < columns.length; i++) {
        var col = columns[i];
        var categorized = false;
        
        for (var category in patterns) {
          if (patterns[category].test(col)) {
            categories[category].push(col);
            categorized = true;
            break;
          }
        }
        
        if (!categorized) {
          categories['å…¶ä»–'].push(col);
        }
      }
      
      return categories;
    }

    function detectNameColumn(columns){
      var patterns = /(å®¢æˆ·|å…¬å¸|åº—é“º|ä¼ä¸š|å…¬å¸å|å®¢æˆ·å|name|company|shop|store)/i;
      for (var i=0;i<columns.length;i++){ if (patterns.test(columns[i])) return columns[i]; }
      return columns[0] || '';
    }

    function buildColumnCategories(columns) {
      var categories = categorizeColumns(columns);
      colCategories.innerHTML = '';
      
      // æ·»åŠ â€œå…¨éƒ¨â€æŒ‰é’®
      var allBtn = document.createElement('button');
      allBtn.className = 'col-category-btn active';
      allBtn.textContent = 'å…¨éƒ¨ (' + columns.length + ')';
      allBtn.addEventListener('click', function() {
        state.colSearch = '';
        colSearchInput.value = '';
        updateCategoryButtons(allBtn);
        buildColumnPicker(state.columns);
      });
      colCategories.appendChild(allBtn);
      
      // æ·»åŠ åˆ†ç±»æŒ‰é’®
      for (var category in categories) {
        if (categories[category].length > 0) {
          (function(cat, cols) {
            var btn = document.createElement('button');
            btn.className = 'col-category-btn';
            btn.textContent = cat + ' (' + cols.length + ')';
            btn.addEventListener('click', function() {
              state.colSearch = '';
              colSearchInput.value = '';
              updateCategoryButtons(btn);
              buildColumnPicker(cols);
            });
            colCategories.appendChild(btn);
          })(category, categories[category]);
        }
      }
    }
    
    function updateCategoryButtons(activeBtn) {
      var buttons = colCategories.querySelectorAll('.col-category-btn');
      for (var i = 0; i < buttons.length; i++) {
        buttons[i].classList.remove('active');
      }
      activeBtn.classList.add('active');
    }

    function buildNameColOptions(columns, guessed){
      var html = '';
      for (var i=0;i<columns.length;i++){
        var c = columns[i];
        html += '<option value="'+c.replace(/"/g,'&quot;')+'">'+c+'</option>';
      }
      nameColSel.innerHTML = html;
      nameColSel.value = guessed || (columns[0] || '');
      state.nameCol = nameColSel.value;
    }

    function buildColumnPicker(columns){
      var filteredColumns = columns;
      
      // åº”ç”¨æœç´¢è¿‡æ»¤
      if (state.colSearch) {
        filteredColumns = columns.filter(function(col) {
          return col.toLowerCase().indexOf(state.colSearch.toLowerCase()) !== -1;
        });
      }
      
      colPicker.innerHTML = '';
      
      if (filteredColumns.length === 0) {
        var noResult = document.createElement('div');
        noResult.style.padding = '20px';
        noResult.style.textAlign = 'center';
        noResult.style.color = '#6b7280';
        noResult.textContent = 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åˆ—';
        colPicker.appendChild(noResult);
        return;
      }
      
      for (var i=0;i<filteredColumns.length;i++){
        var c = filteredColumns[i];
        var chip = document.createElement('label');
        chip.className = 'colchip';
        
        var cb = document.createElement('input'); 
        cb.type='checkbox';
        cb.checked = !!state.visibleCols[c];
        
        // æ›´æ–°æ ·å¼
        if (cb.checked) {
          chip.classList.add('checked');
        }
        
        (function(col, box, chipEl){
          box.addEventListener('change', function(){
            state.visibleCols[col] = !!box.checked;
            if (box.checked) {
              chipEl.classList.add('checked');
            } else {
              chipEl.classList.remove('checked');
            }
            updateColStats();
            render();
          });
          
          // ç‚¹å‡»æ•´ä¸ªchipä¹Ÿå¯ä»¥åˆ‡æ¢
          chipEl.addEventListener('click', function(e) {
            if (e.target !== box) {
              box.checked = !box.checked;
              box.dispatchEvent(new Event('change'));
            }
          });
        })(c, cb, chip);
        
        var span = document.createElement('span'); 
        span.className = 'col-name';
        span.textContent = c;
        
        chip.appendChild(cb); 
        chip.appendChild(span);
        colPicker.appendChild(chip);
      }
      
      updateColStats();
    }

    function updateColStats() {
      var selectedCount = 0;
      for (var i = 0; i < state.columns.length; i++) {
        if (state.visibleCols[state.columns[i]]) {
          selectedCount++;
        }
      }
      colStats.textContent = 'å·²é€‰æ‹© ' + selectedCount + ' / å…± ' + state.columns.length + ' åˆ—';
    }

    function selectAllCols(flag){
      for (var i=0;i<state.columns.length;i++){ 
        state.visibleCols[state.columns[i]] = !!flag; 
      }
      buildColumnPicker(state.columns);
      updateColStats();
      render();
    }

    function defaultCols(){
      var keep = /(å®¢æˆ·|å…¬å¸|å›½å®¶|çœ|å¸‚|è”ç³»äºº|ç”µè¯|æ‰‹æœº|é‚®ç®±|email|GMV|æ˜Ÿ|ç­‰çº§|åˆ†æ•°|è¡Œä¸š|ç±»ç›®|çŠ¶æ€|æœ€è¿‘|æ›´æ–°æ—¶é—´|æœ¬æœˆ|ç´¯è®¡|ç›®æ ‡|æˆäº¤|æ´»è·ƒ)/i;
      var hasSelected = false;
      for (var i=0;i<state.columns.length;i++){
        var c = state.columns[i];
        if (keep.test(c)){ 
          state.visibleCols[c] = true; 
          hasSelected = true; 
        } else { 
          state.visibleCols[c] = false; 
        }
      }
      if (!hasSelected){
        for (var i=0;i<Math.min(10, state.columns.length); i++){ 
          state.visibleCols[state.columns[i]] = true; 
        }
      }
      buildColumnPicker(state.columns);
      updateColStats();
      render();
    }

    function applyFilters(records){
      var out = records.slice(0);
      var q = String(state.nameQ||'').trim().toLowerCase();
      if (q && state.nameCol){
        var parts = q.split(/\s+/).filter(function(x){ return x; });
        out = out.filter(function(row){
          var val = String(row[state.nameCol] || '').toLowerCase();
          for (var i=0;i<parts.length;i++){ if (val.indexOf(parts[i]) === -1) return false; }
          return true;
        });
      }
      if (state.sort.key){
        var k = state.sort.key, d = state.sort.dir;
        out.sort(function(a,b){
          var av = String(a[k] || '');
          var bv = String(b[k] || '');
          var na = parseFloat(av.replace(/[^0-9.\-]/g,''));
          var nb = parseFloat(bv.replace(/[^0-9.\-]/g,''));
          var an = !isNaN(na), bn = !isNaN(nb);
          if (an && bn && (/^[-+]?[\d,.]+$/.test(av) || /^[-+]?[\d,.]+$/.test(bv))) return (na - nb) * d;
          return av.localeCompare(bv, 'zh-Hans-CN') * d;
        });
      }
      return out;
    }

    function renderTableHead(){
      theadRow.innerHTML = '';
      var cols = [];
      for (var i=0;i<state.columns.length;i++){ var c=state.columns[i]; if (state.visibleCols[c]) cols.push(c); }
      for (var i=0;i<cols.length;i++){
        (function(col){
          var th = document.createElement('th');
          th.textContent = col + ' ' + (state.sort.key===col ? (state.sort.dir>0?'â–²':'â–¼') : 'â†•');
          th.addEventListener('click', function(){
            if (state.sort.key===col){ state.sort.dir *= -1; } else { state.sort.key=col; state.sort.dir=1; }
            render();
          });
          theadRow.appendChild(th);
        })(cols[i]);
      }
    }

    function render(){
      try {
        var data = applyFilters(state.raw);
        countTotal.textContent = String(state.raw.length||0);
        countFiltered.textContent = String(data.length||0);

        var ps = state.pageSize;
        var totalPages = Math.max(1, Math.ceil(data.length / ps));
        if (state.page > totalPages) state.page = totalPages;
        var start = (state.page - 1) * ps;
        var pageData = data.slice(start, start + ps);
        pageIdx.textContent = String(state.page);
        pageTotal.textContent = String(totalPages);

        renderTableHead();

        var cols = [];
        for (var i=0;i<state.columns.length;i++){ 
          var c=state.columns[i]; 
          if (state.visibleCols[c]) cols.push(c); 
        }
        
        tbody.innerHTML = '';
        
        // æ·»åŠ æ€§èƒ½ä¼˜åŒ–ï¼šå¤§æ•°æ®é›†æ—¶åˆ†æ‰¹æ¸²æŸ“
        if (pageData.length > 100) {
          renderTableRowsBatch(pageData, cols, 0);
        } else {
          renderTableRows(pageData, cols);
        }
      } catch(err) {
        console.error('æ¸²æŸ“é”™è¯¯:', err);
        setFileInfo('æ¸²æŸ“é”™è¯¯: ' + (err.message || err), 'err');
      }
    }
    
    function renderTableRows(pageData, cols) {
      for (var r=0;r<pageData.length;r++){
        (function(row){
          var tr = document.createElement('tr');
          tr.addEventListener('click', function(){ openDetail(row); });
          for (var i=0;i<cols.length;i++){
            var td = document.createElement('td');
            var v = row[cols[i]];
            td.textContent = (v==null ? '' : String(v));
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        })(pageData[r]);
      }
    }
    
    function renderTableRowsBatch(pageData, cols, startIndex) {
      var batchSize = 50;
      var endIndex = Math.min(startIndex + batchSize, pageData.length);
      
      for (var r=startIndex; r<endIndex; r++){
        (function(row){
          var tr = document.createElement('tr');
          tr.addEventListener('click', function(){ openDetail(row); });
          for (var i=0;i<cols.length;i++){
            var td = document.createElement('td');
            var v = row[cols[i]];
            td.textContent = (v==null ? '' : String(v));
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        })(pageData[r]);
      }
      
      if (endIndex < pageData.length) {
        setTimeout(function() {
          renderTableRowsBatch(pageData, cols, endIndex);
        }, 10);
      }
    }

    function setData(records){
      // è¾“å…¥éªŒè¯
      if (!records || !Array.isArray(records)) {
        console.warn('setData: æ— æ•ˆçš„recordså‚æ•°');
        records = [];
      }
      
      state.raw = records;
      state.columns = records.length > 0 ? Object.keys(records[0]) : [];
      state.visibleCols = {};
      
      // é™åˆ¶é»˜è®¤æ˜¾ç¤ºçš„åˆ—æ•°ï¼Œé¿å…æ€§èƒ½é—®é¢˜
      var maxShow = Math.min(20, state.columns.length);
      for (var i=0; i<maxShow; i++){ 
        state.visibleCols[state.columns[i]] = true; 
      }
      var guessed = detectNameColumn(state.columns);
      buildNameColOptions(state.columns, guessed);
      buildColumnCategories(state.columns);
      buildColumnPicker(state.columns);
      state.page = 1;
      render();
    }

    var detail = $('#detail');
    var reportGrid = $('#reportGrid');
    var reportTitle = $('#reportTitle');

    function openDetail(row){
      var title = 'å®¢æˆ·ä¿¡æ¯æ±‡æ€»';
      if (state.nameCol && row[state.nameCol]) title = 'å®¢æˆ·ï¼š' + String(row[state.nameCol]);
      reportTitle.textContent = title;
      reportGrid.innerHTML = '';
      var ordered = [];
      for (var i=0;i<state.columns.length;i++){ var c=state.columns[i]; if (state.visibleCols[c]) ordered.push(c); }
      for (var i=0;i<state.columns.length;i++){ var c=state.columns[i]; if (!state.visibleCols[c]) ordered.push(c); }
      for (var i=0;i<ordered.length;i++){
        var c = ordered[i];
        var lab = document.createElement('label'); lab.textContent = c;
        var val = document.createElement('div'); val.className = 'val'; val.textContent = String(row[c] == null ? '' : row[c]);
        reportGrid.appendChild(lab); reportGrid.appendChild(val);
      }
      detail.classList.add('open'); detail.setAttribute('aria-hidden', 'false');
      document.addEventListener('keydown', escOnce, { once:true });
    }
    function closeDetail(){
      detail.classList.remove('open'); detail.setAttribute('aria-hidden','true');
    }
    function escOnce(e){ if (e.key === 'Escape') closeDetail(); }
    $('#detail').addEventListener('click', function(e){ if (e.target === detail) closeDetail(); });
    $('#btnClose').addEventListener('click', closeDetail);
    $('#btnCopy').addEventListener('click', function(){
      try {
        var kids = Array.prototype.slice.call(reportGrid.children);
        var parts = [reportTitle.textContent];
        for (var i=0;i<kids.length;i+=2){
          if (kids[i] && kids[i+1]) {
            parts.push((kids[i].textContent||'') + ': ' + (kids[i+1].textContent||''));
          }
        }
        var txt = parts.join('\n');
        
        if (navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(txt).then(
            function(){ alert('å·²å¤åˆ¶æ±‡æ€»æ–‡æœ¬'); }, 
            function(err){ 
              console.error('å¤åˆ¶å¤±è´¥:', err);
              alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'); 
            }
          );
        } else {
          // é™çº§æ–¹æ¡ˆï¼šåˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
          var textArea = document.createElement('textarea');
          textArea.value = txt;
          textArea.style.position = 'fixed';
          textArea.style.opacity = '0';
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            alert('å·²å¤åˆ¶æ±‡æ€»æ–‡æœ¬');
          } catch(err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            alert('å½“å‰ç¯å¢ƒä¸æ”¯æŒç›´æ¥å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬');
          }
          document.body.removeChild(textArea);
        }
      } catch(err) {
        console.error('å¤åˆ¶åŠŸèƒ½é”™è¯¯:', err);
        alert('å¤åˆ¶å¤±è´¥: ' + (err.message || err));
      }
    });
    (function(){
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
      script.async = true;
      document.head.appendChild(script);
    })();
    $('#btnSavePng').addEventListener('click', function(){
      try {
        if (typeof html2canvas === 'undefined'){ 
          alert('æˆªå›¾å¼•æ“æœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•'); 
          return; 
        }
        
        var node = document.getElementById('reportPanel');
        if (!node) {
          alert('æ‰¾ä¸åˆ°è¦æˆªå›¾çš„å†…å®¹');
          return;
        }
        
        html2canvas(node, { 
          backgroundColor:'#ffffff', 
          scale:2,
          useCORS: true,
          allowTaint: true
        }).then(function(canvas){
          var a = document.createElement('a');
          a.href = canvas.toDataURL('image/png');
          a.download = (reportTitle.textContent || 'å®¢æˆ·ä¿¡æ¯æ±‡æ€»') + '.png';
          a.click();
        }).catch(function(err) {
          console.error('æˆªå›¾å¤±è´¥:', err);
          alert('æˆªå›¾å¤±è´¥: ' + (err.message || err));
        });
      } catch(err) {
        console.error('æˆªå›¾åŠŸèƒ½é”™è¯¯:', err);
        alert('æˆªå›¾å¤±è´¥: ' + (err.message || err));
      }
    });

    // Import handlers - æ–‡ä»¶å¯¼å…¥åŠŸèƒ½å·²ç¦ç”¨
    function openFileDialog(){
      alert('æ–‡ä»¶å¯¼å…¥åŠŸèƒ½å·²è¢«ç¦ç”¨');
      setFileInfo('æ–‡ä»¶å¯¼å…¥åŠŸèƒ½å·²ç¦ç”¨', 'warn');
    }
    window.__openFileDialog = openFileDialog;
    document.getElementById('btnImport').addEventListener('click', function(){ openFileDialog(); });

    document.getElementById('dropZone').addEventListener('dragover', function(e){ e.preventDefault(); this.classList.add('over'); });
    document.getElementById('dropZone').addEventListener('dragleave', function(){ this.classList.remove('over'); });
    document.getElementById('dropZone').addEventListener('drop', function(e){
      e.preventDefault(); this.classList.remove('over');
      var files = e.dataTransfer && e.dataTransfer.files;
      if(files && files[0]) handlePickedFile(files[0]);
    });
    document.getElementById('dropZone').addEventListener('click', function(){ openFileDialog(); });

    document.getElementById('btnClear').addEventListener('click', function(){
      if (state.raw.length > 0) {
        var confirmed = confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚');
        if (!confirmed) return;
      }
      
      try {
        state.raw = []; 
        state.columns = []; 
        state.visibleCols = {}; 
        state.page = 1; 
        state.sort = {key: '', dir: 1}; 
        state.nameCol = ''; 
        state.nameQ = '';
        state.colSearch = '';
        
        theadRow.innerHTML = ''; 
        tbody.innerHTML = ''; 
        colPicker.innerHTML = ''; 
        nameColSel.innerHTML = '';
        if (colCategories) colCategories.innerHTML = '';
        if (colStats) colStats.textContent = 'å·²é€‰æ‹© 0 åˆ—';
        
        setFileInfo('æœªåŠ è½½æ•°æ®','warn'); 
        countTotal.textContent = '0'; 
        countFiltered.textContent = '0'; 
        nameQ.value = '';
        
        pageIdx.textContent = '1';
        pageTotal.textContent = '1';
      } catch(err) {
        console.error('æ¸…ç©ºæ•°æ®é”™è¯¯:', err);
        alert('æ¸…ç©ºå¤±è´¥: ' + (err.message || err));
      }
    });

    document.getElementById('btnExport').addEventListener('click', function(){
      try {
        var data = applyFilters(state.raw);
        var cols = [];
        for (var i=0;i<state.columns.length;i++){ 
          var c=state.columns[i]; 
          if (state.visibleCols[c]) cols.push(c); 
        }
        
        if (cols.length === 0) {
          alert('æ²¡æœ‰é€‰æ‹©è¦å¯¼å‡ºçš„åˆ—');
          return;
        }
        
        if (data.length === 0) {
          alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º');
          return;
        }
        
        var lines = [];
        var h = [];
        for (var i=0;i<cols.length;i++){ 
          h.push('"' + String(cols[i]).replace(/"/g,'""') + '"'); 
        }
        lines.push(h.join(','));
        
        for (var r=0;r<data.length;r++){
          var row = [];
          for (var i=0;i<cols.length;i++){ 
            row.push('"' + String(data[r][cols[i]] || '').replace(/"/g,'""') + '"'); 
          }
          lines.push(row.join(','));
        }
        
        // æ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡
        var content = '\uFEFF' + lines.join('\n');
        var blob = new Blob([content], {type:'text/csv;charset=utf-8'});
        var a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        
        // ç”Ÿæˆæ›´æœ‰æ„ä¹‰çš„æ–‡ä»¶å
        var timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
        a.download = 'filtered-results-' + timestamp + '.csv'; 
        a.click(); 
        URL.revokeObjectURL(a.href);
        
        setFileInfo('å·²å¯¼å‡º ' + data.length + ' è¡Œæ•°æ®', 'ok');
      } catch(err) {
        console.error('å¯¼å‡ºé”™è¯¯:', err);
        alert('å¯¼å‡ºå¤±è´¥: ' + (err.message || err));
      }
    });

    document.getElementById('pageSize').addEventListener('change', function(e){ state.pageSize = parseInt(e.target.value,10)||50; state.page=1; render(); });
    document.getElementById('prev').addEventListener('click', function(){ if(state.page>1){ state.page--; render(); } });
    document.getElementById('next').addEventListener('click', function(){ state.page++; render(); });

    nameColSel.addEventListener('change', function(){ state.nameCol = nameColSel.value; state.page=1; render(); });
    nameQ.addEventListener('input', function(e){ state.nameQ = e.target.value || ''; state.page=1; render(); });

    // åˆ—æœç´¢å’Œæ”¶èµ·å±•å¼€åŠŸèƒ½
    colSearchInput.addEventListener('input', function(e) {
      state.colSearch = e.target.value || '';
      buildColumnPicker(state.columns);
    });
    
    document.getElementById('btnToggleCollapse').addEventListener('click', function() {
      state.collapseColumns = !state.collapseColumns;
      var picker = document.getElementById('colPicker');
      var searchBox = document.querySelector('.col-search-box');
      
      if (state.collapseColumns) {
        picker.style.display = 'none';
        searchBox.style.display = 'none';
        this.textContent = 'å±•å¼€';
      } else {
        picker.style.display = 'grid';
        searchBox.style.display = 'block';
        this.textContent = 'æ”¶èµ·';
      }
    });

    document.getElementById('btnSelectAll').addEventListener('click', function(){ selectAllCols(true); });
    document.getElementById('btnInvert').addEventListener('click', function(){
      var newSet = {};
      for (var i=0;i<state.columns.length;i++){ 
        var c = state.columns[i]; 
        if (!state.visibleCols[c]) newSet[c] = true; 
      }
      state.visibleCols = newSet;
      buildColumnPicker(state.columns);
      updateColStats();
      render();
    });
    document.getElementById('btnDefaultCols').addEventListener('click', defaultCols);

    // File reading
    function handlePickedFile(file){
      // è¾“å…¥éªŒè¯
      if (!file) {
        setFileInfo('æœªé€‰æ‹©æ–‡ä»¶', 'err');
        return;
      }
      
      // version token to avoid race conditions across multiple imports
      var token = ++state.loadToken;
      
      // Clear previous file & data immediately when importing a new file
      state.raw = [];
      state.columns = [];
      state.visibleCols = {};
      state.page = 1;
      state.sort = { key: '', dir: 1 };
      state.nameCol = '';
      state.nameQ = '';
      
      // å®‰å…¨åœ°æ¸…ç©ºUIå…ƒç´ 
      if (nameQ) nameQ.value = '';
      if (colSearchInput) colSearchInput.value = '';
      theadRow.innerHTML = '';
      tbody.innerHTML = '';
      colPicker.innerHTML = '';
      nameColSel.innerHTML = '';
      pageIdx.textContent = '1';
      pageTotal.textContent = '1';
      countTotal.textContent = '0';
      countFiltered.textContent = '0';

      try{
        var name = file && file.name ? file.name : 'æœªçŸ¥æ–‡ä»¶å';
        var type = file && file.type ? file.type : '';
        var nameLower = name.toLowerCase();
        var typeLower = type.toLowerCase();
        setFileInfo('å¤„ç†ä¸­â€¦ï¼ˆ' + name + ' / ' + (type || 'æœªçŸ¥ç±»å‹') + 'ï¼‰','warn');
        // Prefer XLSX
        var looksExcel = /\.(xlsx|xls)$/i.test(nameLower) || /sheet|excel/.test(typeLower) || (typeLower.indexOf('application/') === 0) || typeLower === '';
        var looksText  = /\.(csv|tsv|txt)$/i.test(nameLower) || (typeLower.indexOf('text/') === 0);

        function tryReadXLSX(next){
          if (typeof XLSX === 'undefined'){ 
            if(next) next('XLSX æœªåŠ è½½'); 
            return; 
          }
          
          var fr = new FileReader();
          fr.onload = function(e){
            try{
              if (!e.target.result) {
                if(next) next('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                return;
              }
              
              var data = new Uint8Array(e.target.result);
              var wb = XLSX.read(data, { type:'array' });
              var sheets = wb.SheetNames || [];
              
              if (sheets.length === 0) {
                if(next) next('Excelæ–‡ä»¶æ— å·¥ä½œè¡¨');
                return;
              }
              
              var records = [];
              for (var i=0;i<sheets.length;i++){
                var ws = wb.Sheets[sheets[i]];
                if (!ws) continue;
                
                var arr = XLSX.utils.sheet_to_json(ws, { defval:'', raw:false });
                if (arr && arr.length) {
                  for (var j=0;j<arr.length;j++) {
                    records.push(arr[j]);
                  }
                }
              }
              
              if (records.length > 0){ 
                if (token !== state.loadToken) return; 
                setData(records); 
                setFileInfo('å·²åŠ è½½ï¼š' + name + 'ï¼ˆ' + records.length + ' è¡Œï¼‰','ok'); 
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨
                var fp = document.getElementById('filePick'); 
                if(fp) fp.value = ''; 
              } else {
                if (next) next('XLSX æ— æœ‰æ•ˆæ•°æ®');
              }
            }catch(err){ 
              var errMsg = err && err.message ? err.message : String(err);
              console.error('XLSXè§£æé”™è¯¯:', errMsg);
              if(next) next(errMsg); 
            }
          };
          
          fr.onerror = function(e){ 
            console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', e);
            if(next) next('æ–‡ä»¶è¯»å–å¤±è´¥'); 
          };
          
          fr.readAsArrayBuffer(file);
        }

        function tryReadDSV(next){
          var fr = new FileReader();
          fr.onload = function(e){
            try{
              var txt = String(e.target.result || '');
              
              if (!txt.trim()) {
                if(next) next('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                return;
              }
              
              var parsed = parseCSVorTSV(txt);
              if (parsed && parsed.records && parsed.records.length > 0){
                if (token !== state.loadToken) return;
                setData(parsed.records);
                setFileInfo('å·²åŠ è½½ï¼š' + name + 'ï¼ˆ' + parsed.records.length + ' è¡Œï¼‰','ok');
              } else {
                if(next) next('æ–‡æœ¬æ— æœ‰æ•ˆæ•°æ®');
              }
            }catch(err){ 
              var errMsg = err && err.message ? err.message : String(err);
              console.error('CSV/TSVè§£æé”™è¯¯:', errMsg);
              if(next) next(errMsg); 
            }
          };
          
          fr.onerror = function(e){ 
            console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', e);
            if(next) next('æ–‡ä»¶è¯»å–å¤±è´¥'); 
          };
          
          fr.readAsText(file, 'UTF-8');
        }

        if (looksExcel){
          tryReadXLSX(function(err1){
            tryReadDSV(function(err2){
              if (token === state.loadToken){ setFileInfo('å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è§£æä¸º Excel æˆ– æ–‡æœ¬ï¼ˆ' + err1 + ' / ' + err2 + 'ï¼‰','err');
              alert('å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è§£æä¸º Excel æˆ– æ–‡æœ¬ï¼ˆ' + err1 + ' / ' + err2 + 'ï¼‰'); }
            });
          });
        } else if (looksText){
          tryReadDSV(function(err1){
            tryReadXLSX(function(err2){
              if (token === state.loadToken){ setFileInfo('å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è§£æä¸º æ–‡æœ¬ æˆ– Excelï¼ˆ' + err1 + ' / ' + err2 + 'ï¼‰','err');
              alert('å¯¼å…¥å¤±è´¥ï¼šæ— æ³•è§£æä¸º æ–‡æœ¬ æˆ– Excelï¼ˆ' + err1 + ' / ' + err2 + 'ï¼‰'); }
            });
          });
        } else {
          tryReadXLSX(function(err1){
            tryReadDSV(function(err2){
              if (token === state.loadToken){ setFileInfo('å¯¼å…¥å¤±è´¥ï¼šä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼ˆ' + name + ' / ' + (type||'æœªçŸ¥') + 'ï¼‰ï¼›è§£æå¤±è´¥ï¼š' + err1 + ' / ' + err2,'err');
              alert('å¯¼å…¥å¤±è´¥ï¼šä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼ˆ' + name + ' / ' + (type||'æœªçŸ¥') + 'ï¼‰ï¼›è§£æå¤±è´¥ï¼š' + err1 + ' / ' + err2); }
            });
          });
        }
      }catch(err){
        var errMsg = err && err.message ? err.message : String(err);
        console.error('æ–‡ä»¶å¤„ç†å¼‚å¸¸:', errMsg);
        if (token === state.loadToken){ 
          setFileInfo('å¯¼å…¥å¤±è´¥ï¼š' + errMsg,'err');
          alert('å¯¼å…¥å¤±è´¥ï¼š' + errMsg); 
        }
      }
    }

  })();
  </script>
</body>
</html>

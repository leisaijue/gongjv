<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ‰¹é‡å›¾ç‰‡é“¾æ¥å±•ç¤ºå™¨ - å·¥å…·ä¸­å¿ƒ</title>
  <script>
    // èº«ä»½éªŒè¯æ£€æŸ¥
    const SESSION_KEY = 'toolcenter_auth';
    const REMEMBER_KEY = 'toolcenter_remember';
    
    function checkAuth() {
      const sessionAuth = sessionStorage.getItem(SESSION_KEY);
      const rememberAuth = localStorage.getItem(REMEMBER_KEY);
      
      if (sessionAuth === 'authenticated') {
        return true;
      }
      
      if (rememberAuth) {
        try {
          const authData = JSON.parse(rememberAuth);
          const expiryTime = new Date(authData.expiry);
          const now = new Date();
          
          if (now < expiryTime) {
            sessionStorage.setItem(SESSION_KEY, 'authenticated');
            return true;
          } else {
            localStorage.removeItem(REMEMBER_KEY);
          }
        } catch (e) {
          localStorage.removeItem(REMEMBER_KEY);
        }
      }
      
      return false;
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥èº«ä»½éªŒè¯
    if (!checkAuth()) {
      window.location.href = './login.html';
    }
  </script>
  <style>
    :root { --cell-size: 240px; --gap: 12px; --radius: 12px;
      --bg: #ffffff; --panel: #f9f9f9; --text: #333333;
      --muted: #666666; --accent: #4da3ff; --border: #dddddd;  --nav-h: 52px; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Helvetica, Arial, "PingFang SC","Hiragino Sans GB","Microsoft YaHei", sans-serif; }
    .app { display: grid; grid-template-rows: auto auto auto 1fr; gap: 12px; min-height: 100%; }
    header { padding: 14px 18px; background: var(--panel); border-bottom: 1px solid var(--border); position: sticky;  z-index: 10; }
    header h1 { font-size: 18px; margin: 0 0 8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .controls, .filters { display: flex; flex-wrap: wrap; gap: 10px 16px; align-items: center; padding: 0 18px 8px; }
    .controls .row, .filters .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
    label { color: var(--muted); font-size: 12px; }
    input[type="text"], textarea, select { color: #333333; background: #ffffff; border: 1px solid #dddddd; border-radius: 10px; padding: 8px 10px; outline: none; min-width: 220px; }
    textarea { width: min(100%, 920px); height: 90px; resize: vertical; }
    input[type="range"] { width: 180px; }
    
    /* æœç´¢ä¸‹æ‹‰æ¡†æ ·å¼ */
    .searchable-select { position: relative; display: inline-block; min-width: 220px; }
    .searchable-select input { width: 100%; box-sizing: border-box; padding-right: 30px; }
    .searchable-select .clear-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; cursor: pointer; font-size: 16px; padding: 0; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; border-radius: 50%; }
    .searchable-select .clear-btn:hover { background: #f0f0f0; color: #666; }
    .searchable-select.has-value .clear-btn { display: flex; }
    .searchable-select .dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #ffffff; border: 1px solid #dddddd; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
    .searchable-select .dropdown.show { display: block; }
    .searchable-select .dropdown-item { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .searchable-select .dropdown-item:hover { background: #f7f7f7; }
    .searchable-select .dropdown-item.selected { background: #e3f2fd; color: #1976d2; }
    .searchable-select .dropdown-item:last-child { border-bottom: none; }
    .btn { appearance: none; border: 1px solid #dddddd; background: #ffffff; color: #333333; padding: 8px 12px; border-radius: 12px; cursor: pointer; transition: .15s ease; display:inline-block; }
    .btn:hover { border-color: #cfcfcf; background: #f7f7f7; transform: translateY(-1px); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; transform: none; background: #f5f5f5; color: #999999; }
    .btn.primary { background: #1b65ff; border-color: #1b65ff; color: #ffffff; }
    .btn.destructive { background: #d64545; border-color: #d64545; color: #ffffff; }
    .hint { color: var(--muted); font-size: 12px; }
    .status { font-size: 12px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; }
    .status.ok { color: #7ce38b; border-color: #2a3a2f; background: #122015; }
    .status.warn { color: #ffd27f; border-color: #4a3a1a; background: #2a1f0f; }
    .status.err { color: #ff9aa2; border-color: #4a2a2a; background: #2a1111; }
    .status.inline { margin-left:6px; }

    .gallery { padding: 12px 18px 38px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--cell-size), 1fr)); gap: var(--gap); align-items: start; }
    figure.card { margin: 0; padding: 10px; border-radius: 14px; background: var(--panel); border: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 8px; user-select: none; }
    .thumb { position: relative; overflow: hidden; border-radius: var(--radius); aspect-ratio: 1 / 1; background: #0c0f15; border: 1px dashed #1f2631;
      display: grid; place-items: center; cursor: zoom-in; }
    .thumb img { width: 100%; height: 100%; object-fit: var(--fit, contain); display: block; }
    .thumb.error { background: #1a1112; border-color: #402427; }
    .thumb.loading::after { content: "åŠ è½½ä¸­â€¦"; position: absolute; inset: auto 8px 8px auto; font-size: 11px; color: var(--muted);
      background: rgba(0,0,0,.28); padding: 2px 6px; border-radius: 6px; border: 1px solid #2a3240; }
    .meta { display: grid; grid-template-columns: 1fr; gap: 6px; font-size: 12px; color: var(--muted); }
    .meta .title { color: var(--text); font-weight: 600; font-size: 13px; }
    .badgelist { display: flex; flex-wrap: wrap; gap: 6px; }
    .badge { font-size: 11px; padding: 3px 8px; border-radius: 999px; border: 1px solid #e5e7eb; background: #f3f4f6; color: #555555; }

    .footer-tip { text-align: center; color: var(--muted); font-size: 12px; padding: 12px 0 24px; }
    a { color: var(--accent); text-decoration: none; }
    .kpi { color: var(--muted); font-size: 12px; }
    .drop { border: 1px dashed var(--border); border-radius: 10px; padding: 8px 10px; color: var(--muted); }
    .drop.over { border-color: var(--accent); color: var(--text); }

    /* å¿™ç¢Œé®ç½© */
    .busy { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; z-index: 99999; }
    .busy.show { display: flex; }
    .busy .box { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px 18px; display: flex; gap: 10px; align-items: center; color: var(--text); }
    .spinner { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #999; border-top-color: transparent; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* æŠ˜å æ ·å¼ */
    body.ui-collapsed header .controls,
    body.ui-collapsed header .filters { display: none; }
    body.ui-collapsed header { padding-bottom: 8px; }
    .toolbar-right { margin-left: auto; display: inline-flex; gap: 8px; }

    /* Lightbox */
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,.75); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 100000; }
    .lightbox.open { display: flex; }
    .lightbox .panel { background: #fdfdfd; border: 1px solid #dddddd; border-radius: 16px; padding: 12px; display: grid; grid-template-columns: minmax(260px, 60vw) 260px; gap: 12px; max-height: 90vh; width: min(92vw, 1080px); color: #333333; }
    .lightbox .imgwrap { background: #0c0f15; border: 1px solid var(--border); border-radius: 12px; display: grid; place-items: center; overflow: auto; }
    .lightbox .imgwrap img { max-width: 100%; max-height: 86vh; object-fit: contain; }
    .lightbox .side { display: grid; grid-template-rows: auto 1fr auto; gap: 12px; }
    .lightbox .side h3 { margin: 0; font-size: 16px; }
    .kv { display: grid; grid-template-columns: 90px 1fr; gap: 2px 6px; font-size: 12px; line-height: 1.1; }
    .kv label { color: #666666; text-align: right; font-weight: 600; }
    .toolbar { display: flex; gap: 8px; justify-content: flex-end; }
    .btn.small { padding: 6px 10px; border-radius: 10px; font-size: 12px; }
  .kv div { color: #333333; background: #f8f9fa; border: 1px solid #eeeeee; padding: 2px 4px; border-radius: 6px; }

/* --- Global Navbar --- */
.navbar { position: sticky; top: 0; z-index: 9999; background: #ffffff; border-bottom: 1px solid #e5e7eb; }
.navbar .wrap { display: flex; align-items: center; gap: 10px; padding: 10px 16px; }
.navbar .brand { font-weight: 700; color: #111827; margin-right: 6px; }
.navbar .spacer { flex: 1; }
.navbar a.navlink { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 10px; color: #374151; text-decoration: none; font-size: 14px; transition: all 0.2s ease; }
.navbar a.navlink:hover { background: #f9fafb; border-color: #d1d5db; }
.navbar a.navlink.active { background: #1b65ff; border-color: #1b65ff; color: #ffffff; }

</style>
</head>
<body>

  <nav class="navbar" role="navigation" aria-label="ä¸»å¯¼èˆª">
    <div class="wrap">
      <div class="brand">ğŸ› ï¸ å·¥å…·ä¸­å¿ƒ</div>
      <a class="navlink" href="./index.html">é¦–é¡µ</a>
      <a class="navlink active" href="./image-gallery.html" aria-current="page">æ‰¹é‡å›¾ç‰‡å±•ç¤ºå™¨</a>
      <a class="navlink" href="./customer-search.html">å®¢æˆ·ä¿¡æ¯æœç´¢</a>
      <a class="navlink" href="./customer-card.html">å®¢æˆ·ä¿¡æ¯å¡ç”Ÿæˆå™¨</a>
      <a class="navlink" href="./script-editor.html">è¯æœ¯ç¼–è¾‘å™¨</a>
      <div class="spacer"></div>
    </div>
  </nav>

  <div class="app">
    <header>
      <h1>
        æ‰¹é‡å›¾ç‰‡é“¾æ¥å±•ç¤ºå™¨ Â· v6.7ï¼ˆçº§è”ç­›é€‰ + æ”¾å¤§è¯¦æƒ…ï¼‰
        <span id="xlsxState" class="status warn" title="ç¦»çº¿æ—¶ä¸åŠ è½½ï¼Œå¯¼å…¥ .xlsx å»ºè®®æ”¹å­˜ä¸º CSV/TSV">XLSX å¼•æ“ï¼šæœªåŠ è½½</span>
        <span id="importState" class="status inline">å¯¼å…¥ï¼šå°±ç»ª</span>
        <span id="jsHealth" class="status ok">JSï¼šè¿è¡Œæ­£å¸¸</span>
        <span class="toolbar-right">
          <button class="btn" id="btnCollapse">æŠ˜å å·¥å…·æ </button>
          <button class="btn" id="btnFullscreen">å…¨å±</button>
        </span>
      </h1>
      <div class="controls">
        <div class="row">
          <textarea id="urlInput" placeholder="ç²˜è´´å›¾ç‰‡ç›´é“¾ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼Œæˆ–ç‚¹å‡»â€œå¯¼å…¥æ–‡ä»¶â€ã€‚æ”¯æŒ //ã€http(s)://ã€è£¸åŸŸåï¼ˆè‡ªåŠ¨è¡¥ https://ï¼‰ã€‚"></textarea>
          <button class="btn primary" id="btnAdd">æ·»åŠ åˆ°ç”»å»Š</button>
          <button class="btn" id="btnImport">å¯¼å…¥æ–‡ä»¶(TXT/CSV/TSV/XLSX)</button>
          <button class="btn" id="btnDownloadTemplate">ğŸ“‹ ä¸‹è½½æ¨¡æ¿</button>
          <button class="btn" id="btnExport">å¯¼å‡ºæ‰€æœ‰å›¾ç‰‡é“¾æ¥</button>
          <button class="btn" id="btnSample">æ’å…¥ç¤ºä¾‹</button>
          <button class="btn" id="btnAddTestData">æ·»åŠ æµ‹è¯•æ•°æ®</button>
          <button class="btn destructive" id="btnClear">æ¸…ç©ºç”»å»Š</button>
          <button class="btn destructive" id="btnClearAll">æ¸…ç©ºè¾“å…¥+ç”»å»Š</button>
        </div>
        <div class="row">
          <label>å¡ç‰‡å®½åº¦</label>
          <input type="range" id="size" min="160" max="520" step="10" value="240" />
          <span class="hint" id="sizeVal">240px</span>
          <label>é—´è·</label>
          <input type="range" id="gap" min="0" max="36" step="2" value="12" />
          <span class="hint" id="gapVal">12px</span>
          <label>åœ†è§’</label>
          <input type="range" id="radius" min="0" max="24" step="2" value="12" />
          <span class="hint" id="radiusVal">12px</span>
          <label>é€‚é…</label>
          <select id="fit">
            <option value="contain" selected>ç­‰æ¯”å®Œæ•´(contain)</option>
            <option value="cover">è£åˆ‡å……æ»¡(cover)</option>
          </select>
          <label><input type="checkbox" id="dragMode" /> æ’åºæ¨¡å¼(æ‹–æ‹½å¡ç‰‡)</label>
          <label><input type="checkbox" id="noNetwork" /> ä»…æ˜¾ç¤ºä¿¡æ¯ï¼ˆä¸åŠ è½½å›¾ç‰‡ï¼‰</label>
        </div>
        <div id="dropZone" class="row drop">ä¹Ÿå¯ç›´æ¥æ‹–æ‹½ CSV/TSV/XLSX/TXT åˆ°æ­¤åŒºåŸŸå¯¼å…¥</div>
        <div class="row hint">è¡¨å¤´å¯ç”¨è¿‘ä¹‰è¯ï¼Œè‡ªåŠ¨è¯†åˆ«ï¼štopic_idã€æ ‡é¢˜ã€ç¤ºä¾‹å›¾ç‰‡ç¬¬ä¸€ä¸ªï¼ˆå›¾ç‰‡é“¾æ¥/é¦–å›¾/imgç­‰ï¼‰ã€ä¸€çº§/äºŒçº§/ä¸‰çº§è¡Œä¸šã€ç´¯è®¡å®šæ‹›å“æ•°ã€‚</div>
      </div>

      <div class="filters">
        <div class="card" style="flex:1 1 320px;">
          <div class="row">
            <label for="q">æœç´¢æ ‡é¢˜</label>
            <input type="text" id="q" placeholder="è¾“å…¥å…³é”®è¯æœç´¢æ ‡é¢˜..." style="min-width:260px" />
          </div>
          <div class="filter-group">
            <label>å®¢æˆ·åå­—</label>
            <div class="searchable-select" data-target="selCustomer">
              <input type="text" placeholder="æœç´¢æˆ–é€‰æ‹©å®¢æˆ·..." readonly />
              <button class="clear-btn" title="æ¸…é™¤é€‰æ‹©">Ã—</button>
              <div class="dropdown"></div>
            </div>
            <label>åº—é“ºID</label>
            <div class="searchable-select" data-target="selShop">
              <input type="text" placeholder="æœç´¢æˆ–é€‰æ‹©åº—é“ºID..." readonly />
              <button class="clear-btn" title="æ¸…é™¤é€‰æ‹©">Ã—</button>
              <div class="dropdown"></div>
            </div>
            <label>ä¸€çº§è¡Œä¸š</label>
            <div class="searchable-select" data-target="sel1">
              <input type="text" placeholder="æœç´¢æˆ–é€‰æ‹©ä¸€çº§è¡Œä¸š..." readonly />
              <button class="clear-btn" title="æ¸…é™¤é€‰æ‹©">Ã—</button>
              <div class="dropdown"></div>
            </div>
            <label>äºŒçº§è¡Œä¸š</label>
            <div class="searchable-select" data-target="sel2">
              <input type="text" placeholder="æœç´¢æˆ–é€‰æ‹©äºŒçº§è¡Œä¸š..." readonly />
              <button class="clear-btn" title="æ¸…é™¤é€‰æ‹©">Ã—</button>
              <div class="dropdown"></div>
            </div>
            <label>ä¸‰çº§è¡Œä¸š</label>
            <div class="searchable-select" data-target="sel3">
              <input type="text" placeholder="æœç´¢æˆ–é€‰æ‹©ä¸‰çº§è¡Œä¸š..." readonly />
              <button class="clear-btn" title="æ¸…é™¤é€‰æ‹©">Ã—</button>
              <div class="dropdown"></div>
            </div>
            <span class="kpi">å·²ç­›é€‰ï¼š<b id="countFiltered">0</b> / æ€»æ•°ï¼š<b id="countTotal">0</b></span>
          </div>
          <!-- éšè—çš„åŸå§‹selectå…ƒç´  -->
          <div style="display: none;">
            <select id="selCustomer"><option value="">å…¨éƒ¨</option></select>
            <select id="selShop"><option value="">å…¨éƒ¨</option></select>
            <select id="sel1"><option value="">å…¨éƒ¨</option></select>
            <select id="sel2"><option value="">å…¨éƒ¨</option></select>
            <select id="sel3"><option value="">å…¨éƒ¨</option></select>
          </div>
        </div>
      </div>

    </header>

    <main class="gallery">
      <div id="grid" class="grid" aria-live="polite"></div>
      <div class="footer-tip">Â© 2025 æ‰¹é‡å›¾ç‰‡é“¾æ¥å±•ç¤ºå™¨ Â· çº¯å‰ç«¯æœ¬åœ°è¿è¡Œï¼Œä¸ä¸Šä¼ ä½ çš„æ•°æ®</div>
    </main>
  </div>

  <!-- Busy overlay -->
  <div id="busy" class="busy" aria-hidden="true">
    <div class="box"><span class="spinner"></span><span id="busyText">å¯¼å…¥ä¸­ï¼Œè¯·ç¨å€™â€¦</span></div>
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog">
    <div class="panel">
      <div class="imgwrap"><img id="lbImg" alt="preview" /></div>
      <div class="side">
        <h3 id="lbTitle">(æ— æ ‡é¢˜)</h3>
        <div class="kv">
          <label>topic_id</label><div id="lbTopic">-</div>
          <label>ä¸€çº§è¡Œä¸š</label><div id="lbC1">-</div>
          <label>äºŒçº§è¡Œä¸š</label><div id="lbC2">-</div>
          <label>ä¸‰çº§è¡Œä¸š</label><div id="lbC3">-</div>
          <label>ç´¯è®¡å®šæ‹›å“æ•°</label><div id="lbCnt">-</div>
          <label>å®¢æˆ·åå­—</label><div id="lbCust">-</div>
          <label>åº—é“ºID</label><div id="lbShop">-</div>
          <label>å›¾ç‰‡é“¾æ¥</label><div><a id="lbHref" href="#" target="_blank" rel="noreferrer noopener">åœ¨æ–°æ ‡ç­¾æ‰“å¼€</a></div>
        </div>
        <div class="toolbar">
          <button class="btn small" id="btnCopy">å¤åˆ¶é“¾æ¥</button>
          <button class="btn small" id="btnOpenNew">æ–°æ ‡ç­¾æ‰“å¼€</button>
          <button class="btn small" id="btnClose">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function loadXLSX(){
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
      s.async = true;
      s.onload = function(){ const x=document.getElementById('xlsxState'); if(x){ x.textContent='XLSX å¼•æ“ï¼šå·²åŠ è½½'; x.className='status ok'; } };
      s.onerror = function(){ const x=document.getElementById('xlsxState'); if(x){ x.textContent='XLSX å¼•æ“ï¼šæœªåŠ è½½ï¼ˆç¦»çº¿CSVå¯ç”¨ï¼‰'; x.className='status warn'; } };
      document.head.appendChild(s);
    })();
  </script>

  <script>
  'use strict';
  (function(){
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const jsHealth = $('#jsHealth');
    const importState = $('#importState');
    const busy = $('#busy'); const busyText = $('#busyText');

    function markHealth(ok, msg){
      if(!jsHealth) return;
      jsHealth.className = 'status ' + (ok ? 'ok' : 'err');
      jsHealth.textContent = 'JSï¼š' + (msg || (ok ? 'è¿è¡Œæ­£å¸¸' : 'å¼‚å¸¸'));
    }

    // æœç´¢ä¸‹æ‹‰æ¡†åŠŸèƒ½
    class SearchableSelect {
      constructor(container) {
        this.container = container;
        this.input = container.querySelector('input');
        this.dropdown = container.querySelector('.dropdown');
        this.clearBtn = container.querySelector('.clear-btn');
        this.targetId = container.dataset.target;
        this.originalSelect = $('#' + this.targetId);
        this.options = [];
        this.selectedValue = '';
        this.isOpen = false;
        
        this.init();
      }
      
      init() {
        // ç‚¹å‡»è¾“å…¥æ¡†æ˜¾ç¤ºä¸‹æ‹‰
        this.input.addEventListener('click', () => this.toggle());
        
        // è¾“å…¥æœç´¢
        this.input.addEventListener('input', (e) => this.filter(e.target.value));
        
        // æ¸…é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        if (this.clearBtn) {
          this.clearBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.clear();
          });
        }
        
        // å¤±ç„¦éšè—ä¸‹æ‹‰ï¼ˆå»¶è¿Ÿä»¥å…è®¸ç‚¹å‡»é€‰é¡¹ï¼‰
        this.input.addEventListener('blur', () => {
          setTimeout(() => this.close(), 150);
        });
        
        // é”®ç›˜å¯¼èˆª
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.addEventListener('click', (e) => {
          if (!this.container.contains(e.target)) {
            this.close();
          }
        });
      }
      
      updateOptions(options) {
        this.options = options.map(opt => ({
          value: opt.value || opt,
          text: opt.text || opt,
          selected: opt.selected || false
        }));
        this.render();
      }
      
      render() {
        this.dropdown.innerHTML = '';
        const filteredOptions = this.options.filter(opt => 
          opt.text.toLowerCase().includes((this.input.value || '').toLowerCase())
        );
        
        filteredOptions.forEach(opt => {
          const item = document.createElement('div');
          item.className = 'dropdown-item' + (opt.selected ? ' selected' : '');
          item.textContent = opt.text;
          item.addEventListener('click', () => this.select(opt));
          this.dropdown.appendChild(item);
        });
        
        if (filteredOptions.length === 0) {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = 'æ— åŒ¹é…é€‰é¡¹';
          item.style.color = '#999';
          this.dropdown.appendChild(item);
        }
      }
      
      select(option) {
        this.selectedValue = option.value;
        // å¦‚æœé€‰æ‹©çš„æ˜¯"å…¨éƒ¨"é€‰é¡¹ï¼Œè¾“å…¥æ¡†ç•™ç©º
        this.input.value = option.value === '' ? '' : option.text;
        this.input.removeAttribute('readonly');
        this.input.setAttribute('readonly', true);
        
        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        this.updateClearButton();
        
        // æ›´æ–°åŸå§‹select
        if (this.originalSelect) {
          this.originalSelect.value = option.value;
          this.originalSelect.dispatchEvent(new Event('change'));
        }
        
        this.close();
      }
      
      clear() {
        this.selectedValue = '';
        this.input.value = '';
        this.updateClearButton();
        
        // æ›´æ–°åŸå§‹selectå¹¶è§¦å‘changeäº‹ä»¶
        if (this.originalSelect) {
          this.originalSelect.value = '';
          this.originalSelect.dispatchEvent(new Event('change'));
        }
        
        this.close();
      }
      
      updateClearButton() {
        if (this.clearBtn) {
          if (this.input.value && this.input.value.trim()) {
            this.container.classList.add('has-value');
          } else {
            this.container.classList.remove('has-value');
          }
        }
      }
      
      toggle() {
        if (this.isOpen) {
          this.close();
        } else {
          this.open();
        }
      }
      
      open() {
        this.isOpen = true;
        this.dropdown.classList.add('show');
        this.input.removeAttribute('readonly');
        this.input.focus();
        this.render();
      }
      
      close() {
        this.isOpen = false;
        this.dropdown.classList.remove('show');
        this.input.setAttribute('readonly', true);
      }
      
      filter(query) {
        this.render();
      }
      
      handleKeydown(e) {
        if (!this.isOpen) return;
        
        const items = this.dropdown.querySelectorAll('.dropdown-item');
        const current = this.dropdown.querySelector('.dropdown-item.selected');
        let index = Array.from(items).indexOf(current);
        
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            index = Math.min(index + 1, items.length - 1);
            this.highlightItem(items[index]);
            break;
          case 'ArrowUp':
            e.preventDefault();
            index = Math.max(index - 1, 0);
            this.highlightItem(items[index]);
            break;
          case 'Enter':
            e.preventDefault();
            if (current) current.click();
            break;
          case 'Escape':
            e.preventDefault();
            this.close();
            break;
        }
      }
      
      highlightItem(item) {
        this.dropdown.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
        if (item) item.classList.add('selected');
      }
    }
    
    // åˆå§‹åŒ–æ‰€æœ‰æœç´¢ä¸‹æ‹‰æ¡†
    const searchableSelects = {};
    $$('.searchable-select').forEach(container => {
      const targetId = container.dataset.target;
      searchableSelects[targetId] = new SearchableSelect(container);
    });

    try {
      const safeStorage = { get(k){try{return localStorage.getItem(k)}catch(e){return null}}, set(k,v){try{localStorage.setItem(k,v)}catch(e){}} };

      const state = {
          items: /** @type {Array<{img:string, topic_id?:string, æ ‡é¢˜?:string, ä¸€çº§è¡Œä¸š?:string, äºŒçº§è¡Œä¸š?:string, ä¸‰çº§è¡Œä¸š?:string, ç´¯è®¡å®šæ‹›å“æ•°?:string, å®¢æˆ·åå­—?:string, åº—é“ºID?:string}>} */([]),
          fit: safeStorage.get('fit') || 'contain', size: +(safeStorage.get('size') || 240), gap: +(safeStorage.get('gap') || 12), radius: +(safeStorage.get('radius') || 12),
          noNetwork: safeStorage.get('noNetwork') === '1', dragMode: false,
          q: '', sel1: '', sel2: '', sel3: '', selCustomer: '', selShop: '',
        };

      let lastRendered = [];

      const grid = $('#grid'); const countTotalEl = $('#countTotal'); const countFilteredEl = $('#countFiltered');

      function setImportState(cls, msg){
        if (!importState) return;
        importState.className = 'status inline ' + (cls||'');
        importState.textContent = 'å¯¼å…¥ï¼š' + msg;
      }
      function setBusy(v, msg){
        $$('.btn, input, select, textarea').forEach(el => {
          if (el.id && el.id.startsWith('ephemeralFile')) return;
          if (el.tagName === 'BUTTON') el.disabled = !!v;
        });
        if (busy){ busy.classList.toggle('show', !!v); busy.setAttribute('aria-hidden', String(!v)); }
        if (busyText && msg) busyText.textContent = msg;
      }

      function normalizeUrl(u){
        try{
          if(u==null) return '';
          u = String(u).trim();
          if(!u) return '';
          if(u.startsWith('//')) return 'https:' + u;
          if(/^[\w.-]+\.[A-Za-z]{2,}(?::\d{2,5})?\/.+/i.test(u)) return 'https://' + u;
          if(/^data:image\//i.test(u)) return u;
          if(!/^https?:\/\//i.test(u)) return '';
          return u;
        }catch{ return ''; }
      }

      function parseCSVorTSV(text){
        text = text.replace(/^\uFEFF/, '');
        const first = (text.split(/\r?\n/).find(l => l.trim().length) || '');
        const sep = ((first.match(/\t/g)||[]).length > (first.match(/,/g)||[]).length) ? '\t' : ',';
        function parseDSV(str, d){
          const rows=[]; let row=[], field='', inQ=false;
          for(let i=0;i<str.length;i++){
            const c=str[i], n=str[i+1];
            if(inQ){
              if(c === '"' && n === '"'){ field+='"'; i++; continue; }
              if(c === '"'){ inQ = false; continue; }
              field += c;
            }else{
              if(c === '"'){ inQ = true; continue; }
              if(c === d){ row.push(field); field=''; continue; }
              if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=''; continue; }
              if(c === '\r'){ continue; }
              field += c;
            }
          }
          row.push(field); rows.push(row);
          return rows.filter(r=>r.some(x=>String(x).trim().length));
        }
        const rows = parseDSV(text, sep);
        if(!rows.length) return [];
        return { header: rows[0], body: rows.slice(1) };
      }

      const ALIASES = {
        'topic_id':['topic_id','topicid','topic id','id','ç¼–å·','ä¸»é¢˜id','è¯é¢˜id'],
        'æ ‡é¢˜':['æ ‡é¢˜','title','é¢˜ç›®','åç§°','ä¸»é¢˜','topic','name'],
        'ç¤ºä¾‹å›¾ç‰‡ç¬¬ä¸€ä¸ª':['ç¤ºä¾‹å›¾ç‰‡ç¬¬ä¸€ä¸ª','ç¤ºä¾‹å›¾ç‰‡','å›¾ç‰‡é“¾æ¥','é¦–å›¾','ç¬¬ä¸€å¼ å›¾ç‰‡','å›¾ç‰‡','image','img','picture','pic','thumb','thumbnail','å°é¢'],
        'ä¸€çº§è¡Œä¸š':['ä¸€çº§è¡Œä¸š','ä¸€çº§ç±»ç›®','ä¸€çº§','è¡Œä¸š1','cat1','category1','ä¸€çº§åˆ†ç±»'],
        'äºŒçº§è¡Œä¸š':['äºŒçº§è¡Œä¸š','äºŒçº§ç±»ç›®','äºŒçº§','è¡Œä¸š2','cat2','category2','äºŒçº§åˆ†ç±»'],
        'ä¸‰çº§è¡Œä¸š':['ä¸‰çº§è¡Œä¸š','ä¸‰çº§ç±»ç›®','ä¸‰çº§','è¡Œä¸š3','cat3','category3','ä¸‰çº§åˆ†ç±»'],
        'ç´¯è®¡å®šæ‹›å“æ•°':['ç´¯è®¡å®šæ‹›å“æ•°','ç´¯è®¡å®šæ‹›å“','å®šæ‹›å“æ•°','æ€»å®šæ‹›å“æ•°','æ€»æ•°','count','æ•°é‡','ä»¶æ•°','ç´¯è®¡æ•°'],
        'å®¢æˆ·åå­—':['å®¢æˆ·åå­—','å®¢æˆ·åç§°','å®¢æˆ·','å®¢æˆ·å…¬å¸','å…¬å¸åç§°','company','client','customer','å®¢æˆ·å'],
        'åº—é“ºID':['åº—é“ºID','åº—é“ºid','åº—é“ºç¼–å·','åº—é“ºå·','shop_id','shopid','shop id','store_id','storeid','store id','é—¨åº—ID','é—¨åº—ç¼–å·']
      };
      const REQUIRED = ['ç¤ºä¾‹å›¾ç‰‡ç¬¬ä¸€ä¸ª'];
      const hnorm = s => String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[_\-â€“â€”]/g,'').replace(/[ï¼ˆï¼‰()\[\]ã€ã€‘ã€ï¼Œ,ã€‚.;ï¼›:ï¼š'"\u201c\u201d\u2018\u2019]/g,'');
      function findIndexByAliases(header, alias){ const nh = header.map(h=>hnorm(h)); for(const a of alias){ const idx=nh.indexOf(hnorm(a)); if(idx!==-1) return idx; } return -1; }
      function mapRowsToRecords(header, body){
        const idxMap={}; for(const k in ALIASES){ idxMap[k]=findIndexByAliases(header, ALIASES[k]); }
        for(const req of REQUIRED){ if(idxMap[req]===-1) throw new Error('ç¼ºå°‘å…³é”®åˆ—ï¼š'+req+'ï¼ˆå¯ç”¨åˆ«åï¼š'+ALIASES[req].join('/')+'ï¼‰'); }
        const out=[];
        for(const cols of body){
          const rec={
            topic_id: idxMap['topic_id']>=0?cols[idxMap['topic_id']]:'' ,
            æ ‡é¢˜: idxMap['æ ‡é¢˜']>=0?cols[idxMap['æ ‡é¢˜']]:'' ,
            img: normalizeUrl(idxMap['ç¤ºä¾‹å›¾ç‰‡ç¬¬ä¸€ä¸ª']>=0?cols[idxMap['ç¤ºä¾‹å›¾ç‰‡ç¬¬ä¸€ä¸ª']]:''),
            ä¸€çº§è¡Œä¸š: idxMap['ä¸€çº§è¡Œä¸š']>=0?cols[idxMap['ä¸€çº§è¡Œä¸š']]:'' ,
            äºŒçº§è¡Œä¸š: idxMap['äºŒçº§è¡Œä¸š']>=0?cols[idxMap['äºŒçº§è¡Œä¸š']]:'' ,
            ä¸‰çº§è¡Œä¸š: idxMap['ä¸‰çº§è¡Œä¸š']>=0?cols[idxMap['ä¸‰çº§è¡Œä¸š']]:'' ,
            ç´¯è®¡å®šæ‹›å“æ•°: idxMap['ç´¯è®¡å®šæ‹›å“æ•°']>=0?cols[idxMap['ç´¯è®¡å®šæ‹›å“æ•°']]:'' ,
            å®¢æˆ·åå­—: idxMap['å®¢æˆ·åå­—']>=0?cols[idxMap['å®¢æˆ·åå­—']]:'' ,
            åº—é“ºID: idxMap['åº—é“ºID']>=0?cols[idxMap['åº—é“ºID']]:''
          };
          if(rec.img) out.push(rec);
        }
        return out;
      }
      function parseCSV(text){ const parsed=parseCSVorTSV(text); if(!parsed||!parsed.header) return []; return mapRowsToRecords(parsed.header, parsed.body); }

      async function parseXLSXFile(file){
        if (typeof XLSX === 'undefined'){ throw new Error('æœªæ£€æµ‹åˆ° XLSX å¼•æ“ã€‚è¯·è”ç½‘åé‡è¯•ï¼Œæˆ–åœ¨ Excel ä¸­å¦å­˜ä¸º CSV/TSV å†å¯¼å…¥ã€‚'); }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const usedSheets = []; let total = 0, firstHeaders = [];
        for (const name of wb.SheetNames){
          const ws = wb.Sheets[name];
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });
          if (!rows || !rows.length) continue;
          const header = rows[0].map(x=>String(x||''));
          if (!firstHeaders.length) firstHeaders = header;
          const body = rows.slice(1).map(r => header.map((_,i)=> String(r[i] ?? '')));
          try {
            const recs = mapRowsToRecords(header, body);
            usedSheets.push(name);
            total += recs.length;
            state.items = state.items.concat(recs);
          } catch(e){ /* å¿½ç•¥æœªåŒ¹é…çš„è¡¨ */ }
        }
        if (!total){ throw new Error('æ‰€æœ‰å·¥ä½œè¡¨å‡æœªåŒ¹é…åˆ°éœ€è¦çš„åˆ—ã€‚ç¤ºä¾‹è¡¨å¤´ï¼š' + JSON.stringify(firstHeaders)); }
        return { usedSheets, total };
      }

      function savePrefs(){ safeStorage.set('fit', state.fit); safeStorage.set('size', String(state.size)); safeStorage.set('gap', String(state.gap)); safeStorage.set('radius', String(state.radius)); safeStorage.set('noNetwork', state.noNetwork?'1':'0'); }
      function applyVars(){
        document.documentElement.style.setProperty('--cell-size', state.size+'px');
        document.documentElement.style.setProperty('--gap', state.gap+'px');
        document.documentElement.style.setProperty('--radius', state.radius+'px');
        document.documentElement.style.setProperty('--fit', state.fit);
        const sz=$('#sizeVal'), gp=$('#gapVal'), rd=$('#radiusVal');
        if(sz) sz.textContent=state.size+'px'; if(gp) gp.textContent=state.gap+'px'; if(rd) rd.textContent=state.radius+'px';
        savePrefs();
      }

      // ç»Ÿè®¡æ’åºï¼šç”¨äºä¸€çº§è¡Œä¸šæŒ‰æ•°é‡é™åº
      function sortByFreq(values){
        const freq = new Map();
        for(const v of values){ 
          const key=(v||'').trim(); 
          if(!key) continue; 
          freq.set(key, (freq.get(key)||0)+1); 
        }
        return Array.from(freq.entries()).sort((a,b)=> b[1]-a[1] ).map(([k])=>k);
      }
      
      // å»é‡å¹¶æŒ‰å­—æ¯æ’åºï¼šè¿‡æ»¤ç©ºå€¼å’Œç©ºå­—ç¬¦ä¸²
      function uniqAlpha(list){ 
        return Array.from(new Set(
          list.filter(x => x && String(x).trim())
              .map(s => String(s).trim())
        )).sort((a,b) => a.localeCompare(b,'zh-Hans-CN')); 
      }

      // ç¼“å­˜ä¼˜åŒ–ï¼šé¿å…é‡å¤è®¡ç®—
      let filterCache = new Map();
      let lastCacheKey = '';
      
      function refreshFilterOptionsCascading(){
        try {
          const sel1=$('#sel1'), sel2=$('#sel2'), sel3=$('#sel3'), selCustomer=$('#selCustomer'), selShop=$('#selShop'); 
          if(!sel1||!sel2||!sel3||!selCustomer||!selShop) return;
        const s1=state.sel1||'', s2=state.sel2||'', s3=state.sel3||'', sCust=state.selCustomer||'', sShop=state.selShop||''; 
        const all=state.items;
        
        // ç”Ÿæˆç¼“å­˜é”®
        const cacheKey = `${all.length}-${sCust}-${sShop}-${s1}-${s2}`;
        if (cacheKey === lastCacheKey && filterCache.has(cacheKey)) {
          return; // ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
        }

        // å®¢æˆ·åå­—ï¼šæŒ‰å­—å…¸åºï¼ˆåªåœ¨æ•°æ®å˜åŒ–æ—¶é‡æ–°è®¡ç®—ï¼‰
        let optsCust = filterCache.get('customers');
        if (!optsCust || filterCache.get('dataLength') !== all.length) {
          optsCust = uniqAlpha(all.map(x=>x.å®¢æˆ·åå­—));
          filterCache.set('customers', optsCust);
          filterCache.set('dataLength', all.length);
        }
        
        // åº—é“ºIDï¼šè·Ÿéšå®¢æˆ·åå­—ç­›é€‰åï¼Œä½¿ç”¨å­—å…¸åº
        const itemsShop = sCust ? all.filter(x=>(x.å®¢æˆ·åå­—||'')===sCust) : all; 
        const optsShop = uniqAlpha(itemsShop.map(x=>x.åº—é“ºID));
        
        // ä¸€çº§è¡Œä¸šï¼šæ”¯æŒç‹¬ç«‹ç­›é€‰ï¼Œä¼˜å…ˆæŒ‰å®¢æˆ·å’Œåº—é“ºç­›é€‰ï¼Œå¦‚æœéƒ½æ²¡é€‰æ‹©åˆ™æ˜¾ç¤ºå…¨éƒ¨
        const items1Base = sCust ? (sShop ? itemsShop.filter(x=>(x.åº—é“ºID||'')===sShop) : itemsShop) : all;
        const opts1 = sortByFreq(items1Base.map(x=>x.ä¸€çº§è¡Œä¸š));
        
        // äºŒçº§ï¼šæ”¯æŒç‹¬ç«‹ç­›é€‰ï¼Œå¯ä»¥åŸºäºä¸€çº§è¡Œä¸šç­›é€‰ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹ä½¿ç”¨
         let items2Base;
         if (sCust) {
           // å¦‚æœé€‰æ‹©äº†å®¢æˆ·ï¼ŒåŸºäºå®¢æˆ·æ•°æ®
           items2Base = sShop ? itemsShop.filter(x=>(x.åº—é“ºID||'')===sShop) : itemsShop;
           // åœ¨å®¢æˆ·æ•°æ®åŸºç¡€ä¸Šåº”ç”¨ä¸€çº§è¡Œä¸šç­›é€‰
           items2Base = s1 ? items2Base.filter(x=>(x.ä¸€çº§è¡Œä¸š||'')===s1) : items2Base;
         } else if (s1) {
           // å¦‚æœæ²¡é€‰å®¢æˆ·ä½†é€‰äº†ä¸€çº§è¡Œä¸šï¼ŒåŸºäºä¸€çº§è¡Œä¸šç­›é€‰
           items2Base = all.filter(x=>(x.ä¸€çº§è¡Œä¸š||'')===s1);
         } else {
           // éƒ½æ²¡é€‰æ‹©ï¼Œæ˜¾ç¤ºå…¨éƒ¨
           items2Base = all;
         }
         const opts2 = uniqAlpha(items2Base.map(x=>x.äºŒçº§è¡Œä¸š));
        
        // ä¸‰çº§ï¼šæ”¯æŒç‹¬ç«‹ç­›é€‰ï¼Œå¯ä»¥åŸºäºä¸€çº§ã€äºŒçº§è¡Œä¸šç­›é€‰ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹ä½¿ç”¨
        let items3Base;
        if (sCust) {
          // å¦‚æœé€‰æ‹©äº†å®¢æˆ·ï¼ŒåŸºäºå®¢æˆ·æ•°æ®
          items3Base = items2Base;
        } else if (s1 || s2) {
          // å¦‚æœæ²¡é€‰å®¢æˆ·ä½†é€‰äº†è¡Œä¸šï¼ŒåŸºäºè¡Œä¸šç­›é€‰
          items3Base = all;
          if (s1) items3Base = items3Base.filter(x=>(x.ä¸€çº§è¡Œä¸š||'')===s1);
          if (s2) items3Base = items3Base.filter(x=>(x.äºŒçº§è¡Œä¸š||'')===s2);
        } else {
          // éƒ½æ²¡é€‰æ‹©ï¼Œæ˜¾ç¤ºå…¨éƒ¨
          items3Base = all;
        }
        const items3 = s2 && (sCust || s1) ? items3Base.filter(x=>(x.äºŒçº§è¡Œä¸š||'')===s2) : items3Base; 
        const opts3 = uniqAlpha(items3.map(x=>x.ä¸‰çº§è¡Œä¸š));

        function fill(sel, opts, cur){
          // æ›´æ–°åŸå§‹select
          sel.innerHTML='';
          const mk=(v,t)=>{ const o=document.createElement('option'); o.value=v; o.textContent=t||v||'å…¨éƒ¨'; return o; };
          sel.appendChild(mk('', 'å…¨éƒ¨'));
          opts.forEach(v=>sel.appendChild(mk(v)));
          sel.value = opts.includes(cur) ? cur : '';
          
          // æ›´æ–°å¯¹åº”çš„æœç´¢ä¸‹æ‹‰æ¡†
          const searchableSelect = searchableSelects[sel.id];
          if (searchableSelect) {
            const options = [{ value: '', text: 'å…¨éƒ¨' }].concat(opts.map(v => ({ value: v, text: v })));
            searchableSelect.updateOptions(options);
            
            // è®¾ç½®å½“å‰å€¼
            const currentValue = opts.includes(cur) ? cur : '';
            const currentText = currentValue || ''; // ç•™ç©ºè€Œä¸æ˜¯æ˜¾ç¤º"å…¨éƒ¨"
            searchableSelect.input.value = currentText;
            searchableSelect.selectedValue = currentValue;
            
            // æ›´æ–°æ¸…é™¤æŒ‰é’®çŠ¶æ€
            searchableSelect.updateClearButton();
          }
        }

        fill(selCustomer, optsCust, sCust);
        const newCustValid = optsCust.includes(sCust); 
        let nsShop=sShop, ns1=s1, ns2=s2, ns3=s3; 
        
        // åªæœ‰åœ¨å®¢æˆ·æ— æ•ˆæ—¶æ‰æ¸…ç©ºå…¶ä»–é€‰æ‹©
        if(!newCustValid && sCust){ 
          nsShop=''; ns1=''; ns2=''; ns3=''; 
        }
        
        fill(selShop, optsShop, nsShop);
        const newShopValid = optsShop.includes(nsShop); 
        
        // åªæœ‰åœ¨åº—é“ºæ— æ•ˆæ—¶æ‰æ¸…ç©ºè¡Œä¸šé€‰æ‹©
        if(!newShopValid && nsShop){ 
          ns1=''; ns2=''; ns3=''; 
        }
        
        fill(sel1, opts1, ns1);
        const newS1Valid = opts1.includes(ns1); 
        
        // åªæœ‰åœ¨ä¸€çº§è¡Œä¸šæ— æ•ˆæ—¶æ‰æ¸…ç©ºä¸‹çº§é€‰æ‹©
        if(!newS1Valid && ns1){ 
          ns2=''; ns3=''; 
        }
        
        fill(sel2, opts2, ns2);
        const newS2Valid = opts2.includes(ns2); 
        
        // åªæœ‰åœ¨äºŒçº§è¡Œä¸šæ— æ•ˆæ—¶æ‰æ¸…ç©ºä¸‰çº§é€‰æ‹©
        if(!newS2Valid && ns2){ 
          ns3=''; 
        }
        
        fill(sel3, opts3, ns3);
        
        // æ›´æ–°çŠ¶æ€ä¸ºå®é™…æœ‰æ•ˆçš„å€¼
        state.selCustomer = newCustValid ? sCust : '';
        state.selShop = newShopValid ? nsShop : '';
        state.sel1 = newS1Valid ? ns1 : '';
        state.sel2 = newS2Valid ? ns2 : '';
        state.sel3 = ns3;
        
        // æ›´æ–°ç¼“å­˜é”®
        lastCacheKey = cacheKey;
        } catch (error) {
          console.error('ç­›é€‰é€»è¾‘é”™è¯¯:', error);
          markHealth(false, 'ç­›é€‰å¤±è´¥');
          // ä¸è¦æŠ›å‡ºé”™è¯¯ï¼Œé¿å…é—ªé€€
        }
      }

      function applyFilters(list){
        try {
          const q=(state.q||'').toLowerCase(); 
          const f1=state.sel1||''; 
          const f2=state.sel2||''; 
          const f3=state.sel3||''; 
          const fCust=state.selCustomer||''; 
          const fShop=state.selShop||'';
          
          return list.filter(x=>{
            const byTitle = q ? String(x.æ ‡é¢˜||'').toLowerCase().includes(q) : true;
            const by1 = f1? (x.ä¸€çº§è¡Œä¸š||'')===f1 : true;
            const by2 = f2? (x.äºŒçº§è¡Œä¸š||'')===f2 : true;
            const by3 = f3? (x.ä¸‰çº§è¡Œä¸š||'')===f3 : true;
            const byCust = fCust? (x.å®¢æˆ·åå­—||'')===fCust : true;
            const byShop = fShop? (x.åº—é“ºID||'')===fShop : true;
            return byTitle && by1 && by2 && by3 && byCust && byShop;
          });
        } catch (error) {
          console.error('ç­›é€‰åº”ç”¨é”™è¯¯:', error);
          markHealth(false, 'ç­›é€‰åº”ç”¨å¤±è´¥');
          return []; // è¿”å›ç©ºæ•°ç»„é¿å…é—ªé€€
        }
      }

      function render(){
        try {
          applyVars();
          if(countTotalEl) countTotalEl.textContent=String(state.items.length);
          const data = applyFilters(state.items);
          lastRendered = data;
          if(countFilteredEl) countFilteredEl.textContent=String(data.length);
          if(!grid) return;
          grid.innerHTML='';
          data.forEach((rec,idx)=>{
            const fig=document.createElement('figure'); fig.className='card'; fig.draggable=!!state.dragMode; fig.dataset.idx=String(idx);
            const box=document.createElement('div'); box.className='thumb loading';
            const img=document.createElement('img');
            img.loading='lazy'; img.decoding='async';
            img.alt = rec.æ ‡é¢˜ ? (rec.æ ‡é¢˜+'-'+(idx+1)) : ('image-'+(idx+1));
            img.referrerPolicy='no-referrer'; img.crossOrigin='anonymous';
            if(!state.noNetwork){ img.src=rec.img; } else { box.classList.remove('loading'); box.style.borderStyle='solid'; const tip=document.createElement('div'); tip.style.fontSize='12px'; tip.style.color='var(--muted)'; tip.textContent='å·²ç¦ç”¨å›¾ç‰‡åŠ è½½'; box.appendChild(tip); }
            img.addEventListener('load',()=>box.classList.remove('loading'));
            img.addEventListener('error',()=>{ box.classList.remove('loading'); box.classList.add('error'); });
            box.appendChild(img); fig.appendChild(box);
            const meta=document.createElement('div'); meta.className='meta';
            const title=document.createElement('div'); title.className='title'; title.textContent=(rec.æ ‡é¢˜||'(æ— æ ‡é¢˜)');
            const idline=document.createElement('div'); idline.textContent=`topic_idï¼š${rec.topic_id||'-'}`;
            const badges=document.createElement('div'); badges.className='badgelist'; const b=document.createElement('span'); b.className='badge'; b.textContent=`ç´¯è®¡å®šæ‹›å“æ•°: ${rec.ç´¯è®¡å®šæ‹›å“æ•°||'-'}`; badges.appendChild(b);
            meta.appendChild(title); meta.appendChild(idline); meta.appendChild(badges);
            fig.appendChild(meta);
            grid.appendChild(fig);
          });
        } catch (error) {
          console.error('æ¸²æŸ“é”™è¯¯:', error);
          markHealth(false, 'æ¸²æŸ“å¤±è´¥');
          // ä¸è¦æŠ›å‡ºé”™è¯¯ï¼Œé¿å…é—ªé€€
        }
      }

      // Lightbox
      const lb = $('#lightbox'); const lbImg=$('#lbImg'); const lbTitle=$('#lbTitle'); const lbTopic=$('#lbTopic'); const lbC1=$('#lbC1'); const lbC2=$('#lbC2'); const lbC3=$('#lbC3'); const lbCnt=$('#lbCnt'); const lbCust=$('#lbCust'); const lbShop=$('#lbShop'); const lbHref=$('#lbHref');
      function openLightbox(rec){ if(!lb) return; lb.classList.add('open'); lb.setAttribute('aria-hidden','false'); if(lbImg){ lbImg.src=rec.img; lbImg.alt=rec.æ ‡é¢˜||'preview'; } if(lbTitle) lbTitle.textContent=rec.æ ‡é¢˜||'(æ— æ ‡é¢˜)'; if(lbTopic) lbTopic.textContent=rec.topic_id||'-'; if(lbC1) lbC1.textContent=rec.ä¸€çº§è¡Œä¸š||'-'; if(lbC2) lbC2.textContent=rec.äºŒçº§è¡Œä¸š||'-'; if(lbC3) lbC3.textContent=rec.ä¸‰çº§è¡Œä¸š||'-'; if(lbCnt) lbCnt.textContent=rec.ç´¯è®¡å®šæ‹›å“æ•°||'-'; if(lbCust) lbCust.textContent=rec.å®¢æˆ·åå­—||'-'; if(lbShop) lbShop.textContent=rec.åº—é“ºID||'-'; if(lbHref){ lbHref.href=rec.img; lbHref.onclick=(e)=>{ e.stopPropagation(); }; }
        document.addEventListener('keydown', onEsc, { once: true }); }
      function closeLightbox(){ if(!lb) return; lb.classList.remove('open'); lb.setAttribute('aria-hidden','true'); if(lbImg) lbImg.removeAttribute('src'); }
      function onEsc(e){ if(e.key==='Escape') closeLightbox(); }
      if(lb){ lb.addEventListener('click',(e)=>{ if(e.target===lb) closeLightbox(); }); $('#btnClose')?.addEventListener('click',()=>closeLightbox()); $('#btnOpenNew')?.addEventListener('click',()=>{ if(lbHref&&lbHref.href) window.open(lbHref.href,'_blank'); }); $('#btnCopy')?.addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(lbHref.href); alert('å·²å¤åˆ¶é“¾æ¥'); }catch{ prompt('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š', lbHref.href); } }); }

      if(grid){
        grid.addEventListener('click', (e)=>{
          const fig = e.target.closest('figure.card');
          if(!fig) return;
          const idx = +fig.dataset.idx;
          const rec = lastRendered[idx];
          if(rec) openLightbox(rec);
        });
        grid.addEventListener('dblclick', (e)=>{
          const fig = e.target.closest('figure.card');
          if(!fig) return;
          const idx = +fig.dataset.idx;
          const rec = lastRendered[idx];
          if(rec) openLightbox(rec);
        });
      }

      // æŠ˜å /å…¨å±
      const btnCollapse = $('#btnCollapse');
      btnCollapse?.addEventListener('click', ()=>{
        document.body.classList.toggle('ui-collapsed');
        btnCollapse.textContent = document.body.classList.contains('ui-collapsed') ? 'å±•å¼€å·¥å…·æ ' : 'æŠ˜å å·¥å…·æ ';
      });
      document.addEventListener('keydown', (e)=>{ if(e.key === '`'){ e.preventDefault(); btnCollapse?.click(); } });

      const btnFullscreen = $('#btnFullscreen');
      const root = document.documentElement;
      btnFullscreen?.addEventListener('click', async ()=>{
        try{
          if(!document.fullscreenElement){
            await (document.body.requestFullscreen ? document.body.requestFullscreen() : root.requestFullscreen());
            btnFullscreen.textContent = 'é€€å‡ºå…¨å±';
          }else{
            await document.exitFullscreen();
            btnFullscreen.textContent = 'å…¨å±';
          }
        }catch(e){ alert('å…¨å±åˆ‡æ¢å¤±è´¥ï¼š' + (e.message||e)); }
      });
      document.addEventListener('fullscreenchange', ()=>{ if(!document.fullscreenElement) btnFullscreen.textContent = 'å…¨å±'; });

      // å¯¼å…¥/å¯¼å‡º + åŸºç¡€äº¤äº’
      async function openFileDialog(){
        setImportState('', 'ç­‰å¾…é€‰æ‹©â€¦');
        if (window.showOpenFilePicker){
          try {
            const handles = await window.showOpenFilePicker({
              multiple: false,
              types: [{ description:'æ–‡ä»¶', accept:{ 'text/plain':['.txt','.csv','.tsv'], 'text/csv':['.csv','.tsv'], 'application/vnd.ms-excel':['.xls'], 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx'] } }]
            });
            if (handles && handles[0]){
              const file = await handles[0].getFile();
              await handlePickedFile(file);
              return;
            }
          } catch (e) { }
        }
        // æ–‡ä»¶è¾“å…¥åŠŸèƒ½å·²ç¦ç”¨
        setImportState('warn', 'æ–‡ä»¶å¯¼å…¥åŠŸèƒ½å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨æ‹–æ‹½æˆ–ç²˜è´´åŠŸèƒ½ã€‚');
      }

      async function handlePickedFile(file){
        try{
          if(!file) return;
          setBusy(true, 'å¯¼å…¥ä¸­ï¼Œè¯·ç¨å€™â€¦');
          setImportState('', 'å¤„ç†ä¸­â€¦');
          const name = (file.name||'').toLowerCase();
          if(/\.(xlsx|xls)$/.test(name)){
            const res = await parseXLSXFile(file);
            alert('å·²å¯¼å…¥ '+res.total+' æ¡ï¼Œæ¥è‡ªå·¥ä½œè¡¨ï¼š'+res.usedSheets.join(', '));
          } else if(/\.(csv|tsv)$/.test(name)){
            const text=await file.text(); const recs=parseCSV(text); state.items=state.items.concat(recs); alert('å·²å¯¼å…¥ '+recs.length+' æ¡è®°å½•');
          } else if(/\.(txt)$/.test(name)){
            const text=await file.text();
            const urls=text.replace(/^\uFEFF/,'').split(/\r?\n|,|\s+/g).map(normalizeUrl).filter(Boolean);
            const added = Array.from(new Set(urls)).map(u=>({img:u}));
            state.items=state.items.concat(added); alert('å·²å¯¼å…¥é“¾æ¥ '+added.length+' æ¡');
          } else { alert('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼š' + name); setImportState('err','ä¸æ”¯æŒçš„ç±»å‹'); return; }
          refreshFilterOptionsCascading(); render();
          setImportState('ok', 'æˆåŠŸ');
        }catch(err){ console.error(err); setImportState('err','å¤±è´¥'); alert('å¯¼å…¥å¤±è´¥ï¼š' + (err.message||err)); }
        finally { setBusy(false); }
      }

      $('#btnAdd')?.addEventListener('click',()=>{
        const ta=$('#urlInput'); const raw=(ta&&ta.value)||'';
        const parts=raw.split(/\r?\n|,|\s+/g).map(normalizeUrl).filter(Boolean);
        const urls=Array.from(new Set(parts)); if(!urls.length){ alert('æ²¡æœ‰è¯†åˆ«åˆ°æœ‰æ•ˆå›¾ç‰‡é“¾æ¥'); return; }
        state.items=state.items.concat(urls.map(u=>({img:u}))); refreshFilterOptionsCascading(); render();
      });
      $('#urlInput')?.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ $('#btnAdd')?.click(); } });
      $('#btnSample')?.addEventListener('click',()=>{
        const ta=$('#urlInput'); if(!ta) return;
        const s=`//sc02.alicdn.com/kf/Hbb5f936a288f4ffeafd26f2a709d8883G.jpg
sc02.alicdn.com/kf/H2f432b7c7a4a4adfb18e2e6a5b2f28a8q.jpg`;
        ta.value=`${s}
${ta.value||''}`.trim();
      });

      // æ·»åŠ æµ‹è¯•æ•°æ®æŒ‰é’®
      $('#btnAddTestData')?.addEventListener('click',()=>{
        const testData = [
          {img: 'https://sc02.alicdn.com/kf/Hbb5f936a288f4ffeafd26f2a709d8883G.jpg', topic_id: '001', æ ‡é¢˜: 'æµ‹è¯•äº§å“1', å®¢æˆ·åå­—: 'å®¢æˆ·A', åº—é“ºID: 'SHOP001', ä¸€çº§è¡Œä¸š: 'ç”µå­äº§å“', äºŒçº§è¡Œä¸š: 'æ‰‹æœº', ä¸‰çº§è¡Œä¸š: 'æ™ºèƒ½æ‰‹æœº', ç´¯è®¡å®šæ‹›å“æ•°: '100'},
          {img: 'https://sc02.alicdn.com/kf/H2f432b7c7a4a4adfb18e2e6a5b2f28a8q.jpg', topic_id: '002', æ ‡é¢˜: 'æµ‹è¯•äº§å“2', å®¢æˆ·åå­—: 'å®¢æˆ·B', åº—é“ºID: 'SHOP002', ä¸€çº§è¡Œä¸š: 'æœè£…', äºŒçº§è¡Œä¸š: 'ç”·è£…', ä¸‰çº§è¡Œä¸š: 'è¡¬è¡«', ç´¯è®¡å®šæ‹›å“æ•°: '50'},
          {img: 'https://sc02.alicdn.com/kf/Hbb5f936a288f4ffeafd26f2a709d8883G.jpg', topic_id: '003', æ ‡é¢˜: 'æµ‹è¯•äº§å“3', å®¢æˆ·åå­—: 'å®¢æˆ·A', åº—é“ºID: 'SHOP003', ä¸€çº§è¡Œä¸š: 'å®¶å±…', äºŒçº§è¡Œä¸š: 'å¨å…·', ä¸‰çº§è¡Œä¸š: 'é”…å…·', ç´¯è®¡å®šæ‹›å“æ•°: '75'},
          {img: 'https://sc02.alicdn.com/kf/H2f432b7c7a4a4adfb18e2e6a5b2f28a8q.jpg', topic_id: '004', æ ‡é¢˜: 'æµ‹è¯•äº§å“4', å®¢æˆ·åå­—: 'å®¢æˆ·C', åº—é“ºID: 'SHOP004', ä¸€çº§è¡Œä¸š: 'ç”µå­äº§å“', äºŒçº§è¡Œä¸š: 'ç”µè„‘', ä¸‰çº§è¡Œä¸š: 'ç¬”è®°æœ¬', ç´¯è®¡å®šæ‹›å“æ•°: '120'},
          {img: 'https://sc02.alicdn.com/kf/Hbb5f936a288f4ffeafd26f2a709d8883G.jpg', topic_id: '005', æ ‡é¢˜: 'æµ‹è¯•äº§å“5', å®¢æˆ·åå­—: 'å®¢æˆ·B', åº—é“ºID: 'SHOP005', ä¸€çº§è¡Œä¸š: 'æœè£…', äºŒçº§è¡Œä¸š: 'å¥³è£…', ä¸‰çº§è¡Œä¸š: 'è¿è¡£è£™', ç´¯è®¡å®šæ‹›å“æ•°: '80'}
        ];
        state.items = state.items.concat(testData);
        refreshFilterOptionsCascading(); 
        render();
        alert('å·²æ·»åŠ  ' + testData.length + ' æ¡æµ‹è¯•æ•°æ®');
      });

      $('#btnClear')?.addEventListener('click',()=>{ if(confirm('æ¸…ç©ºç”»å»Šï¼Ÿ')){ state.items=[]; refreshFilterOptionsCascading(); render(); } });
      $('#btnClearAll')?.addEventListener('click',()=>{ if(confirm('æ¸…ç©ºè¾“å…¥ä¸ç”»å»Šï¼Ÿ')){ state.items=[]; const ta=$('#urlInput'); if(ta) ta.value=''; refreshFilterOptionsCascading(); render(); } });

      $('#btnImport')?.addEventListener('click', async ()=>{ await openFileDialog(); });
      $('#btnDownloadTemplate')?.addEventListener('click',()=>{
        // åˆ›å»ºæ•°æ®æ¨¡æ¿CSVå†…å®¹ - æŒ‰æ–°é¡ºåºæ’åˆ—
        const templateHeaders = ['topic_id', 'å®¢æˆ·åå­—', 'åº—é“ºID', 'æ ‡é¢˜', 'ç¤ºä¾‹å›¾ç‰‡ç¬¬ä¸€ä¸ª', 'ä¸€çº§è¡Œä¸š', 'äºŒçº§è¡Œä¸š', 'ä¸‰çº§è¡Œä¸š', 'ç´¯è®¡å®šæ‹›å“æ•°'];
        const templateData = [
          ['001', 'å®¢æˆ·A', 'SHOP001', 'ç¤ºä¾‹äº§å“1', 'https://example.com/image1.jpg', 'ç”µå­äº§å“', 'æ‰‹æœº', 'æ™ºèƒ½æ‰‹æœº', '100'],
          ['002', 'å®¢æˆ·B', 'SHOP002', 'ç¤ºä¾‹äº§å“2', 'https://example.com/image2.jpg', 'æœè£…', 'ç”·è£…', 'è¡¬è¡«', '50'],
          ['003', 'å®¢æˆ·A', 'SHOP003', 'ç¤ºä¾‹äº§å“3', 'https://example.com/image3.jpg', 'å®¶å±…', 'å¨å…·', 'é”…å…·', '75'],
          ['004', 'å®¢æˆ·C', 'SHOP004', 'ç¤ºä¾‹äº§å“4', 'https://example.com/image4.jpg', 'ç”µå­äº§å“', 'ç”µè„‘', 'ç¬”è®°æœ¬ç”µè„‘', '80'],
          ['005', 'å®¢æˆ·B', 'SHOP005', 'ç¤ºä¾‹äº§å“5', 'https://example.com/image5.jpg', 'å®¶å±…', 'å®¶å…·', 'æ²™å‘', '30']
        ];
        
        // ç”ŸæˆCSVå†…å®¹
        const csvContent = [templateHeaders, ...templateData]
          .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
          .join('\n');
        
        // æ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡
        const bom = '\uFEFF';
        const blob = new Blob([bom + csvContent], {type: 'text/csv;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'æ•°æ®å¯¼å…¥æ¨¡æ¿.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      });
      $('#btnExport')?.addEventListener('click',()=>{
        const links=state.items.map(x=>x.img).filter(Boolean);
        const blob=new Blob([links.join('\n')],{type:'text/plain;charset=utf-8'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='image-links.txt'; a.click(); URL.revokeObjectURL(a.href);
      });

      $('#fit')?.addEventListener('change',(e)=>{ state.fit=e.target.value; applyVars(); });
      $('#size')?.addEventListener('input',(e)=>{ state.size=+e.target.value; applyVars(); });
      $('#gap')?.addEventListener('input',(e)=>{ state.gap=+e.target.value; applyVars(); });
      $('#radius')?.addEventListener('input',(e)=>{ state.radius=+e.target.value; applyVars(); });
      $('#noNetwork')?.addEventListener('change',(e)=>{ state.noNetwork=e.target.checked; safeStorage.set('noNetwork', state.noNetwork?'1':'0'); render(); });
      $('#dragMode')?.addEventListener('change',(e)=>{ state.dragMode=e.target.checked; render(); });

      $('#sel1')?.addEventListener('change',(e)=>{ 
        try {
          state.sel1=e.target.value||''; 
          refreshFilterOptionsCascading(); 
          render(); 
        } catch (error) {
          console.error('ä¸€çº§è¡Œä¸šç­›é€‰é”™è¯¯:', error);
          markHealth(false, 'ä¸€çº§è¡Œä¸šç­›é€‰å¤±è´¥');
        }
      });
      $('#sel2')?.addEventListener('change',(e)=>{ 
        try {
          state.sel2=e.target.value||''; 
          refreshFilterOptionsCascading(); 
          render(); 
        } catch (error) {
          console.error('äºŒçº§è¡Œä¸šç­›é€‰é”™è¯¯:', error);
          markHealth(false, 'äºŒçº§è¡Œä¸šç­›é€‰å¤±è´¥');
        }
      });
      $('#sel3')?.addEventListener('change',(e)=>{ 
        try {
          state.sel3=e.target.value||''; 
          render(); 
        } catch (error) {
          console.error('ä¸‰çº§è¡Œä¸šç­›é€‰é”™è¯¯:', error);
          markHealth(false, 'ä¸‰çº§è¡Œä¸šç­›é€‰å¤±è´¥');
        }
      });
      $('#selCustomer')?.addEventListener('change',(e)=>{ 
        try {
          state.selCustomer=e.target.value||''; 
          refreshFilterOptionsCascading(); 
          render(); 
        } catch (error) {
          console.error('å®¢æˆ·ç­›é€‰é”™è¯¯:', error);
          markHealth(false, 'å®¢æˆ·ç­›é€‰å¤±è´¥');
        }
      });
      $('#selShop')?.addEventListener('change',(e)=>{ 
        try {
          state.selShop=e.target.value||''; 
          refreshFilterOptionsCascading(); 
          render(); 
        } catch (error) {
          console.error('åº—é“ºç­›é€‰é”™è¯¯:', error);
          markHealth(false, 'åº—é“ºç­›é€‰å¤±è´¥');
        }
      });
      $('#q')?.addEventListener('input',(e)=>{ state.q=e.target.value||''; render(); });

      try{ applyVars(); refreshFilterOptionsCascading(); render(); markHealth(true, 'è¿è¡Œæ­£å¸¸'); } catch(err){ markHealth(false, 'åˆå§‹åŒ–å¤±è´¥'); alert('åˆå§‹åŒ–å¤±è´¥ï¼š'+(err.message||err)); }

      window.addEventListener('error',(ev)=>{ console.error('[error]', ev.message||ev.error); markHealth(false, 'JSé”™è¯¯'); });
      window.addEventListener('unhandledrejection',(ev)=>{ console.error('[promise]', ev.reason); markHealth(false, 'å¼‚æ­¥é”™è¯¯'); });
    } catch (bootErr) {
      console.error('å¯åŠ¨å¤±è´¥', bootErr);
      markHealth(false, 'å¯åŠ¨å¼‚å¸¸');
    }
  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÊâπÈáèÂõæÁâáÈìæÊé•Â±ïÁ§∫Âô® - Â∑•ÂÖ∑‰∏≠ÂøÉ</title>
  <script>
    // Ë∫´‰ªΩÈ™åËØÅÊ£ÄÊü•
    const SESSION_KEY = 'toolcenter_auth';
    const REMEMBER_KEY = 'toolcenter_remember';
    
    function checkAuth() {
      const sessionAuth = sessionStorage.getItem(SESSION_KEY);
      const rememberAuth = localStorage.getItem(REMEMBER_KEY);
      
      if (sessionAuth === 'authenticated') {
        return true;
      }
      
      if (rememberAuth) {
        try {
          const authData = JSON.parse(rememberAuth);
          const expiryTime = new Date(authData.expiry);
          const now = new Date();
          
          if (now < expiryTime) {
            sessionStorage.setItem(SESSION_KEY, 'authenticated');
            return true;
          } else {
            localStorage.removeItem(REMEMBER_KEY);
          }
        } catch (e) {
          localStorage.removeItem(REMEMBER_KEY);
        }
      }
      
      return false;
    }
    
    // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•Ë∫´‰ªΩÈ™åËØÅ
    if (!checkAuth()) {
      window.location.href = './login.html';
    }
  </script>
  <style>
    :root { --cell-size: 240px; --gap: 12px; --radius: 12px;
      --bg: #ffffff; --panel: #f9f9f9; --text: #333333;
      --muted: #666666; --accent: #4da3ff; --border: #dddddd;  --nav-h: 52px; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Helvetica, Arial, "PingFang SC","Hiragino Sans GB","Microsoft YaHei", sans-serif; }
    .app { display: grid; grid-template-rows: auto auto auto 1fr; gap: 12px; min-height: 100%; }
    header { padding: 14px 18px; background: var(--panel); border-bottom: 1px solid var(--border); position: sticky;  z-index: 10; }
    header h1 { font-size: 18px; margin: 0 0 8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .controls, .filters { display: flex; flex-wrap: wrap; gap: 10px 16px; align-items: center; padding: 0 18px 8px; }
    .controls .row, .filters .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
    label { color: var(--muted); font-size: 12px; }
    input[type="text"], textarea, select { color: #333333; background: #ffffff; border: 1px solid #dddddd; border-radius: 10px; padding: 8px 10px; outline: none; min-width: 220px; }
    textarea { width: min(100%, 920px); height: 90px; resize: vertical; }
    input[type="range"] { width: 180px; }
    
    /* ÊêúÁ¥¢‰∏ãÊãâÊ°ÜÊ†∑Âºè */
    .searchable-select { position: relative; display: inline-block; min-width: 220px; }
    .searchable-select input { width: 100%; box-sizing: border-box; padding-right: 30px; }
    .searchable-select .clear-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; cursor: pointer; font-size: 16px; padding: 0; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; border-radius: 50%; }
    .searchable-select .clear-btn:hover { background: #f0f0f0; color: #666; }
    .searchable-select.has-value .clear-btn { display: flex; }
    .searchable-select .dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #ffffff; border: 1px solid #dddddd; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
    .searchable-select .dropdown.show { display: block; }
    .searchable-select .dropdown-item { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .searchable-select .dropdown-item:hover { background: #f7f7f7; }
    .searchable-select .dropdown-item.selected { background: #e3f2fd; color: #1976d2; }
    .searchable-select .dropdown-item:last-child { border-bottom: none; }
    .btn { appearance: none; border: 1px solid #dddddd; background: #ffffff; color: #333333; padding: 8px 12px; border-radius: 12px; cursor: pointer; transition: .15s ease; display:inline-block; }
    .btn:hover { border-color: #cfcfcf; background: #f7f7f7; transform: translateY(-1px); }
    .btn[disabled] { opacity: .6; cursor: not-allowed; transform: none; background: #f5f5f5; color: #999999; }
    .btn.primary { background: #1b65ff; border-color: #1b65ff; color: #ffffff; }
    .btn.destructive { background: #d64545; border-color: #d64545; color: #ffffff; }
    .hint { color: var(--muted); font-size: 12px; }
    .status { font-size: 12px; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; }
    .status.ok { color: #7ce38b; border-color: #2a3a2f; background: #122015; }
    .status.warn { color: #ffd27f; border-color: #4a3a1a; background: #2a1f0f; }
    .status.err { color: #ff9aa2; border-color: #4a2a2a; background: #2a1111; }
    .status.inline { margin-left:6px; }

    .gallery { padding: 12px 18px 38px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--cell-size), 1fr)); gap: var(--gap); align-items: start; }
    figure.card { margin: 0; padding: 10px; border-radius: 14px; background: var(--panel); border: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 8px; user-select: none; }
    .thumb { position: relative; overflow: hidden; border-radius: var(--radius); aspect-ratio: 1 / 1; background: #0c0f15; border: 1px dashed #1f2631;
      display: grid; place-items: center; cursor: zoom-in; }
    .thumb img { width: 100%; height: 100%; object-fit: var(--fit, contain); display: block; }
    .thumb.error { background: #1a1112; border-color: #402427; }
    .thumb.loading::after { content: "Âä†ËΩΩ‰∏≠‚Ä¶"; position: absolute; inset: auto 8px 8px auto; font-size: 11px; color: var(--muted);
      background: rgba(0,0,0,.28); padding: 2px 6px; border-radius: 6px; border: 1px solid #2a3240; }
    .meta { display: grid; grid-template-columns: 1fr; gap: 6px; font-size: 12px; color: var(--muted); }
    .meta .title { color: var(--text); font-weight: 600; font-size: 13px; }
    .badgelist { display: flex; flex-wrap: wrap; gap: 6px; }
    .badge { font-size: 11px; padding: 3px 8px; border-radius: 999px; border: 1px solid #e5e7eb; background: #f3f4f6; color: #555555; }

    .footer-tip { text-align: center; color: var(--muted); font-size: 12px; padding: 12px 0 24px; }
    a { color: var(--accent); text-decoration: none; }
    .kpi { color: var(--muted); font-size: 12px; }
    .drop { border: 1px dashed var(--border); border-radius: 10px; padding: 8px 10px; color: var(--muted); }
    .drop.over { border-color: var(--accent); color: var(--text); }

    /* ÂøôÁ¢åÈÅÆÁΩ© */
    .busy { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; align-items: center; justify-content: center; z-index: 99999; }
    .busy.show { display: flex; }
    .busy .box { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px 18px; display: flex; gap: 10px; align-items: center; color: var(--text); }
    .spinner { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #999; border-top-color: transparent; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ÊäòÂè†Ê†∑Âºè */
    body.ui-collapsed header .controls,
    body.ui-collapsed header .filters { display: none; }
    body.ui-collapsed header { padding-bottom: 8px; }
    .toolbar-right { margin-left: auto; display: inline-flex; gap: 8px; }

    /* Lightbox */
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,.75); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 100000; }
    .lightbox.open { display: flex; }
    .lightbox .panel { background: #fdfdfd; border: 1px solid #dddddd; border-radius: 16px; padding: 12px; display: grid; grid-template-columns: minmax(260px, 60vw) 260px; gap: 12px; max-height: 90vh; width: min(92vw, 1080px); color: #333333; }
    .lightbox .imgwrap { background: #0c0f15; border: 1px solid var(--border); border-radius: 12px; display: grid; place-items: center; overflow: auto; }
    .lightbox .imgwrap img { max-width: 100%; max-height: 86vh; object-fit: contain; }
    .lightbox .side { display: grid; grid-template-rows: auto 1fr auto; gap: 12px; }
    .lightbox .side h3 { margin: 0; font-size: 16px; }
    .kv { display: grid; grid-template-columns: 90px 1fr; gap: 2px 6px; font-size: 12px; line-height: 1.1; }
    .kv label { color: #666666; text-align: right; font-weight: 600; }
    .toolbar { display: flex; gap: 8px; justify-content: flex-end; }
    .btn.small { padding: 6px 10px; border-radius: 10px; font-size: 12px; }
  .kv div { color: #333333; background: #f8f9fa; border: 1px solid #eeeeee; padding: 2px 4px; border-radius: 6px; }

/* --- Global Navbar --- */
.navbar { position: sticky; top: 0; z-index: 9999; background: #ffffff; border-bottom: 1px solid #e5e7eb; }
.navbar .wrap { display: flex; align-items: center; gap: 10px; padding: 10px 16px; }
.navbar .brand { font-weight: 700; color: #111827; margin-right: 6px; }
.navbar .spacer { flex: 1; }
.navbar a.navlink { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 10px; color: #374151; text-decoration: none; font-size: 14px; transition: all 0.2s ease; }
.navbar a.navlink:hover { background: #f9fafb; border-color: #d1d5db; }
.navbar a.navlink.active { background: #1b65ff; border-color: #1b65ff; color: #ffffff; }

</style>
</head>
<body>

  <nav class="navbar" role="navigation" aria-label="‰∏ªÂØºËà™">
    <div class="wrap">
      <div class="brand">üõ†Ô∏è Â∑•ÂÖ∑‰∏≠ÂøÉ</div>
      <a class="navlink" href="./index.html">È¶ñÈ°µ</a>
      <a class="navlink active" href="./image-gallery.html" aria-current="page">ÊâπÈáèÂõæÁâáÂ±ïÁ§∫Âô®</a>
      <a class="navlink" href="./customer-search.html">ÂÆ¢Êà∑‰ø°ÊÅØÊêúÁ¥¢</a>
      <a class="navlink" href="./customer-card.html">ÂÆ¢Êà∑‰ø°ÊÅØÂç°ÁîüÊàêÂô®</a>
      <a class="navlink" href="./script-editor.html">ËØùÊúØÁºñËæëÂô®</a>
      <div class="spacer"></div>
    </div>
  </nav>

  <div class="app">
    <header>
      <h1>
        ÊâπÈáèÂõæÁâáÈìæÊé•Â±ïÁ§∫Âô® ¬∑ v6.7ÔºàÁ∫ßËÅîÁ≠õÈÄâ + ÊîæÂ§ßËØ¶ÊÉÖÔºâ
        <span id="xlsxState" class="status warn" title="Á¶ªÁ∫øÊó∂‰∏çÂä†ËΩΩÔºåÂØºÂÖ• .xlsx Âª∫ËÆÆÊîπÂ≠ò‰∏∫ CSV/TSV">XLSX ÂºïÊìéÔºöÊú™Âä†ËΩΩ</span>
        <span id="importState" class="status inline">ÂØºÂÖ•ÔºöÂ∞±Áª™</span>
        <span id="jsHealth" class="status ok">JSÔºöËøêË°åÊ≠£Â∏∏</span>
        <span class="toolbar-right">
          <button class="btn" id="btnCollapse">ÊäòÂè†Â∑•ÂÖ∑Ê†è</button>
          <button class="btn" id="btnFullscreen">ÂÖ®Â±è</button>
        </span>
      </h1>
      <div class="controls">
        <div class="row">
          <textarea id="urlInput" placeholder="Á≤òË¥¥ÂõæÁâáÁõ¥ÈìæÔºàÊØèË°å‰∏Ä‰∏™ÔºâÔºåÊàñÁÇπÂáª‚ÄúÂØºÂÖ•Êñá‰ª∂‚Äù„ÄÇÊîØÊåÅ //„ÄÅhttp(s)://„ÄÅË£∏ÂüüÂêçÔºàËá™Âä®Ë°• https://Ôºâ„ÄÇ"></textarea>
          <button class="btn primary" id="btnAdd">Ê∑ªÂä†Âà∞ÁîªÂªä</button>
          <button class="btn" id="btnImport">ÂØºÂÖ•Êñá‰ª∂(TXT/CSV/TSV/XLSX)</button>
          <button class="btn" id="btnDownloadTemplate">üìã ‰∏ãËΩΩÊ®°Êùø</button>
          <button class="btn" id="btnExport">ÂØºÂá∫ÊâÄÊúâÂõæÁâáÈìæÊé•</button>
          <button class="btn" id="btnSample">ÊèíÂÖ•Á§∫‰æã</button>
          <button class="btn" id="btnAddTestData">Ê∑ªÂä†ÊµãËØïÊï∞ÊçÆ</button>
          <button class="btn destructive" id="btnClear">Ê∏ÖÁ©∫ÁîªÂªä</button>
          <button class="btn destructive" id="btnClearAll">Ê∏ÖÁ©∫ËæìÂÖ•+ÁîªÂªä</button>
        </div>
        <div class="row">
          <label>Âç°ÁâáÂÆΩÂ∫¶</label>
          <input type="range" id="size" min="160" max="520" step="10" value="240" />
          <span class="hint" id="sizeVal">240px</span>
          <label>Èó¥Ë∑ù</label>
          <input type="range" id="gap" min="0" max="36" step="2" value="12" />
          <span class="hint" id="gapVal">12px</span>
          <label>ÂúÜËßí</label>
          <input type="range" id="radius" min="0" max="24" step="2" value="12" />
          <span class="hint" id="radiusVal">12px</span>
          <label>ÈÄÇÈÖç</label>
          <select id="fit">
            <option value="contain" selected>Á≠âÊØîÂÆåÊï¥(contain)</option>
            <option value="cover">Ë£ÅÂàáÂÖÖÊª°(cover)</option>
          </select>
          <label><input type="checkbox" id="dragMode" /> ÊéíÂ∫èÊ®°Âºè(ÊãñÊãΩÂç°Áâá)</label>
          <label><input type="checkbox" id="noNetwork" /> ‰ªÖÊòæÁ§∫‰ø°ÊÅØÔºà‰∏çÂä†ËΩΩÂõæÁâáÔºâ</label>
        </div>
        <div id="dropZone" class="row drop">‰πüÂèØÁõ¥Êé•ÊãñÊãΩ CSV/TSV/XLSX/TXT Âà∞Ê≠§Âå∫ÂüüÂØºÂÖ•</div>
        <div class="row hint">Ë°®Â§¥ÂèØÁî®Ëøë‰πâËØçÔºåËá™Âä®ËØÜÂà´Ôºötopic_id„ÄÅÊ†áÈ¢ò„ÄÅÁ§∫‰æãÂõæÁâáÁ¨¨‰∏Ä‰∏™ÔºàÂõæÁâáÈìæÊé•/È¶ñÂõæ/imgÁ≠âÔºâ„ÄÅ‰∏ÄÁ∫ß/‰∫åÁ∫ß/‰∏âÁ∫ßË°å‰∏ö„ÄÅÁ¥ØËÆ°ÂÆöÊãõÂìÅÊï∞„ÄÇ</div>
      </div>

      <div class="filters">
        <div class="card" style="flex:1 1 320px;">
          <div class="row">
            <label for="q">ÊêúÁ¥¢Ê†áÈ¢ò</label>
            <input type="text" id="q" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢Ê†áÈ¢ò..." style="min-width:260px" />
          </div>
          <div class="filter-group">
            <label>ÂÆ¢Êà∑ÂêçÂ≠ó</label>
            <div class="searchable-select" data-target="selCustomer">
              <input type="text" placeholder="ÊêúÁ¥¢ÊàñÈÄâÊã©ÂÆ¢Êà∑..." readonly />
              <button class="clear-btn" title="Ê∏ÖÈô§ÈÄâÊã©">√ó</button>
              <div class="dropdown"></div>
            </div>
            <label>Â∫óÈì∫ID</label>
            <div class="searchable-select" data-target="selShop">
              <input type="text" placeholder="ÊêúÁ¥¢ÊàñÈÄâÊã©Â∫óÈì∫ID..." readonly />
              <button class="clear-btn" title="Ê∏ÖÈô§ÈÄâÊã©">√ó</button>
              <div class="dropdown"></div>
            </div>
            <label>‰∏ÄÁ∫ßË°å‰∏ö</label>
            <div class="searchable-select" data-target="sel1">
              <input type="text" placeholder="ÊêúÁ¥¢ÊàñÈÄâÊã©‰∏ÄÁ∫ßË°å‰∏ö..." readonly />
              <button class="clear-btn" title="Ê∏ÖÈô§ÈÄâÊã©">√ó</button>
              <div class="dropdown"></div>
            </div>
            <label>‰∫åÁ∫ßË°å‰∏ö</label>
            <div class="searchable-select" data-target="sel2">
              <input type="text" placeholder="ÊêúÁ¥¢ÊàñÈÄâÊã©‰∫åÁ∫ßË°å‰∏ö..." readonly />
              <button class="clear-btn" title="Ê∏ÖÈô§ÈÄâÊã©">√ó</button>
              <div class="dropdown"></div>
            </div>
            <label>‰∏âÁ∫ßË°å‰∏ö</label>
            <div class="searchable-select" data-target="sel3">
              <input type="text" placeholder="ÊêúÁ¥¢ÊàñÈÄâÊã©‰∏âÁ∫ßË°å‰∏ö..." readonly />
              <button class="clear-btn" title="Ê∏ÖÈô§ÈÄâÊã©">√ó</button>
              <div class="dropdown"></div>
            </div>
            <span class="kpi">Â∑≤Á≠õÈÄâÔºö<b id="countFiltered">0</b> / ÊÄªÊï∞Ôºö<b id="countTotal">0</b></span>
          </div>
          <!-- ÈöêËóèÁöÑÂéüÂßãselectÂÖÉÁ¥† -->
          <div style="display: none;">
            <select id="selCustomer"><option value="">ÂÖ®ÈÉ®</option></select>
            <select id="selShop"><option value="">ÂÖ®ÈÉ®</option></select>
            <select id="sel1"><option value="">ÂÖ®ÈÉ®</option></select>
            <select id="sel2"><option value="">ÂÖ®ÈÉ®</option></select>
            <select id="sel3"><option value="">ÂÖ®ÈÉ®</option></select>
          </div>
        </div>
      </div>

    </header>

    <main class="gallery">
      <div id="grid" class="grid" aria-live="polite"></div>
      <div class="footer-tip">¬© 2025 ÊâπÈáèÂõæÁâáÈìæÊé•Â±ïÁ§∫Âô® ¬∑ Á∫ØÂâçÁ´ØÊú¨Âú∞ËøêË°åÔºå‰∏ç‰∏ä‰º†‰Ω†ÁöÑÊï∞ÊçÆ</div>
    </main>
  </div>

  <!-- Busy overlay -->
  <div id="busy" class="busy" aria-hidden="true">
    <div class="box"><span class="spinner"></span><span id="busyText">ÂØºÂÖ•‰∏≠ÔºåËØ∑Á®çÂÄô‚Ä¶</span></div>
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog">
    <div class="panel">
      <div class="imgwrap"><img id="lbImg" alt="preview" /></div>
      <div class="side">
        <h3 id="lbTitle">(Êó†Ê†áÈ¢ò)</h3>
        <div class="kv">
          <label>topic_id</label><div id="lbTopic">-</div>
          <label>‰∏ÄÁ∫ßË°å‰∏ö</label><div id="lbC1">-</div>
          <label>‰∫åÁ∫ßË°å‰∏ö</label><div id="lbC2">-</div>
          <label>‰∏âÁ∫ßË°å‰∏ö</label><div id="lbC3">-</div>
          <label>Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞</label><div id="lbCnt">-</div>
          <label>ÂÆ¢Êà∑ÂêçÂ≠ó</label><div id="lbCust">-</div>
          <label>Â∫óÈì∫ID</label><div id="lbShop">-</div>
          <label>ÂõæÁâáÈìæÊé•</label><div><a id="lbHref" href="#" target="_blank" rel="noreferrer noopener">Âú®Êñ∞Ê†áÁ≠æÊâìÂºÄ</a></div>
        </div>
        <div class="toolbar">
          <button class="btn small" id="btnCopy">Â§çÂà∂ÈìæÊé•</button>
          <button class="btn small" id="btnOpenNew">Êñ∞Ê†áÁ≠æÊâìÂºÄ</button>
          <button class="btn small" id="btnClose">ÂÖ≥Èó≠</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function loadXLSX(){
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
      s.async = true;
      s.onload = function(){ const x=document.getElementById('xlsxState'); if(x){ x.textContent='XLSX ÂºïÊìéÔºöÂ∑≤Âä†ËΩΩ'; x.className='status ok'; } };
      s.onerror = function(){ const x=document.getElementById('xlsxState'); if(x){ x.textContent='XLSX ÂºïÊìéÔºöÊú™Âä†ËΩΩÔºàÁ¶ªÁ∫øCSVÂèØÁî®Ôºâ'; x.className='status warn'; } };
      document.head.appendChild(s);
    })();
  </script>

  <script>
  'use strict';
  (function(){
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const jsHealth = $('#jsHealth');
    const importState = $('#importState');
    const busy = $('#busy'); const busyText = $('#busyText');

    function markHealth(ok, msg){
      if(!jsHealth) return;
      jsHealth.className = 'status ' + (ok ? 'ok' : 'err');
      jsHealth.textContent = 'JSÔºö' + (msg || (ok ? 'ËøêË°åÊ≠£Â∏∏' : 'ÂºÇÂ∏∏'));
    }

    // ÊêúÁ¥¢‰∏ãÊãâÊ°ÜÂäüËÉΩ
    class SearchableSelect {
      constructor(container) {
        this.container = container;
        this.input = container.querySelector('input');
        this.dropdown = container.querySelector('.dropdown');
        this.clearBtn = container.querySelector('.clear-btn');
        this.targetId = container.dataset.target;
        this.originalSelect = $('#' + this.targetId);
        this.options = [];
        this.selectedValue = '';
        this.isOpen = false;
        
        this.init();
      }
      
      init() {
        // ÁÇπÂáªËæìÂÖ•Ê°ÜÊòæÁ§∫‰∏ãÊãâ
        this.input.addEventListener('click', () => this.toggle());
        
        // ËæìÂÖ•ÊêúÁ¥¢
        this.input.addEventListener('input', (e) => this.filter(e.target.value));
        
        // Ê∏ÖÈô§ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        if (this.clearBtn) {
          this.clearBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.clear();
          });
        }
        
        // Â§±ÁÑ¶ÈöêËóè‰∏ãÊãâÔºàÂª∂Ëøü‰ª•ÂÖÅËÆ∏ÁÇπÂáªÈÄâÈ°πÔºâ
        this.input.addEventListener('blur', () => {
          setTimeout(() => this.close(), 150);
        });
        
        // ÈîÆÁõòÂØºËà™
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        
        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
        document.addEventListener('click', (e) => {
          if (!this.container.contains(e.target)) {
            this.close();
          }
        });
      }
      
      updateOptions(options) {
        this.options = options.map(opt => ({
          value: opt.value || opt,
          text: opt.text || opt,
          selected: opt.selected || false
        }));
        this.render();
      }
      
      render() {
        this.dropdown.innerHTML = '';
        const filteredOptions = this.options.filter(opt => 
          opt.text.toLowerCase().includes((this.input.value || '').toLowerCase())
        );
        
        filteredOptions.forEach(opt => {
          const item = document.createElement('div');
          item.className = 'dropdown-item' + (opt.selected ? ' selected' : '');
          item.textContent = opt.text;
          item.addEventListener('click', () => this.select(opt));
          this.dropdown.appendChild(item);
        });
        
        if (filteredOptions.length === 0) {
          const item = document.createElement('div');
          item.className = 'dropdown-item';
          item.textContent = 'Êó†ÂåπÈÖçÈÄâÈ°π';
          item.style.color = '#999';
          this.dropdown.appendChild(item);
        }
      }
      
      select(option) {
        this.selectedValue = option.value;
        // Â¶ÇÊûúÈÄâÊã©ÁöÑÊòØ"ÂÖ®ÈÉ®"ÈÄâÈ°πÔºåËæìÂÖ•Ê°ÜÁïôÁ©∫
        this.input.value = option.value === '' ? '' : option.text;
        this.input.removeAttribute('readonly');
        this.input.setAttribute('readonly', true);
        
        // Êõ¥Êñ∞Ê∏ÖÈô§ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
        this.updateClearButton();
        
        // Êõ¥Êñ∞ÂéüÂßãselect
        if (this.originalSelect) {
          this.originalSelect.value = option.value;
          this.originalSelect.dispatchEvent(new Event('change'));
        }
        
        this.close();
      }
      
      clear() {
        this.selectedValue = '';
        this.input.value = '';
        this.updateClearButton();
        
        // Êõ¥Êñ∞ÂéüÂßãselectÂπ∂Ëß¶Âèëchange‰∫ã‰ª∂
        if (this.originalSelect) {
          this.originalSelect.value = '';
          this.originalSelect.dispatchEvent(new Event('change'));
        }
        
        this.close();
      }
      
      updateClearButton() {
        if (this.clearBtn) {
          if (this.input.value && this.input.value.trim()) {
            this.container.classList.add('has-value');
          } else {
            this.container.classList.remove('has-value');
          }
        }
      }
      
      toggle() {
        if (this.isOpen) {
          this.close();
        } else {
          this.open();
        }
      }
      
      open() {
        this.isOpen = true;
        this.dropdown.classList.add('show');
        this.input.removeAttribute('readonly');
        this.input.focus();
        this.render();
      }
      
      close() {
        this.isOpen = false;
        this.dropdown.classList.remove('show');
        this.input.setAttribute('readonly', true);
      }
      
      filter(query) {
        this.render();
      }
      
      handleKeydown(e) {
        if (!this.isOpen) return;
        
        const items = this.dropdown.querySelectorAll('.dropdown-item');
        const current = this.dropdown.querySelector('.dropdown-item.selected');
        let index = Array.from(items).indexOf(current);
        
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            index = Math.min(index + 1, items.length - 1);
            this.highlightItem(items[index]);
            break;
          case 'ArrowUp':
            e.preventDefault();
            index = Math.max(index - 1, 0);
            this.highlightItem(items[index]);
            break;
          case 'Enter':
            e.preventDefault();
            if (current) current.click();
            break;
          case 'Escape':
            e.preventDefault();
            this.close();
            break;
        }
      }
      
      highlightItem(item) {
        this.dropdown.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
        if (item) item.classList.add('selected');
      }
    }
    
    // ÂàùÂßãÂåñÊâÄÊúâÊêúÁ¥¢‰∏ãÊãâÊ°Ü
    const searchableSelects = {};
    $$('.searchable-select').forEach(container => {
      const targetId = container.dataset.target;
      searchableSelects[targetId] = new SearchableSelect(container);
    });

    try {
      const safeStorage = { get(k){try{return localStorage.getItem(k)}catch(e){return null}}, set(k,v){try{localStorage.setItem(k,v)}catch(e){}} };

      const state = {
          items: /** @type {Array<{img:string, topic_id?:string, Ê†áÈ¢ò?:string, ‰∏ÄÁ∫ßË°å‰∏ö?:string, ‰∫åÁ∫ßË°å‰∏ö?:string, ‰∏âÁ∫ßË°å‰∏ö?:string, Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞?:string, ÂÆ¢Êà∑ÂêçÂ≠ó?:string, Â∫óÈì∫ID?:string}>} */([]),
          fit: safeStorage.get('fit') || 'contain', size: +(safeStorage.get('size') || 240), gap: +(safeStorage.get('gap') || 12), radius: +(safeStorage.get('radius') || 12),
          noNetwork: safeStorage.get('noNetwork') === '1', dragMode: false,
          q: '', sel1: '', sel2: '', sel3: '', selCustomer: '', selShop: '',
        };

      let lastRendered = [];

      const grid = $('#grid'); const countTotalEl = $('#countTotal'); const countFilteredEl = $('#countFiltered');

      function setImportState(cls, msg){
        if (!importState) return;
        importState.className = 'status inline ' + (cls||'');
        importState.textContent = 'ÂØºÂÖ•Ôºö' + msg;
      }
      function setBusy(v, msg){
        $$('.btn, input, select, textarea').forEach(el => {
          if (el.id && el.id.startsWith('ephemeralFile')) return;
          if (el.tagName === 'BUTTON') el.disabled = !!v;
        });
        if (busy){ busy.classList.toggle('show', !!v); busy.setAttribute('aria-hidden', String(!v)); }
        if (busyText && msg) busyText.textContent = msg;
      }

      function normalizeUrl(u){
        try{
          if(u==null) return '';
          u = String(u).trim();
          if(!u) return '';
          if(u.startsWith('//')) return 'https:' + u;
          if(/^[\w.-]+\.[A-Za-z]{2,}(?::\d{2,5})?\/.+/i.test(u)) return 'https://' + u;
          if(/^data:image\//i.test(u)) return u;
          if(!/^https?:\/\//i.test(u)) return '';
          return u;
        }catch{ return ''; }
      }

      function parseCSVorTSV(text){
        text = text.replace(/^\uFEFF/, '');
        const first = (text.split(/\r?\n/).find(l => l.trim().length) || '');
        const sep = ((first.match(/\t/g)||[]).length > (first.match(/,/g)||[]).length) ? '\t' : ',';
        function parseDSV(str, d){
          const rows=[]; let row=[], field='', inQ=false;
          for(let i=0;i<str.length;i++){
            const c=str[i], n=str[i+1];
            if(inQ){
              if(c === '"' && n === '"'){ field+='"'; i++; continue; }
              if(c === '"'){ inQ = false; continue; }
              field += c;
            }else{
              if(c === '"'){ inQ = true; continue; }
              if(c === d){ row.push(field); field=''; continue; }
              if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=''; continue; }
              if(c === '\r'){ continue; }
              field += c;
            }
          }
          row.push(field); rows.push(row);
          return rows.filter(r=>r.some(x=>String(x).trim().length));
        }
        const rows = parseDSV(text, sep);
        if(!rows.length) return [];
        return { header: rows[0], body: rows.slice(1) };
      }

      const ALIASES = {
        'topic_id':['topic_id','topicid','topic id','id','ÁºñÂè∑','‰∏ªÈ¢òid','ËØùÈ¢òid'],
        'Ê†áÈ¢ò':['Ê†áÈ¢ò','title','È¢òÁõÆ','ÂêçÁß∞','‰∏ªÈ¢ò','topic','name'],
        'Á§∫‰æãÂõæÁâáÁ¨¨‰∏Ä‰∏™':['Á§∫‰æãÂõæÁâáÁ¨¨‰∏Ä‰∏™','Á§∫‰æãÂõæÁâá','ÂõæÁâáÈìæÊé•','È¶ñÂõæ','Á¨¨‰∏ÄÂº†ÂõæÁâá','ÂõæÁâá','image','img','picture','pic','thumb','thumbnail','Â∞ÅÈù¢'],
        '‰∏ÄÁ∫ßË°å‰∏ö':['‰∏ÄÁ∫ßË°å‰∏ö','‰∏ÄÁ∫ßÁ±ªÁõÆ','‰∏ÄÁ∫ß','Ë°å‰∏ö1','cat1','category1','‰∏ÄÁ∫ßÂàÜÁ±ª'],
        '‰∫åÁ∫ßË°å‰∏ö':['‰∫åÁ∫ßË°å‰∏ö','‰∫åÁ∫ßÁ±ªÁõÆ','‰∫åÁ∫ß','Ë°å‰∏ö2','cat2','category2','‰∫åÁ∫ßÂàÜÁ±ª'],
        '‰∏âÁ∫ßË°å‰∏ö':['‰∏âÁ∫ßË°å‰∏ö','‰∏âÁ∫ßÁ±ªÁõÆ','‰∏âÁ∫ß','Ë°å‰∏ö3','cat3','category3','‰∏âÁ∫ßÂàÜÁ±ª'],
        'Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞':['Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞','Á¥ØËÆ°ÂÆöÊãõÂìÅ','ÂÆöÊãõÂìÅÊï∞','ÊÄªÂÆöÊãõÂìÅÊï∞','ÊÄªÊï∞','count','Êï∞Èáè','‰ª∂Êï∞','Á¥ØËÆ°Êï∞'],
        'ÂÆ¢Êà∑ÂêçÂ≠ó':['ÂÆ¢Êà∑ÂêçÂ≠ó','ÂÆ¢Êà∑ÂêçÁß∞','ÂÆ¢Êà∑','ÂÆ¢Êà∑ÂÖ¨Âè∏','ÂÖ¨Âè∏ÂêçÁß∞','company','client','customer','ÂÆ¢Êà∑Âêç'],
        'Â∫óÈì∫ID':['Â∫óÈì∫ID','Â∫óÈì∫id','Â∫óÈì∫ÁºñÂè∑','Â∫óÈì∫Âè∑','shop_id','shopid','shop id','store_id','storeid','store id','Èó®Â∫óID','Èó®Â∫óÁºñÂè∑']
      };
      const REQUIRED = ['Á§∫‰æãÂõæÁâáÁ¨¨‰∏Ä‰∏™'];
      const hnorm = s => String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[_\-‚Äì‚Äî]/g,'').replace(/[ÔºàÔºâ()\[\]„Äê„Äë„ÄÅÔºå,„ÄÇ.;Ôºõ:Ôºö'"\u201c\u201d\u2018\u2019]/g,'');
      function findIndexByAliases(header, alias){ const nh = header.map(h=>hnorm(h)); for(const a of alias){ const idx=nh.indexOf(hnorm(a)); if(idx!==-1) return idx; } return -1; }
      function mapRowsToRecords(header, body){
        const idxMap={}; for(const k in ALIASES){ idxMap[k]=findIndexByAliases(header, ALIASES[k]); }
        for(const req of REQUIRED){ if(idxMap[req]===-1) throw new Error('Áº∫Â∞ëÂÖ≥ÈîÆÂàóÔºö'+req+'ÔºàÂèØÁî®Âà´ÂêçÔºö'+ALIASES[req].join('/')+'Ôºâ'); }
        const out=[];
        for(const cols of body){
          const rec={
            topic_id: idxMap['topic_id']>=0?cols[idxMap['topic_id']]:'' ,
            Ê†áÈ¢ò: idxMap['Ê†áÈ¢ò']>=0?cols[idxMap['Ê†áÈ¢ò']]:'' ,
            img: normalizeUrl(idxMap['Á§∫‰æãÂõæÁâáÁ¨¨‰∏Ä‰∏™']>=0?cols[idxMap['Á§∫‰æãÂõæÁâáÁ¨¨‰∏Ä‰∏™']]:''),
            ‰∏ÄÁ∫ßË°å‰∏ö: idxMap['‰∏ÄÁ∫ßË°å‰∏ö']>=0?cols[idxMap['‰∏ÄÁ∫ßË°å‰∏ö']]:'' ,
            ‰∫åÁ∫ßË°å‰∏ö: idxMap['‰∫åÁ∫ßË°å‰∏ö']>=0?cols[idxMap['‰∫åÁ∫ßË°å‰∏ö']]:'' ,
            ‰∏âÁ∫ßË°å‰∏ö: idxMap['‰∏âÁ∫ßË°å‰∏ö']>=0?cols[idxMap['‰∏âÁ∫ßË°å‰∏ö']]:'' ,
            Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞: idxMap['Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞']>=0?cols[idxMap['Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞']]:'' ,
            ÂÆ¢Êà∑ÂêçÂ≠ó: idxMap['ÂÆ¢Êà∑ÂêçÂ≠ó']>=0?cols[idxMap['ÂÆ¢Êà∑ÂêçÂ≠ó']]:'' ,
            Â∫óÈì∫ID: idxMap['Â∫óÈì∫ID']>=0?cols[idxMap['Â∫óÈì∫ID']]:''
          };
          if(rec.img) out.push(rec);
        }
        return out;
      }
      function parseCSV(text){ const parsed=parseCSVorTSV(text); if(!parsed||!parsed.header) return []; return mapRowsToRecords(parsed.header, parsed.body); }

      async function parseXLSXFile(file){
        if (typeof XLSX === 'undefined'){ throw new Error('Êú™Ê£ÄÊµãÂà∞ XLSX ÂºïÊìé„ÄÇËØ∑ËÅîÁΩëÂêéÈáçËØïÔºåÊàñÂú® Excel ‰∏≠Âè¶Â≠ò‰∏∫ CSV/TSV ÂÜçÂØºÂÖ•„ÄÇ'); }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const usedSheets = []; let total = 0, firstHeaders = [];
        for (const name of wb.SheetNames){
          const ws = wb.Sheets[name];
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });
          if (!rows || !rows.length) continue;
          const header = rows[0].map(x=>String(x||''));
          if (!firstHeaders.length) firstHeaders = header;
          const body = rows.slice(1).map(r => header.map((_,i)=> String(r[i] ?? '')));
          try {
            const recs = mapRowsToRecords(header, body);
            usedSheets.push(name);
            total += recs.length;
            state.items = state.items.concat(recs);
          } catch(e){ /* ÂøΩÁï•Êú™ÂåπÈÖçÁöÑË°® */ }
        }
        if (!total){ throw new Error('ÊâÄÊúâÂ∑•‰ΩúË°®ÂùáÊú™ÂåπÈÖçÂà∞ÈúÄË¶ÅÁöÑÂàó„ÄÇÁ§∫‰æãË°®Â§¥Ôºö' + JSON.stringify(firstHeaders)); }
        return { usedSheets, total };
      }

      function savePrefs(){ safeStorage.set('fit', state.fit); safeStorage.set('size', String(state.size)); safeStorage.set('gap', String(state.gap)); safeStorage.set('radius', String(state.radius)); safeStorage.set('noNetwork', state.noNetwork?'1':'0'); }
      function applyVars(){
        document.documentElement.style.setProperty('--cell-size', state.size+'px');
        document.documentElement.style.setProperty('--gap', state.gap+'px');
        document.documentElement.style.setProperty('--radius', state.radius+'px');
        document.documentElement.style.setProperty('--fit', state.fit);
        const sz=$('#sizeVal'), gp=$('#gapVal'), rd=$('#radiusVal');
        if(sz) sz.textContent=state.size+'px'; if(gp) gp.textContent=state.gap+'px'; if(rd) rd.textContent=state.radius+'px';
        savePrefs();
      }

      // ÁªüËÆ°ÊéíÂ∫èÔºöÁî®‰∫é‰∏ÄÁ∫ßË°å‰∏öÊåâÊï∞ÈáèÈôçÂ∫è
      function sortByFreq(values){
        const freq = new Map();
        for(const v of values){ 
          const key=(v||'').trim(); 
          if(!key) continue; 
          freq.set(key, (freq.get(key)||0)+1); 
        }
        return Array.from(freq.entries()).sort((a,b)=> b[1]-a[1] ).map(([k])=>k);
      }
      
      // ÂéªÈáçÂπ∂ÊåâÂ≠óÊØçÊéíÂ∫èÔºöËøáÊª§Á©∫ÂÄºÂíåÁ©∫Â≠óÁ¨¶‰∏≤
      function uniqAlpha(list){ 
        return Array.from(new Set(
          list.filter(x => x && String(x).trim())
              .map(s => String(s).trim())
        )).sort((a,b) => a.localeCompare(b,'zh-Hans-CN')); 
      }

      // ÁºìÂ≠ò‰ºòÂåñÔºöÈÅøÂÖçÈáçÂ§çËÆ°ÁÆó
      let filterCache = new Map();
      let lastCacheKey = '';
      
      function refreshFilterOptionsCascading(){
        try {
          const sel1=$('#sel1'), sel2=$('#sel2'), sel3=$('#sel3'), selCustomer=$('#selCustomer'), selShop=$('#selShop'); 
          if(!sel1||!sel2||!sel3||!selCustomer||!selShop) return;
        const s1=state.sel1||'', s2=state.sel2||'', s3=state.sel3||'', sCust=state.selCustomer||'', sShop=state.selShop||''; 
        const all=state.items;
        
        // ÁîüÊàêÁºìÂ≠òÈîÆ
        const cacheKey = `${all.length}-${sCust}-${sShop}-${s1}-${s2}`;
        if (cacheKey === lastCacheKey && filterCache.has(cacheKey)) {
          return; // ‰ΩøÁî®ÁºìÂ≠òÔºåÈÅøÂÖçÈáçÂ§çËÆ°ÁÆó
        }

        // ÂÆ¢Êà∑ÂêçÂ≠óÔºöÊåâÂ≠óÂÖ∏Â∫èÔºàÂè™Âú®Êï∞ÊçÆÂèòÂåñÊó∂ÈáçÊñ∞ËÆ°ÁÆóÔºâ
        let optsCust = filterCache.get('customers');
        if (!optsCust || filterCache.get('dataLength') !== all.length) {
          optsCust = uniqAlpha(all.map(x=>x.ÂÆ¢Êà∑ÂêçÂ≠ó));
          filterCache.set('customers', optsCust);
          filterCache.set('dataLength', all.length);
        }
        
        // Â∫óÈì∫IDÔºöË∑üÈöèÂÆ¢Êà∑ÂêçÂ≠óÁ≠õÈÄâÂêéÔºå‰ΩøÁî®Â≠óÂÖ∏Â∫è
        const itemsShop = sCust ? all.filter(x=>(x.ÂÆ¢Êà∑ÂêçÂ≠ó||'')===sCust) : all; 
        const optsShop = uniqAlpha(itemsShop.map(x=>x.Â∫óÈì∫ID));
        
        // ‰∏ÄÁ∫ßË°å‰∏öÔºöÊîØÊåÅÁã¨Á´ãÁ≠õÈÄâÔºå‰ºòÂÖàÊåâÂÆ¢Êà∑ÂíåÂ∫óÈì∫Á≠õÈÄâÔºåÂ¶ÇÊûúÈÉΩÊ≤°ÈÄâÊã©ÂàôÊòæÁ§∫ÂÖ®ÈÉ®
        const items1Base = sCust ? (sShop ? itemsShop.filter(x=>(x.Â∫óÈì∫ID||'')===sShop) : itemsShop) : all;
        const opts1 = sortByFreq(items1Base.map(x=>x.‰∏ÄÁ∫ßË°å‰∏ö));
        
        // ‰∫åÁ∫ßÔºöÊîØÊåÅÁã¨Á´ãÁ≠õÈÄâÔºåÂèØ‰ª•Âü∫‰∫é‰∏ÄÁ∫ßË°å‰∏öÁ≠õÈÄâÔºå‰πüÂèØ‰ª•Áã¨Á´ã‰ΩøÁî®
         let items2Base;
         if (sCust) {
           // Â¶ÇÊûúÈÄâÊã©‰∫ÜÂÆ¢Êà∑ÔºåÂü∫‰∫éÂÆ¢Êà∑Êï∞ÊçÆ
           items2Base = sShop ? itemsShop.filter(x=>(x.Â∫óÈì∫ID||'')===sShop) : itemsShop;
           // Âú®ÂÆ¢Êà∑Êï∞ÊçÆÂü∫Á°Ä‰∏äÂ∫îÁî®‰∏ÄÁ∫ßË°å‰∏öÁ≠õÈÄâ
           items2Base = s1 ? items2Base.filter(x=>(x.‰∏ÄÁ∫ßË°å‰∏ö||'')===s1) : items2Base;
         } else if (s1) {
           // Â¶ÇÊûúÊ≤°ÈÄâÂÆ¢Êà∑‰ΩÜÈÄâ‰∫Ü‰∏ÄÁ∫ßË°å‰∏öÔºåÂü∫‰∫é‰∏ÄÁ∫ßË°å‰∏öÁ≠õÈÄâ
           items2Base = all.filter(x=>(x.‰∏ÄÁ∫ßË°å‰∏ö||'')===s1);
         } else {
           // ÈÉΩÊ≤°ÈÄâÊã©ÔºåÊòæÁ§∫ÂÖ®ÈÉ®
           items2Base = all;
         }
         const opts2 = uniqAlpha(items2Base.map(x=>x.‰∫åÁ∫ßË°å‰∏ö));
        
        // ‰∏âÁ∫ßÔºöÊîØÊåÅÁã¨Á´ãÁ≠õÈÄâÔºåÂèØ‰ª•Âü∫‰∫é‰∏ÄÁ∫ß„ÄÅ‰∫åÁ∫ßË°å‰∏öÁ≠õÈÄâÔºå‰πüÂèØ‰ª•Áã¨Á´ã‰ΩøÁî®
        let items3Base;
        if (sCust) {
          // Â¶ÇÊûúÈÄâÊã©‰∫ÜÂÆ¢Êà∑ÔºåÂü∫‰∫éÂÆ¢Êà∑Êï∞ÊçÆ
          items3Base = items2Base;
        } else if (s1 || s2) {
          // Â¶ÇÊûúÊ≤°ÈÄâÂÆ¢Êà∑‰ΩÜÈÄâ‰∫ÜË°å‰∏öÔºåÂü∫‰∫éË°å‰∏öÁ≠õÈÄâ
          items3Base = all;
          if (s1) items3Base = items3Base.filter(x=>(x.‰∏ÄÁ∫ßË°å‰∏ö||'')===s1);
          if (s2) items3Base = items3Base.filter(x=>(x.‰∫åÁ∫ßË°å‰∏ö||'')===s2);
        } else {
          // ÈÉΩÊ≤°ÈÄâÊã©ÔºåÊòæÁ§∫ÂÖ®ÈÉ®
          items3Base = all;
        }
        const items3 = s2 && (sCust || s1) ? items3Base.filter(x=>(x.‰∫åÁ∫ßË°å‰∏ö||'')===s2) : items3Base; 
        const opts3 = uniqAlpha(items3.map(x=>x.‰∏âÁ∫ßË°å‰∏ö));

        function fill(sel, opts, cur){
          // Êõ¥Êñ∞ÂéüÂßãselect
          sel.innerHTML='';
          const mk=(v,t)=>{ const o=document.createElement('option'); o.value=v; o.textContent=t||v||'ÂÖ®ÈÉ®'; return o; };
          sel.appendChild(mk('', 'ÂÖ®ÈÉ®'));
          opts.forEach(v=>sel.appendChild(mk(v)));
          sel.value = opts.includes(cur) ? cur : '';
          
          // Êõ¥Êñ∞ÂØπÂ∫îÁöÑÊêúÁ¥¢‰∏ãÊãâÊ°Ü
          const searchableSelect = searchableSelects[sel.id];
          if (searchableSelect) {
            const options = [{ value: '', text: 'ÂÖ®ÈÉ®' }].concat(opts.map(v => ({ value: v, text: v })));
            searchableSelect.updateOptions(options);
            
            // ËÆæÁΩÆÂΩìÂâçÂÄº
            const currentValue = opts.includes(cur) ? cur : '';
            const currentText = currentValue || ''; // ÁïôÁ©∫ËÄå‰∏çÊòØÊòæÁ§∫"ÂÖ®ÈÉ®"
            searchableSelect.input.value = currentText;
            searchableSelect.selectedValue = currentValue;
            
            // Êõ¥Êñ∞Ê∏ÖÈô§ÊåâÈíÆÁä∂ÊÄÅ
            searchableSelect.updateClearButton();
          }
        }

        fill(selCustomer, optsCust, sCust);
        const newCustValid = optsCust.includes(sCust); 
        let nsShop=sShop, ns1=s1, ns2=s2, ns3=s3; 
        
        // Âè™ÊúâÂú®ÂÆ¢Êà∑Êó†ÊïàÊó∂ÊâçÊ∏ÖÁ©∫ÂÖ∂‰ªñÈÄâÊã©
        if(!newCustValid && sCust){ 
          nsShop=''; ns1=''; ns2=''; ns3=''; 
        }
        
        fill(selShop, optsShop, nsShop);
        const newShopValid = optsShop.includes(nsShop); 
        
        // Âè™ÊúâÂú®Â∫óÈì∫Êó†ÊïàÊó∂ÊâçÊ∏ÖÁ©∫Ë°å‰∏öÈÄâÊã©
        if(!newShopValid && nsShop){ 
          ns1=''; ns2=''; ns3=''; 
        }
        
        fill(sel1, opts1, ns1);
        const newS1Valid = opts1.includes(ns1); 
        
        // Âè™ÊúâÂú®‰∏ÄÁ∫ßË°å‰∏öÊó†ÊïàÊó∂ÊâçÊ∏ÖÁ©∫‰∏ãÁ∫ßÈÄâÊã©
        if(!newS1Valid && ns1){ 
          ns2=''; ns3=''; 
        }
        
        fill(sel2, opts2, ns2);
        const newS2Valid = opts2.includes(ns2); 
        
        // Âè™ÊúâÂú®‰∫åÁ∫ßË°å‰∏öÊó†ÊïàÊó∂ÊâçÊ∏ÖÁ©∫‰∏âÁ∫ßÈÄâÊã©
        if(!newS2Valid && ns2){ 
          ns3=''; 
        }
        
        fill(sel3, opts3, ns3);
        
        // Êõ¥Êñ∞Áä∂ÊÄÅ‰∏∫ÂÆûÈôÖÊúâÊïàÁöÑÂÄº
        state.selCustomer = newCustValid ? sCust : '';
        state.selShop = newShopValid ? nsShop : '';
        state.sel1 = newS1Valid ? ns1 : '';
        state.sel2 = newS2Valid ? ns2 : '';
        state.sel3 = ns3;
        
        // Êõ¥Êñ∞ÁºìÂ≠òÈîÆ
        lastCacheKey = cacheKey;
        } catch (error) {
          console.error('Á≠õÈÄâÈÄªËæëÈîôËØØ:', error);
          markHealth(false, 'Á≠õÈÄâÂ§±Ë¥•');
          // ‰∏çË¶ÅÊäõÂá∫ÈîôËØØÔºåÈÅøÂÖçÈó™ÈÄÄ
        }
      }

      function applyFilters(list){
        try {
          const q=(state.q||'').toLowerCase(); 
          const f1=state.sel1||''; 
          const f2=state.sel2||''; 
          const f3=state.sel3||''; 
          const fCust=state.selCustomer||''; 
          const fShop=state.selShop||'';
          
          return list.filter(x=>{
            const byTitle = q ? String(x.Ê†áÈ¢ò||'').toLowerCase().includes(q) : true;
            const by1 = f1? (x.‰∏ÄÁ∫ßË°å‰∏ö||'')===f1 : true;
            const by2 = f2? (x.‰∫åÁ∫ßË°å‰∏ö||'')===f2 : true;
            const by3 = f3? (x.‰∏âÁ∫ßË°å‰∏ö||'')===f3 : true;
            const byCust = fCust? (x.ÂÆ¢Êà∑ÂêçÂ≠ó||'')===fCust : true;
            const byShop = fShop? (x.Â∫óÈì∫ID||'')===fShop : true;
            return byTitle && by1 && by2 && by3 && byCust && byShop;
          });
        } catch (error) {
          console.error('Á≠õÈÄâÂ∫îÁî®ÈîôËØØ:', error);
          markHealth(false, 'Á≠õÈÄâÂ∫îÁî®Â§±Ë¥•');
          return []; // ËøîÂõûÁ©∫Êï∞ÁªÑÈÅøÂÖçÈó™ÈÄÄ
        }
      }

      function render(){
        try {
          applyVars();
          if(countTotalEl) countTotalEl.textContent=String(state.items.length);
          const data = applyFilters(state.items);
          lastRendered = data;
          if(countFilteredEl) countFilteredEl.textContent=String(data.length);
          if(!grid) return;
          grid.innerHTML='';
          data.forEach((rec,idx)=>{
            const fig=document.createElement('figure'); fig.className='card'; fig.draggable=!!state.dragMode; fig.dataset.idx=String(idx);
            const box=document.createElement('div'); box.className='thumb loading';
            const img=document.createElement('img');
            img.loading='lazy'; img.decoding='async';
            img.alt = rec.Ê†áÈ¢ò ? (rec.Ê†áÈ¢ò+'-'+(idx+1)) : ('image-'+(idx+1));
            img.referrerPolicy='no-referrer'; img.crossOrigin='anonymous';
            if(!state.noNetwork){ img.src=rec.img; } else { box.classList.remove('loading'); box.style.borderStyle='solid'; const tip=document.createElement('div'); tip.style.fontSize='12px'; tip.style.color='var(--muted)'; tip.textContent='Â∑≤Á¶ÅÁî®ÂõæÁâáÂä†ËΩΩ'; box.appendChild(tip); }
            img.addEventListener('load',()=>box.classList.remove('loading'));
            img.addEventListener('error',()=>{ box.classList.remove('loading'); box.classList.add('error'); });
            box.appendChild(img); fig.appendChild(box);
            const meta=document.createElement('div'); meta.className='meta';
            const title=document.createElement('div'); title.className='title'; title.textContent=(rec.Ê†áÈ¢ò||'(Êó†Ê†áÈ¢ò)');
            const idline=document.createElement('div'); idline.textContent=`topic_idÔºö${rec.topic_id||'-'}`;
            const badges=document.createElement('div'); badges.className='badgelist'; const b=document.createElement('span'); b.className='badge'; b.textContent=`Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞: ${rec.Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞||'-'}`; badges.appendChild(b);
            meta.appendChild(title); meta.appendChild(idline); meta.appendChild(badges);
            fig.appendChild(meta);
            grid.appendChild(fig);
          });
        } catch (error) {
          console.error('Ê∏≤ÊüìÈîôËØØ:', error);
          markHealth(false, 'Ê∏≤ÊüìÂ§±Ë¥•');
          // ‰∏çË¶ÅÊäõÂá∫ÈîôËØØÔºåÈÅøÂÖçÈó™ÈÄÄ
        }
      }

      // Lightbox
      const lb = $('#lightbox'); const lbImg=$('#lbImg'); const lbTitle=$('#lbTitle'); const lbTopic=$('#lbTopic'); const lbC1=$('#lbC1'); const lbC2=$('#lbC2'); const lbC3=$('#lbC3'); const lbCnt=$('#lbCnt'); const lbCust=$('#lbCust'); const lbShop=$('#lbShop'); const lbHref=$('#lbHref');
      function openLightbox(rec){ if(!lb) return; lb.classList.add('open'); lb.setAttribute('aria-hidden','false'); if(lbImg){ lbImg.src=rec.img; lbImg.alt=rec.Ê†áÈ¢ò||'preview'; } if(lbTitle) lbTitle.textContent=rec.Ê†áÈ¢ò||'(Êó†Ê†áÈ¢ò)'; if(lbTopic) lbTopic.textContent=rec.topic_id||'-'; if(lbC1) lbC1.textContent=rec.‰∏ÄÁ∫ßË°å‰∏ö||'-'; if(lbC2) lbC2.textContent=rec.‰∫åÁ∫ßË°å‰∏ö||'-'; if(lbC3) lbC3.textContent=rec.‰∏âÁ∫ßË°å‰∏ö||'-'; if(lbCnt) lbCnt.textContent=rec.Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞||'-'; if(lbCust) lbCust.textContent=rec.ÂÆ¢Êà∑ÂêçÂ≠ó||'-'; if(lbShop) lbShop.textContent=rec.Â∫óÈì∫ID||'-'; if(lbHref){ lbHref.href=rec.img; lbHref.onclick=(e)=>{ e.stopPropagation(); }; }
        document.addEventListener('keydown', onEsc, { once: true }); }
      function closeLightbox(){ if(!lb) return; lb.classList.remove('open'); lb.setAttribute('aria-hidden','true'); if(lbImg) lbImg.removeAttribute('src'); }
      function onEsc(e){ if(e.key==='Escape') closeLightbox(); }
      if(lb){ lb.addEventListener('click',(e)=>{ if(e.target===lb) closeLightbox(); }); $('#btnClose')?.addEventListener('click',()=>closeLightbox()); $('#btnOpenNew')?.addEventListener('click',()=>{ if(lbHref&&lbHref.href) window.open(lbHref.href,'_blank'); }); $('#btnCopy')?.addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(lbHref.href); alert('Â∑≤Â§çÂà∂ÈìæÊé•'); }catch{ prompt('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂Ôºö', lbHref.href); } }); }

      if(grid){
        grid.addEventListener('click', (e)=>{
          const fig = e.target.closest('figure.card');
          if(!fig) return;
          const idx = +fig.dataset.idx;
          const rec = lastRendered[idx];
          if(rec) openLightbox(rec);
        });
        grid.addEventListener('dblclick', (e)=>{
          const fig = e.target.closest('figure.card');
          if(!fig) return;
          const idx = +fig.dataset.idx;
          const rec = lastRendered[idx];
          if(rec) openLightbox(rec);
        });
      }

      // ÊäòÂè†/ÂÖ®Â±è
      const btnCollapse = $('#btnCollapse');
      btnCollapse?.addEventListener('click', ()=>{
        document.body.classList.toggle('ui-collapsed');
        btnCollapse.textContent = document.body.classList.contains('ui-collapsed') ? 'Â±ïÂºÄÂ∑•ÂÖ∑Ê†è' : 'ÊäòÂè†Â∑•ÂÖ∑Ê†è';
      });
      document.addEventListener('keydown', (e)=>{ if(e.key === '`'){ e.preventDefault(); btnCollapse?.click(); } });

      const btnFullscreen = $('#btnFullscreen');
      const root = document.documentElement;
      btnFullscreen?.addEventListener('click', async ()=>{
        try{
          if(!document.fullscreenElement){
            await (document.body.requestFullscreen ? document.body.requestFullscreen() : root.requestFullscreen());
            btnFullscreen.textContent = 'ÈÄÄÂá∫ÂÖ®Â±è';
          }else{
            await document.exitFullscreen();
            btnFullscreen.textContent = 'ÂÖ®Â±è';
          }
        }catch(e){ alert('ÂÖ®Â±èÂàáÊç¢Â§±Ë¥•Ôºö' + (e.message||e)); }
      });
      document.addEventListener('fullscreenchange', ()=>{ if(!document.fullscreenElement) btnFullscreen.textContent = 'ÂÖ®Â±è'; });

      // ÂØºÂÖ•/ÂØºÂá∫ + Âü∫Á°Ä‰∫§‰∫í
      async function openFileDialog(){
        setImportState('', 'Á≠âÂæÖÈÄâÊã©‚Ä¶');
        if (window.showOpenFilePicker){
          try {
            const handles = await window.showOpenFilePicker({
              multiple: false,
              types: [{ description:'Êñá‰ª∂', accept:{ 'text/plain':['.txt','.csv','.tsv'], 'text/csv':['.csv','.tsv'], 'application/vnd.ms-excel':['.xls'], 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx'] } }]
            });
            if (handles && handles[0]){
              const file = await handles[0].getFile();
              await handlePickedFile(file);
              return;
            }
          } catch (e) { }
        }
        // Êñá‰ª∂ËæìÂÖ•ÂäüËÉΩÂ∑≤Á¶ÅÁî®
        setImportState('warn', 'Êñá‰ª∂ÂØºÂÖ•ÂäüËÉΩÂ∑≤Á¶ÅÁî®ÔºåËØ∑‰ΩøÁî®ÊãñÊãΩÊàñÁ≤òË¥¥ÂäüËÉΩ„ÄÇ');
      }

      async function handlePickedFile(file){
        try{
          if(!file) return;
          setBusy(true, 'ÂØºÂÖ•‰∏≠ÔºåËØ∑Á®çÂÄô‚Ä¶');
          setImportState('', 'Â§ÑÁêÜ‰∏≠‚Ä¶');
          const name = (file.name||'').toLowerCase();
          if(/\.(xlsx|xls)$/.test(name)){
            const res = await parseXLSXFile(file);
            alert('Â∑≤ÂØºÂÖ• '+res.total+' Êù°ÔºåÊù•Ëá™Â∑•‰ΩúË°®Ôºö'+res.usedSheets.join(', '));
          } else if(/\.(csv|tsv)$/.test(name)){
            const text=await file.text(); const recs=parseCSV(text); state.items=state.items.concat(recs); alert('Â∑≤ÂØºÂÖ• '+recs.length+' Êù°ËÆ∞ÂΩï');
          } else if(/\.(txt)$/.test(name)){
            const text=await file.text();
            const urls=text.replace(/^\uFEFF/,'').split(/\r?\n|,|\s+/g).map(normalizeUrl).filter(Boolean);
            const added = Array.from(new Set(urls)).map(u=>({img:u}));
            state.items=state.items.concat(added); alert('Â∑≤ÂØºÂÖ•ÈìæÊé• '+added.length+' Êù°');
          } else { alert('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûãÔºö' + name); setImportState('err','‰∏çÊîØÊåÅÁöÑÁ±ªÂûã'); return; }
          refreshFilterOptionsCascading(); render();
          setImportState('ok', 'ÊàêÂäü');
        }catch(err){ console.error(err); setImportState('err','Â§±Ë¥•'); alert('ÂØºÂÖ•Â§±Ë¥•Ôºö' + (err.message||err)); }
        finally { setBusy(false); }
      }

      $('#btnAdd')?.addEventListener('click',()=>{
        const ta=$('#urlInput'); const raw=(ta&&ta.value)||'';
        const parts=raw.split(/\r?\n|,|\s+/g).map(normalizeUrl).filter(Boolean);
        const urls=Array.from(new Set(parts)); if(!urls.length){ alert('Ê≤°ÊúâËØÜÂà´Âà∞ÊúâÊïàÂõæÁâáÈìæÊé•'); return; }
        state.items=state.items.concat(urls.map(u=>({img:u}))); refreshFilterOptionsCascading(); render();
      });
      $('#urlInput')?.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ $('#btnAdd')?.click(); } });
      $('#btnSample')?.addEventListener('click',()=>{
        const ta=$('#urlInput'); if(!ta) return;
        const s=`//sc02.alicdn.com/kf/Hbb5f936a288f4ffeafd26f2a709d8883G.jpg
sc02.alicdn.com/kf/H2f432b7c7a4a4adfb18e2e6a5b2f28a8q.jpg`;
        ta.value=`${s}
${ta.value||''}`.trim();
      });

      // Ê∑ªÂä†ÊµãËØïÊï∞ÊçÆÊåâÈíÆ
      $('#btnAddTestData')?.addEventListener('click',()=>{
        const testData = [
          {img: 'https://sc02.alicdn.com/kf/Hbb5f936a288f4ffeafd26f2a709d8883G.jpg', topic_id: '001', Ê†áÈ¢ò: 'ÊµãËØï‰∫ßÂìÅ1', ÂÆ¢Êà∑ÂêçÂ≠ó: 'ÂÆ¢Êà∑A', Â∫óÈì∫ID: 'SHOP001', ‰∏ÄÁ∫ßË°å‰∏ö: 'ÁîµÂ≠ê‰∫ßÂìÅ', ‰∫åÁ∫ßË°å‰∏ö: 'ÊâãÊú∫', ‰∏âÁ∫ßË°å‰∏ö: 'Êô∫ËÉΩÊâãÊú∫', Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞: '100'},
          {img: 'https://sc02.alicdn.com/kf/H2f432b7c7a4a4adfb18e2e6a5b2f28a8q.jpg', topic_id: '002', Ê†áÈ¢ò: 'ÊµãËØï‰∫ßÂìÅ2', ÂÆ¢Êà∑ÂêçÂ≠ó: 'ÂÆ¢Êà∑B', Â∫óÈì∫ID: 'SHOP002', ‰∏ÄÁ∫ßË°å‰∏ö: 'ÊúçË£Ö', ‰∫åÁ∫ßË°å‰∏ö: 'Áî∑Ë£Ö', ‰∏âÁ∫ßË°å‰∏ö: 'Ë°¨Ë°´', Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞: '50'},
          {img: 'https://sc02.alicdn.com/kf/Hbb5f936a288f4ffeafd26f2a709d8883G.jpg', topic_id: '003', Ê†áÈ¢ò: 'ÊµãËØï‰∫ßÂìÅ3', ÂÆ¢Êà∑ÂêçÂ≠ó: 'ÂÆ¢Êà∑A', Â∫óÈì∫ID: 'SHOP003', ‰∏ÄÁ∫ßË°å‰∏ö: 'ÂÆ∂Â±Ö', ‰∫åÁ∫ßË°å‰∏ö: 'Âé®ÂÖ∑', ‰∏âÁ∫ßË°å‰∏ö: 'ÈîÖÂÖ∑', Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞: '75'},
          {img: 'https://sc02.alicdn.com/kf/H2f432b7c7a4a4adfb18e2e6a5b2f28a8q.jpg', topic_id: '004', Ê†áÈ¢ò: 'ÊµãËØï‰∫ßÂìÅ4', ÂÆ¢Êà∑ÂêçÂ≠ó: 'ÂÆ¢Êà∑C', Â∫óÈì∫ID: 'SHOP004', ‰∏ÄÁ∫ßË°å‰∏ö: 'ÁîµÂ≠ê‰∫ßÂìÅ', ‰∫åÁ∫ßË°å‰∏ö: 'ÁîµËÑë', ‰∏âÁ∫ßË°å‰∏ö: 'Á¨îËÆ∞Êú¨', Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞: '120'},
          {img: 'https://sc02.alicdn.com/kf/Hbb5f936a288f4ffeafd26f2a709d8883G.jpg', topic_id: '005', Ê†áÈ¢ò: 'ÊµãËØï‰∫ßÂìÅ5', ÂÆ¢Êà∑ÂêçÂ≠ó: 'ÂÆ¢Êà∑B', Â∫óÈì∫ID: 'SHOP005', ‰∏ÄÁ∫ßË°å‰∏ö: 'ÊúçË£Ö', ‰∫åÁ∫ßË°å‰∏ö: 'Â•≥Ë£Ö', ‰∏âÁ∫ßË°å‰∏ö: 'ËøûË°£Ë£ô', Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞: '80'}
        ];
        state.items = state.items.concat(testData);
        refreshFilterOptionsCascading(); 
        render();
        alert('Â∑≤Ê∑ªÂä† ' + testData.length + ' Êù°ÊµãËØïÊï∞ÊçÆ');
      });

      $('#btnClear')?.addEventListener('click',()=>{ if(confirm('Ê∏ÖÁ©∫ÁîªÂªäÔºü')){ state.items=[]; refreshFilterOptionsCascading(); render(); } });
      $('#btnClearAll')?.addEventListener('click',()=>{ if(confirm('Ê∏ÖÁ©∫ËæìÂÖ•‰∏éÁîªÂªäÔºü')){ state.items=[]; const ta=$('#urlInput'); if(ta) ta.value=''; refreshFilterOptionsCascading(); render(); } });

      $('#btnImport')?.addEventListener('click', async ()=>{ await openFileDialog(); });
      $('#btnDownloadTemplate')?.addEventListener('click',()=>{
        // ÂàõÂª∫Êï∞ÊçÆÊ®°ÊùøCSVÂÜÖÂÆπ - ÊåâÊñ∞È°∫Â∫èÊéíÂàó
        const templateHeaders = ['topic_id', 'ÂÆ¢Êà∑ÂêçÂ≠ó', 'Â∫óÈì∫ID', 'Ê†áÈ¢ò', 'Á§∫‰æãÂõæÁâáÁ¨¨‰∏Ä‰∏™', '‰∏ÄÁ∫ßË°å‰∏ö', '‰∫åÁ∫ßË°å‰∏ö', '‰∏âÁ∫ßË°å‰∏ö', 'Á¥ØËÆ°ÂÆöÊãõÂìÅÊï∞'];
        const templateData = [
          ['001', 'ÂÆ¢Êà∑A', 'SHOP001', 'Á§∫‰æã‰∫ßÂìÅ1', 'https://example.com/image1.jpg', 'ÁîµÂ≠ê‰∫ßÂìÅ', 'ÊâãÊú∫', 'Êô∫ËÉΩÊâãÊú∫', '100'],
          ['002', 'ÂÆ¢Êà∑B', 'SHOP002', 'Á§∫‰æã‰∫ßÂìÅ2', 'https://example.com/image2.jpg', 'ÊúçË£Ö', 'Áî∑Ë£Ö', 'Ë°¨Ë°´', '50'],
          ['003', 'ÂÆ¢Êà∑A', 'SHOP003', 'Á§∫‰æã‰∫ßÂìÅ3', 'https://example.com/image3.jpg', 'ÂÆ∂Â±Ö', 'Âé®ÂÖ∑', 'ÈîÖÂÖ∑', '75'],
          ['004', 'ÂÆ¢Êà∑C', 'SHOP004', 'Á§∫‰æã‰∫ßÂìÅ4', 'https://example.com/image4.jpg', 'ÁîµÂ≠ê‰∫ßÂìÅ', 'ÁîµËÑë', 'Á¨îËÆ∞Êú¨ÁîµËÑë', '80'],
          ['005', 'ÂÆ¢Êà∑B', 'SHOP005', 'Á§∫‰æã‰∫ßÂìÅ5', 'https://example.com/image5.jpg', 'ÂÆ∂Â±Ö', 'ÂÆ∂ÂÖ∑', 'Ê≤ôÂèë', '30']
        ];
        
        // ÁîüÊàêCSVÂÜÖÂÆπ
        const csvContent = [templateHeaders, ...templateData]
          .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
          .join('\n');
        
        // Ê∑ªÂä†BOM‰ª•ÊîØÊåÅ‰∏≠Êñá
        const bom = '\uFEFF';
        const blob = new Blob([bom + csvContent], {type: 'text/csv;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Êï∞ÊçÆÂØºÂÖ•Ê®°Êùø.csv';
        a.click();
        URL.revokeObjectURL(a.href);
      });
      $('#btnExport')?.addEventListener('click',()=>{
        const links=state.items.map(x=>x.img).filter(Boolean);
        const blob=new Blob([links.join('\n')],{type:'text/plain;charset=utf-8'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='image-links.txt'; a.click(); URL.revokeObjectURL(a.href);
      });

      $('#fit')?.addEventListener('change',(e)=>{ state.fit=e.target.value; applyVars(); });
      $('#size')?.addEventListener('input',(e)=>{ state.size=+e.target.value; applyVars(); });
      $('#gap')?.addEventListener('input',(e)=>{ state.gap=+e.target.value; applyVars(); });
      $('#radius')?.addEventListener('input',(e)=>{ state.radius=+e.target.value; applyVars(); });
      $('#noNetwork')?.addEventListener('change',(e)=>{ state.noNetwork=e.target.checked; safeStorage.set('noNetwork', state.noNetwork?'1':'0'); render(); });
      $('#dragMode')?.addEventListener('change',(e)=>{ state.dragMode=e.target.checked; render(); });

      $('#sel1')?.addEventListener('change',(e)=>{ 
        try {
          state.sel1=e.target.value||''; 
          refreshFilterOptionsCascading(); 
          render(); 
        } catch (error) {
          console.error('‰∏ÄÁ∫ßË°å‰∏öÁ≠õÈÄâÈîôËØØ:', error);
          markHealth(false, '‰∏ÄÁ∫ßË°å‰∏öÁ≠õÈÄâÂ§±Ë¥•');
        }
      });
      $('#sel2')?.addEventListener('change',(e)=>{ 
        try {
          state.sel2=e.target.value||''; 
          refreshFilterOptionsCascading(); 
          render(); 
        } catch (error) {
          console.error('‰∫åÁ∫ßË°å‰∏öÁ≠õÈÄâÈîôËØØ:', error);
          markHealth(false, '‰∫åÁ∫ßË°å‰∏öÁ≠õÈÄâÂ§±Ë¥•');
        }
      });
      $('#sel3')?.addEventListener('change',(e)=>{ 
        try {
          state.sel3=e.target.value||''; 
          render(); 
        } catch (error) {
          console.error('‰∏âÁ∫ßË°å‰∏öÁ≠õÈÄâÈîôËØØ:', error);
          markHealth(false, '‰∏âÁ∫ßË°å‰∏öÁ≠õÈÄâÂ§±Ë¥•');
        }
      });
      $('#selCustomer')?.addEventListener('change',(e)=>{ 
        try {
          state.selCustomer=e.target.value||''; 
          refreshFilterOptionsCascading(); 
          render(); 
        } catch (error) {
          console.error('ÂÆ¢Êà∑Á≠õÈÄâÈîôËØØ:', error);
          markHealth(false, 'ÂÆ¢Êà∑Á≠õÈÄâÂ§±Ë¥•');
        }
      });
      $('#selShop')?.addEventListener('change',(e)=>{ 
        try {
          state.selShop=e.target.value||''; 
          refreshFilterOptionsCascading(); 
          render(); 
        } catch (error) {
          console.error('Â∫óÈì∫Á≠õÈÄâÈîôËØØ:', error);
          markHealth(false, 'Â∫óÈì∫Á≠õÈÄâÂ§±Ë¥•');
        }
      });
      $('#q')?.addEventListener('input',(e)=>{ state.q=e.target.value||''; render(); });

      try{ applyVars(); refreshFilterOptionsCascading(); render(); markHealth(true, 'ËøêË°åÊ≠£Â∏∏'); } catch(err){ markHealth(false, 'ÂàùÂßãÂåñÂ§±Ë¥•'); alert('ÂàùÂßãÂåñÂ§±Ë¥•Ôºö'+(err.message||err)); }

      window.addEventListener('error',(ev)=>{ console.error('[error]', ev.message||ev.error); markHealth(false, 'JSÈîôËØØ'); });
      window.addEventListener('unhandledrejection',(ev)=>{ console.error('[promise]', ev.reason); markHealth(false, 'ÂºÇÊ≠•ÈîôËØØ'); });
    } catch (bootErr) {
      console.error('ÂêØÂä®Â§±Ë¥•', bootErr);
      markHealth(false, 'ÂêØÂä®ÂºÇÂ∏∏');
    }
  })();
  </script>
</body>
</html>
